<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    
    <!-- Content Security Policy - Edge浏览器兼容性修复 -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:; style-src 'self' 'unsafe-inline' https: data:; font-src 'self' https: data: blob:; img-src 'self' https: data: blob:; connect-src 'self' https: data: blob: wss: ws:; frame-src 'self' https: data: blob:;"
    />

    <!-- 1. (核心) 为苹果设备设置主屏幕图标 -->
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/pLBR6xzD/IMG-7239.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="https://i.postimg.cc/pLBR6xzD/IMG-7239.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https://i.postimg.cc/pLBR6xzD/IMG-7239.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="167x167"
      href="https://i.postimg.cc/pLBR6xzD/IMG-7239.png"
    />

    <!-- 2. (核心) 链接到manifest文件 -->
    <link rel="manifest" href="manifest.json" />

    <!-- 3. (核心) 告诉苹果设备，这是一个Web应用，可以全屏显示 -->
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <!-- 4. (核心) 设置苹果设备全屏模式下的状态栏样式 -->
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <!-- 5. (可选) 设置应用在主屏幕上显示的标题 -->
    <meta name="apple-mobile-web-app-title" content="EPhone（兔k机二改 砂砂版）" />

    <!-- 6. (兼容) 为部分安卓浏览器提供支持 -->
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- 7. (备用) 标准浏览器页签图标 -->
    <link
      rel="icon"
      type="image/png"
      href="https://i.postimg.cc/pLBR6xzD/IMG-7239.png"
    />

    <title>EPhone（兔k机二改 砂砂版）</title>

    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script src="https://phoebeboo.github.io/mewoooo/pp.js" defer></script>
    <script src="main-app.js" defer></script>
    <script src="game-hall.js" defer></script>
    <script src="forum.js" defer></script>
    <script src="lovers-space.js" defer></script>
    <script src="taobao.js" defer></script>
    <script src="weibo.js" defer></script>
    <script src="date.js" defer></script>
    <script src="calendar.js" defer></script>
    <script src="studio.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/darkreader@4.9.84/darkreader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="tukey-accounting.js" defer></script>
    <script src="kk-checkin.js" defer></script>
    <script src="task-splitter.js" defer></script>
    <!-- 核心模块 - 按依赖顺序加载 -->
    <script src="app-state.js" defer></script>
    <script src="tarot-data.js" defer></script>
    <script src="script-kill-data.js" defer></script>
    <script src="utils.js" defer></script>
    <script src="api-handlers.js" defer></script>
    <script src="db-persistence.js" defer></script>
    <script src="app-core.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style></style>

    <style id="custom-theme-style"></style>
  </head>
  <body>
    <div id="phone-screen">
      <div id="status-bar">
        <span id="status-bar-time">12:00</span>
        <div id="status-bar-battery" class="battery-container">
          <span class="battery-text">--%</span>
          <div class="battery-icon">
            <div class="battery-level"></div>
          </div>
        </div>
      </div>
      <div id="notification-bar">
        <img id="notification-avatar" src="" />
        <div id="notification-content">
          <div class="name"></div>
          <div class="message"></div>
        </div>
      </div>

      <div id="video-call-floating-bubble" style="display: none">
        <img id="video-floating-avatar" src="" />
      </div>

      <!-- 桌宠元素 -->
      <div id="desktop-pet-container" style="display: none;">
        <div id="desktop-pet-circle">
          <img id="desktop-pet-avatar" src="" alt="桌宠" />
        </div>
      </div>

      <div id="floating-lyrics-bar">
        <span id="floating-lyric-text">♪</span>

        <div
          id="lyrics-settings-btn"
          style="
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
          "
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="3"></circle>
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
            ></path>
          </svg>
        </div>
        <span class="close-btn">×</span>
      </div>

      <div id="lock-screen-background-blur" style="display: none"></div>

      <div id="home-screen" class="screen active">
        <div class="home-screen-slider">
          <!-- 第一页，把原来的内容都放进来 -->
          <div class="home-page">
            <div id="main-content-area">
              <div id="profile-widget">
                <img
                  id="profile-banner-img"
                  src="https://i.postimg.cc/k495F4W5/profile-banner.jpg"
                  class="editable-image"
                />

                <div class="profile-avatar-container">
                  <img
                    id="profile-avatar-img"
                    src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                    class="editable-image"
                  />

                  <img
                    id="profile-avatar-frame"
                    class="weibo-avatar-frame"
                    src=""
                    style="display: none"
                  />
                </div>

                <div class="profile-info">
                  <p id="profile-username" class="editable-text">你的昵称</p>
                  <p id="profile-sub-username" class="editable-text">
                    @your_id
                  </p>
                  <p id="profile-bio" class="editable-text">
                    点击这里编辑你的个性签名
                  </p>
                  <p
                    id="profile-location"
                    class="editable-text"
                    data-placeholder="点击编辑地点"
                  >
                    <svg
                      width="12"
                      height="12"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                    >
                      <path
                        d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"
                      ></path>
                    </svg>
                    <span>点击编辑地点</span>
                  </p>
                </div>
              </div>
              <div id="desktop-layout">
                <div id="desktop-widget-column">
                  <div class="custom-widget-container">
                    <div
                      id="widget-bubble-1"
                      class="widget-bubble editable-text"
                      contenteditable="true"
                    >
                      点击编辑文字
                    </div>
                    <div class="widget-circle-uploader">
                      <img
                        id="widget-image-1"
                        src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                        class="editable-image"
                        title="点击更换图片"
                      />
                    </div>
                    <div
                      id="widget-subtext-1"
                      class="widget-subtext editable-text"
                      contenteditable="true"
                    >
                      点击编辑文字
                    </div>
                  </div>
                  <div class="custom-widget-container">
                    <div
                      id="widget-bubble-2"
                      class="widget-bubble editable-text"
                      contenteditable="true"
                    >
                      点击编辑文字
                    </div>
                    <div class="widget-circle-uploader">
                      <img
                        id="widget-image-2"
                        src="https://i.postimg.cc/k495F4W5/profile-banner.jpg"
                        class="editable-image"
                        title="点击更换图片"
                      />
                    </div>
                    <div
                      id="widget-subtext-2"
                      class="widget-subtext editable-text"
                      contenteditable="true"
                    >
                      点击编辑文字
                    </div>
                  </div>
                </div>
                <div id="desktop-app-container">
                  <div
                    class="desktop-app-icon"
                    onclick="showScreen('chat-list-screen')"
                  >
                    <div class="icon-bg-desktop">
                      <img
                        id="icon-img-qq"
                        src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg"
                        alt="QQ"
                      />
                    </div>
                    <span class="label">QQ</span>
                  </div>
                  <div
                    class="desktop-app-icon"
                    onclick="showScreen('world-book-screen')"
                  >
                    <div class="icon-bg-desktop">
                      <img
                        id="icon-img-world-book"
                        src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg"
                        alt="世界书"
                      />
                    </div>
                    <span class="label">世界书</span>
                  </div>
                  <div id="check-phone-btn" class="desktop-app-icon">
                    <div class="icon-bg-desktop">
                      <img
                        id="icon-img-check-phone"
                        src="https://i.postimg.cc/RVwpwr0r/IMG-8348.jpg"
                        alt="查手机"
                      />
                    </div>
                    <span class="label">查手机</span>
                  </div>
                  <div class="desktop-app-icon" id="weibo-app-icon">
                    <div class="icon-bg-desktop">
                      <img
                        id="icon-img-weibo"
                        src="https://i.postimg.cc/PqBY5wBq/weibo-icon.png"
                        alt="微博"
                      />
                    </div>
                    <span class="label">微博</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 新增的第二页，现在是自定义布局 -->
          <div class="home-page">
            <!-- 左半边的头像小组件 -->
            <div id="second-page-left-widget" class="custom-widget-container">
              <div class="widget-circle-uploader">
                <img
                  id="widget-image-3"
                  src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                  class="editable-image"
                  title="点击更换图片"
                />
              </div>

              <div
                id="second-page-bubble"
                class="widget-bubble editable-text"
                contenteditable="true"
              >
                点击编辑文字
              </div>

              <div id="new-bubbles-container">
                <div
                  id="flat-capsule-bubble"
                  class="widget-bubble editable-text"
                  contenteditable="true"
                >
                  可编辑
                </div>
                <div
                  id="circular-bubble"
                  class="widget-bubble editable-text"
                  contenteditable="true"
                >
                  文字
                </div>
              </div>
            </div>
            <!-- 右上角的两个并排图标 -->
            <div id="second-page-top-right-apps">
              <div
                class="desktop-app-icon"
                onclick="showScreen('forum-screen')"
              >
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-forum"
                    src="https://i.postimg.cc/pr0T3WfC/douban-icon.png"
                    alt="圈子"
                  />
                </div>
                <span class="label">圈子</span>
              </div>
              <div class="desktop-app-icon" id="lovers-space-app-icon">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-lovers-space"
                    src="https://i.postimg.cc/d1wZ39xW/lovers-space-icon.png"
                    alt="情侣空间"
                  />
                </div>
                <span class="label">情侣空间</span>
              </div>

              <div
                id="second-page-x-social-app"
                class="desktop-app-icon"
                onclick="showScreen('x-social-screen')"
              >
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-x-social"
                    src="https://i.postimg.cc/8P1H0vQ8/x-logo.png"
                    alt="X社交"
                  />
                </div>
                <span class="label">X社交</span>
              </div>

              <div id="center-avatar-wrapper">
                <!-- 原来的头像，放在了新容器的中心 -->
                <div
                  id="second-page-center-avatar"
                  class="custom-widget-container"
                >
                  <div class="widget-circle-uploader">
                    <img
                      id="widget-image-4"
                      src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                      class="editable-image"
                      title="点击更换图片"
                    />
                  </div>
                </div>

                <!-- 头像下方的可编辑文字框 -->
                <div id="avatar-subtitle" class="editable-text">
                  点击编辑文字
                </div>

                <!-- 头像四个角的可编辑气泡 -->
                <div class="corner-bubble editable-text" id="bubble-top-left">
                  左上角
                </div>
                <div class="corner-bubble editable-text" id="bubble-top-right">
                  右上角
                </div>
                <div
                  class="corner-bubble editable-text"
                  id="bubble-bottom-left"
                >
                  左下角
                </div>
                <div
                  class="corner-bubble editable-text"
                  id="bubble-bottom-right"
                >
                  右下角
                </div>
              </div>

              <div style="position: absolute; top: 100px; right: 85px">
                <div
                  class="desktop-app-icon"
                  onclick="showScreen('game-hall-screen')"
                >
                  <div class="icon-bg-desktop">
                    <img
                      id="icon-img-game-hall"
                      src="https://i.postimg.cc/P5gL5z2g/game-controller-icon.png"
                      alt="游戏大厅"
                    />
                  </div>
                  <span class="label">游戏大厅</span>
                </div>
              </div>
            </div>

            <div id="new-custom-widget">
              <!-- 用一个新的容器把月份和头像包起来 -->
              <div id="new-widget-header">
                <!-- 加上了 contenteditable 和 class，现在可以随便改它了，写数字、文字都可以 -->
                <div
                  id="widget-month-display"
                  class="editable-text"
                  contenteditable="true"
                >
                  12
                </div>

                <img
                  id="new-widget-avatar"
                  src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                  class="editable-image"
                />
              </div>
              <div
                id="new-widget-text-1"
                class="new-widget-text editable-text"
                contenteditable="true"
              >
                可编辑文字
              </div>
              <div class="new-widget-divider"></div>
              <div
                id="new-widget-text-2"
                class="new-widget-text editable-text"
                contenteditable="true"
              >
                可编辑文字
              </div>
              <div class="new-widget-divider"></div>
              <div
                id="new-widget-text-3"
                class="new-widget-text editable-text"
                contenteditable="true"
              >
                可编辑文字
              </div>
            </div>
            <div style="position: absolute; bottom: 105px; left: 35px">
              <div class="desktop-app-icon" id="taobao-app-icon">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-taobao"
                    src="https://i.postimg.cc/k47tXg1j/taologo.png"
                    alt="桃宝"
                  />
                </div>
                <span
                  class="label"
                  style="
                    color: white;
                    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                  "
                  >桃宝</span
                >
              </div>
            </div>
            <div style="position: absolute; bottom: 105px; left: 120px">
              <div class="desktop-app-icon" id="date-a-live-app-icon">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-date-a-live"
                    src="https://i.postimg.cc/W36mYgP5/DAL-icon.jpg"
                    alt="约会大作战"
                  />
                </div>
                <span
                  class="label"
                  style="
                    color: white;
                    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                  "
                  >约会大作战</span
                >
              </div>
            </div>
            <div style="position: absolute; bottom: 15px; left: 120px">
              <div class="desktop-app-icon" id="kk-checkin-app-icon">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-kk-checkin"
                    src="https://i.postimg.cc/MGwrL0nf/kitty.png"
                    alt="kk查岗"
                  />
                </div>
                <span
                  class="label"
                  style="
                    color: white;
                    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                  "
                  >kk查岗</span
                >
              </div>
            </div>
            <div style="position: absolute; bottom: 15px; left: 35px">
              <div class="desktop-app-icon" id="tukey-accounting-app-icon">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-tukey-accounting"
                    src="https://i.postimg.cc/k4fZKVXP/tu-tu.png"
                    alt="兔兔记账"
                  />
                </div>
                <span
                  class="label"
                  style="
                    color: white;
                    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                  "
                  >兔兔记账</span
                >
              </div>
            </div>
          </div>

          <!-- 第三页：日历app和拆分机app -->
          <div class="home-page">
            <div style="position: absolute; top: 200px; left: 50%; transform: translateX(-50%);">
              <div class="desktop-app-icon" id="calendar-app-icon" onclick="showScreen('calendar-screen')">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-calendar"
                    src="https://i.postimg.cc/pr0T3WfC/douban-icon.png"
                    alt="日历"
                  />
                </div>
                <span class="label">日历</span>
              </div>
            </div>
            <div style="position: absolute; top: 350px; left: 50%; transform: translateX(-50%);">
              <div class="desktop-app-icon" id="task-splitter-app-icon" onclick="openTaskSplitter()">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-task-splitter"
                    src="https://i.postimg.cc/pr0T3WfC/douban-icon.png"
                    alt="白狗拆分机"
                  />
                </div>
                <span class="label">白狗拆分机</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 底部 Dock 栏保持不变 -->
        <div id="desktop-dock">
          <div
            class="desktop-app-icon"
            onclick="showScreen('api-settings-screen')"
          >
            <div class="icon-bg-desktop">
              <img
                id="icon-img-api-settings"
                src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg"
                alt="API设置"
              />
            </div>
            <span class="label">API设置</span>
          </div>

          <div class="desktop-app-icon" id="studio-app-icon">
            <div class="icon-bg-desktop">
              <!-- 这里的 id="icon-img-studio" 必须保留，用于JS识别更换图标 -->
              <img
                id="icon-img-studio"
                src="https://i.postimg.cc/W3sLz11s/clapperboard-icon.png"
                alt="小剧场"
              />
            </div>
            <!-- lrq小剧场 -->
            <span class="label">lrq小剧场</span>
          </div>

          <div
            class="desktop-app-icon"
            onclick="showScreen('font-settings-screen')"
          >
            <div class="icon-bg-desktop">
              <img
                id="icon-img-font"
                src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg"
                alt="字体"
              />
            </div>
            <span class="label">字体</span>
          </div>
          <div
            class="desktop-app-icon"
            onclick="showScreen('wallpaper-screen')"
          >
            <div class="icon-bg-desktop">
              <img
                id="icon-img-wallpaper"
                src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg"
                alt="外观设置"
              />
            </div>
            <span class="label">外观设置</span>
          </div>
        </div>

        <!-- 小圆点 -->
        <div class="pagination-dots">
          <span class="dot active"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
      </div>

      <div id="weibo-screen" class="screen">
        <!-- 这个容器将存放微博的所有页面 -->
        <div id="weibo-page-container">
          <!-- 页面1: 我的主页 (已改造) -->
          <div id="weibo-my-profile-view" class="weibo-view active">
            <!-- 头部  -->
            <div class="header">
              <span class="back-btn" onclick="showScreen('home-screen')">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>我的主页</span>
              <div class="header-actions">
                <!-- 新的私信按钮 -->
                <span class="action-btn" id="weibo-my-dms-btn" title="我的私信">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                    ></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                  </svg>
                </span>

                <!-- 新增“编辑”按钮 -->
                <span
                  class="action-btn"
                  id="edit-weibo-profile-btn"
                  title="编辑资料"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M12 20h9"></path>
                    <path
                      d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                    ></path>
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="create-weibo-post-btn"
                  style="font-size: 28px; font-weight: 300"
                  >+</span
                >
              </div>
            </div>
            <!-- 主页内容区 -->
            <div id="weibo-profile-page">
              <div class="weibo-profile-header">
                <img
                  id="weibo-background-img"
                  src="https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg"
                  class="weibo-background"
                />

                <div class="weibo-avatar-container">
                  <img
                    id="weibo-avatar-img"
                    src="https://files.catbox.moe/q6z5fc.jpeg"
                    class="weibo-avatar"
                  />

                  <img
                    id="weibo-avatar-frame"
                    class="weibo-avatar-frame"
                    src=""
                    style="display: none"
                  />
                </div>

                <div class="weibo-nickname" id="weibo-nickname">你的昵称</div>

                <div id="weibo-user-profession-display">点击设置职业</div>

                <div class="weibo-stats">
                  <div id="weibo-following-btn" class="weibo-stat-item">
                    <span id="weibo-following-count" class="weibo-stat-number"
                      >0</span
                    >
                    <span class="weibo-stat-label">关注</span>
                  </div>
                  <div id="weibo-posts-item" class="weibo-stat-item">
                    <span id="weibo-posts-count" class="weibo-stat-number"
                      >0</span
                    >
                    <span class="weibo-stat-label">微博</span>
                  </div>
                  <div id="weibo-fans-item" class="weibo-stat-item">
                    <span id="weibo-fans-count" class="weibo-stat-number"
                      >0</span
                    >
                    <span class="weibo-stat-label">粉丝</span>
                  </div>
                </div>
              </div>
              <div
                id="my-weibo-feed-list"
                style="
                  padding: 15px;
                  display: flex;
                  flex-direction: column;
                  gap: 15px;
                "
              ></div>
            </div>
          </div>

          <!-- 页面2: 关注的人 (保持不变) -->
          <div id="weibo-following-view" class="weibo-view">
            <div class="header">
              <span class="back-btn" onclick="showScreen('home-screen')">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>关注的人</span>
              <span
                class="action-btn"
                id="clear-following-feed-btn"
                style="font-size: 16px; font-weight: 500"
                >清空</span
              >
            </div>
            <div
              id="weibo-following-feed-list"
              style="
                flex-grow: 1;
                overflow-y: auto;
                padding: 15px;
                display: flex;
                flex-direction: column;
                gap: 15px;
              "
            >
              <!-- 关注的人的微博列表将由JS动态生成在这里 -->
            </div>
          </div>

          <!-- 页面3: 热搜 (保持不变) -->
          <div id="weibo-hot-search-view" class="weibo-view">
            <div class="header">
              <span class="back-btn" onclick="showScreen('home-screen')">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>热搜</span>
              <div class="header-actions">
                <span
                  class="action-btn"
                  id="generate-hot-search-btn"
                  title="生成热搜"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  </svg>
                </span>
              </div>
            </div>
            <div
              id="weibo-hot-search-list"
              style="flex-grow: 1; overflow-y: auto"
            >
              <p style="text-align: center; color: #8a8a8a; margin-top: 50px">
                点击右上角放大镜生成热搜
              </p>
            </div>
          </div>

          <!-- 页面4: 广场 (保持不变) -->
          <div id="weibo-plaza-view" class="weibo-view">
            <div class="header">
              <span class="back-btn" onclick="showScreen('home-screen')">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>广场</span>
              <div class="header-actions">
                <span
                  class="action-btn"
                  id="generate-plaza-feed-btn"
                  title="生成广场动态"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  </svg>
                </span>
              </div>
            </div>
            <div
              id="weibo-plaza-feed-list"
              style="flex-grow: 1; overflow-y: auto; padding: 0"
            >
              <p style="text-align: center; color: #8a8a8a; margin-top: 50px">
                点击右上角放大镜生成广场动态
              </p>
            </div>
          </div>

          <!-- 页面5: 热搜详情页 (保持不变) -->
          <div id="weibo-hottopic-feed-view" class="weibo-view">
            <div class="header">
              <span class="back-btn" id="back-from-hottopic-btn">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span id="weibo-hottopic-title">热搜话题</span>
              <div class="header-actions">
                <span
                  class="action-btn"
                  id="refresh-hottopic-feed-btn"
                  title="换一批"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                  </svg>
                </span>
              </div>
            </div>
            <div
              id="weibo-hottopic-feed-list"
              style="flex-grow: 1; overflow-y: auto; padding: 0"
            >
              <!-- 热搜微博列表将由JS动态生成 -->
            </div>
          </div>
        </div>

        <!-- 底部导航栏 -->
        <div id="weibo-bottom-nav">
          <div class="weibo-nav-item" data-view="weibo-hot-search-view">
            热搜
          </div>
          <div class="weibo-nav-item" data-view="weibo-plaza-view">广场</div>
          <div class="weibo-nav-item" data-view="weibo-following-view">
            关注的人
          </div>
          <div class="weibo-nav-item active" data-view="weibo-my-profile-view">
            我的微博
          </div>
        </div>
      </div>

      <div id="world-book-screen" class="screen">
        <div class="header">
          <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
          <span>世界书</span>
          <div class="header-actions">
            <span
              class="action-btn"
              id="import-world-book-btn"
              title="导入世界书"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </span>

            <span
              class="action-btn"
              id="manage-categories-in-edit-mode-btn"
              style="display: none"
              title="管理分类"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                ></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
            </span>

            <span
              class="action-btn btn-danger"
              id="world-book-delete-selected-btn"
              style="display: none"
              title="删除已选"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="3 6 5 6 21 6"></polyline>
                <path
                  d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                ></path>
              </svg>
              <span
                id="world-book-delete-count"
                style="font-size: 12px; margin-left: 2px"
              ></span>
              <!-- 用于显示数量 -->
            </span>

            <span class="action-btn" id="toggle-world-book-edit-mode-btn"
              >编辑模式</span
            >

            <span class="action-btn" id="add-world-book-btn">+</span>
          </div>
        </div>
        <div id="world-book-list"></div>
      </div>

      <div id="world-book-editor-screen" class="screen">
        <div class="header">
          <span class="back-btn" onclick="showScreen('world-book-screen')"
            >‹</span
          >
          <span id="world-book-editor-title">编辑世界书</span>
          <span class="save-btn" id="save-world-book-btn">保存</span>
        </div>
        <div class="form-container">
          <div class="form-group">
            <label for="world-book-name-input">书名</label>
            <input
              type="text"
              id="world-book-name-input"
              placeholder="请输入世界书的名称..."
            />
          </div>

          <div class="form-group">
            <label for="world-book-category-select">分类</label>
            <select id="world-book-category-select">
              <!-- 选项将由JS动态生成 -->
            </select>
          </div>

          <div class="form-group">
            <label for="world-book-type-select">属性</label>
            <select id="world-book-type-select" class="moe-input">
              <option value="">普通（默认）</option>
              <option value="html">HTML（HTML内容模板，仅在私聊中使用）</option>
              <option value="破限">破限</option>
              <option value="人物背景">人物背景</option>
            </select>
            <small style="color: #888; font-size: 12px; display: block; margin-top: 4px;">
              选择世界书条目的属性。HTML属性的条目会保持HTML格式，且仅在AI角色私聊中使用生成。
            </small>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input
                type="checkbox"
                id="world-book-is-global-checkbox"
                style="width: 18px; height: 18px; cursor: pointer;"
              />
              <span>全局世界书（所有角色默认加载）</span>
            </label>
            <small style="color: #888; font-size: 12px; display: block; margin-top: 4px;">
              开启后，此世界书会自动加载到所有角色，无需单独绑定。
            </small>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input
                type="checkbox"
                id="world-book-is-required-checkbox"
                style="width: 18px; height: 18px; cursor: pointer;"
              />
              <span>必读（始终加载）</span>
            </label>
            <small style="color: #888; font-size: 12px; display: block; margin-top: 4px;">
              开启后，此世界书会始终加载，不受关键词限制。
            </small>
          </div>

          <div class="form-group">
            <label for="world-book-priority-select">读取优先级</label>
            <select
              id="world-book-priority-select"
              class="moe-input"
            >
              <option value="breakLimit">破限（最高优先级，必定第一个阅读，比高优先级还高）</option>
              <option value="high">高（最高优先级，最先读取）</option>
              <option value="medium">中（比人设高，在读取人设前读取）</option>
              <option value="low">低（最低优先级，在读取人设后读取）</option>
            </select>
            <small id="world-book-priority-hint" style="color: #888; font-size: 12px; display: block; margin-top: 4px;">
              控制世界书的读取顺序。高优先级最先读取，中优先级在读取人设前读取，低优先级在读取人设后读取。
            </small>
          </div>

          <div class="form-group">
            <label for="world-book-trigger-keywords-input">触发关键词 (选填)</label>
            <input
              type="text"
              id="world-book-trigger-keywords-input"
              placeholder="用英文逗号分隔，例如：魔法,magic,法术"
            />
            <small style="color: #888; font-size: 12px; display: block; margin-top: 4px;">
              填写关键词后，只有当对话中包含这些关键词时才会加载（必读世界书不受此限制）。
            </small>
          </div>

          <div class="form-group" style="height: 100%">
            <label for="world-book-content-input">内容</label>
            <textarea
              id="world-book-content-input"
              placeholder="在此处输入详细的世界观设定..."
            ></textarea>
          </div>
        </div>
      </div>

      <div id="api-settings-screen" class="screen moe-theme">
        <div class="header">
          <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
          <span> API设置 </span>
          <span style="width: 30px"></span>
        </div>

        <!-- 内容滚动区域 -->
        <div class="form-container">
          <!-- 1. 云端大脑卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">☁️</span>
              <h3>API 连接</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label>反代地址 (Proxy)</label>
                <input
                  type="text"
                  id="proxy-url"
                  placeholder="https://api.openai.com"
                  class="moe-input"
                />
              </div>
              <div class="form-group">
                <label>密钥 (Key)</label>
                <input
                  type="password"
                  id="api-key"
                  placeholder="sk-..."
                  class="moe-input"
                />
              </div>
              <div class="form-group">
                <label>模型选择 (手动输入 或 拉取后选择)</label>
                <!-- 1. 这里的 id="model-select" 是真正的输入框，保存时只看它的值 -->
                <input type="text" id="model-select" class="moe-input" placeholder="如 gpt-4o, claude-3-5-sonnet">
                <select id="fetched-model-list" class="moe-input" style="margin-top: 5px; display: none; border: 1px dashed var(--accent-color);" onchange="document.getElementById('model-select').value = this.value">
                  <option value="">▼ 点击此处选择已拉取的模型</option>
                </select>
              </div>                         
              <div class="form-group">
                <label>预设配置</label>
                <div class="bubble-preset-manager">
                  <select id="api-preset-select" class="moe-input"></select>
                  <button id="manage-api-presets-btn" class="moe-btn-small">
                    管理
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label
                  >温度 (随机性):
                  <span
                    id="temperature-value"
                    style="color: var(--accent-color)"
                    >0.8</span
                  ></label
                >
                <input
                  type="range"
                  id="temperature-slider"
                  min="0"
                  max="2"
                  step="0.1"
                  value="0.8"
                  class="moe-slider"
                />
              </div>
              <button id="fetch-models-btn" class="moe-btn-secondary">
                📡 拉取模型列表
              </button>
            </div>
          </div>

          <!-- 2. 语音合成卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">🗣️</span>
              <h3>Minimax 语音</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label>Group ID</label>
                <input type="text" id="minimax-group-id" class="moe-input" />
              </div>
              <div class="form-group">
                <label>API Key</label>
                <input type="password" id="minimax-api-key" class="moe-input" />
              </div>
              <div class="form-group">
                <label>服务区域</label>
                <select id="minimax-provider-select" class="moe-input">
                  <option value="cn">国内版</option>
                  <option value="io">海外版</option>
                </select>
              </div>
              <div class="form-group">
                <label>语音模型</label>
                <select
                  id="minimax-speech-model-select"
                  class="moe-input"
                ></select>
              </div>
              <button
                id="fetch-minimax-speech-models-btn"
                class="moe-btn-secondary"
              >
                🎵 拉取语音模型
              </button>
            </div>
          </div>

          <!-- 3. 后台活动卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">🤖</span>
              <h3>角色后台活动</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label class="toggle-switch-label">
                  <span class="toggle-switch-text">启用后台活动</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="background-activity-switch" />
                    <span class="slider"></span>
                  </label>
                </label>
              </div>
              <div
                id="background-activity-details"
                style="display: none; margin-top: 10px"
              >
                <div class="form-group">
                  <label>检测间隔 (秒)</label>
                  <input
                    type="number"
                    id="background-interval-input"
                    min="30"
                    value="60"
                    class="moe-input center-text"
                  />
                </div>
                <div class="form-group">
                  <label>角色频率设置</label>
                  <div
                    id="background-activity-char-list"
                    class="moe-list-box"
                  ></div>
                  <div class="moe-btn-group">
                    <button id="bg-select-all-chars" class="moe-btn-mini">
                      全选
                    </button>
                    <button id="bg-deselect-all-chars" class="moe-btn-mini">
                      全不选
                    </button>
                  </div>
                </div>
                <div class="form-group">
                  <label>设置频率</label>
                  <div class="moe-btn-group">
                    <button class="moe-btn-mini bg-freq-btn" data-freq="low">
                      低
                    </button>
                    <button class="moe-btn-mini bg-freq-btn" data-freq="medium">
                      中
                    </button>
                    <button class="moe-btn-mini bg-freq-btn" data-freq="high">
                      高
                    </button>
                    <button class="moe-btn-mini bg-freq-btn" data-freq="none">
                      关闭
                    </button>
                  </div>
                </div>
              </div>
              <div class="moe-divider"></div>
              <div class="form-group">
                <label>拉黑冷静期 (小时)</label>
                <input
                  type="number"
                  id="block-cooldown-input"
                  min="0.1"
                  step="0.1"
                  value="1"
                  class="moe-input center-text"
                />
              </div>
            </div>
          </div>

          <!-- 4. 强力保活卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">⚡</span>
              <h3>强力保活</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label class="toggle-switch-label">
                  <span class="toggle-switch-text">启用强力保活</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="keep-alive-switch" />
                    <span class="slider"></span>
                  </label>
                </label>
                <p style="color: #666; font-size: 12px; margin-top: 10px;">
                  💡 开启后，网站将在后台保持活动状态，AI可以继续回应和输出，即使应用被挂到后台也能正常工作。
                </p>
                <div id="ios-keepalive-notice" style="display: none; margin-top: 10px; padding: 10px; border-radius: 8px; background: #fff3cd; border-left: 4px solid #ffa94d;">
                  <strong style="color: #856404;">⚠️ iOS设备提示：</strong>
                  <p style="color: #856404; font-size: 12px; margin: 5px 0 0 0;">
                    为了在iOS上使用保活功能，请将网站添加到主屏幕：<br>
                    1. 点击Safari底部的分享按钮<br>
                    2. 选择"添加到主屏幕"<br>
                    3. 从主屏幕打开应用后，保活功能将自动启用
                  </p>
                </div>
              </div>
              <div
                id="keep-alive-details"
                style="display: none; margin-top: 10px"
              >
                <div class="form-group">
                  <label>保活状态</label>
                  <div id="keep-alive-status" style="padding: 10px; border-radius: 8px; background: #f0f0f0; margin-top: 5px;">
                    <strong>Wake Lock：</strong><span id="wake-lock-status-text">检查中...</span><br>
                    <strong>页面状态：</strong><span id="page-visibility-status-text">检查中...</span><br>
                    <strong>心跳间隔：</strong><span id="heartbeat-interval-text">30秒</span>
                  </div>
                </div>
                <div class="form-group">
                  <label>心跳间隔 (秒)</label>
                  <input
                    type="number"
                    id="heartbeat-interval-input"
                    min="10"
                    max="300"
                    value="30"
                    class="moe-input center-text"
                  />
                  <p style="color: #888; font-size: 11px; margin-top: 5px;">
                    定期发送心跳保持连接活跃（建议10-60秒）
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- 5. 浏览器通知权限卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">🔔</span>
              <h3>浏览器通知</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                  ✅ <strong>后台通知已启用</strong><br>
                  启用浏览器原生通知后，即使网站关闭或切换到后台，也能收到消息提醒（支持 Android、iOS、PC）<br>
                  <span style="color: #888; font-size: 12px;">
                    💡 提示：添加到主屏幕后，通知功能会更稳定
                  </span>
                </p>
                <div id="notification-permission-status" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; background: #f0f0f0;">
                  <strong>当前状态：</strong>
                  <span id="notification-status-text">检查中...</span>
                </div>
                <div id="service-worker-status" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; background: #f0f0f0; display: none;">
                  <strong>Service Worker：</strong>
                  <span id="service-worker-status-text">检查中...</span>
                </div>
                <button id="request-notification-permission-btn" class="moe-btn-secondary" style="width: 100%;">
                  🔔 请求通知权限
                </button>
                <button id="test-notification-btn" class="moe-btn-secondary" style="width: 100%; margin-top: 10px;">
                  🧪 测试通知（立即显示）
                </button>
                <button id="test-background-notification-btn" class="moe-btn-secondary" style="width: 100%; margin-top: 10px;">
                  🔄 测试后台通知（5秒后发送）
                </button>
              </div>
            </div>
          </div>

          <!-- 6. 图像生成卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">🎨</span>
              <h3>NovelAI 生图</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label class="toggle-switch-label">
                  <span class="toggle-switch-text">启用图像生成</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="novelai-switch" />
                    <span class="slider"></span>
                  </label>
                </label>
              </div>
              <div id="novelai-details" style="display: none; margin-top: 10px">
                <div class="form-group">
                  <label>模型</label>
                  <select id="novelai-model" class="moe-input">
                    <option value="nai-diffusion-4-curated-preview">
                      V4.5 Curated
                    </option>
                    <option value="nai-diffusion-4-5-full">V4.5 Full</option>
                    <option value="nai-diffusion-3">V3 Anime</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>API Key</label>
                  <div style="position: relative">
                    <input
                      type="password"
                      id="novelai-api-key"
                      class="moe-input"
                    />
                    <span
                      id="novelai-key-toggle"
                      style="
                        position: absolute;
                        right: 10px;
                        top: 10px;
                        cursor: pointer;
                      "
                      >👀</span
                    >
                  </div>
                </div>
                <div class="moe-btn-group">
                  <button
                    type="button"
                    id="novelai-settings-btn"
                    class="moe-btn-secondary"
                  >
                    设置
                  </button>
                  <button
                    type="button"
                    id="novelai-test-btn"
                    class="moe-btn-secondary"
                  >
                    测试
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 6.5. Pollinations 图像生成卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">🌸</span>
              <h3>Pollinations 生图</h3>
            </div>
            <div class="moe-card-body">
              <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                Pollinations 是免费的图像生成服务，用于约会、商城等场景。填入 API Key 可获得更稳定的服务和更高质量的生成效果。
              </p>
              <div class="form-group">
                <label>API Key (可选)</label>
                <div style="position: relative">
                  <input
                    type="password"
                    id="pollinations-api-key"
                    class="moe-input"
                    placeholder="留空则使用免费公共服务"
                  />
                  <span
                    id="pollinations-key-toggle"
                    style="
                      position: absolute;
                      right: 10px;
                      top: 10px;
                      cursor: pointer;
                    "
                    >👀</span
                  >
                </div>
              </div>
              <button
                type="button"
                id="pollinations-test-btn"
                class="moe-btn-secondary"
              >
                🧪 测试生图
              </button>
            </div>
          </div>

          <!-- 7. 存储与备份卡片 -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">💾</span>
              <h3>存储与备份</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label
                  >图片压缩质量:
                  <span id="image-quality-value">0.7</span></label
                >
                <input
                  type="range"
                  id="image-quality-slider"
                  min="0.1"
                  max="1.0"
                  step="0.1"
                  value="0.7"
                  class="moe-slider"
                />
              </div>
              <button class="moe-btn-secondary" id="compress-all-images-btn">
                📉 一键压缩图片
              </button>
              <p
                id="image-data-size-display"
                style="
                  text-align: center;
                  font-size: 12px;
                  color: #aaa;
                  margin-top: 5px;
                "
              >
                ...
              </p>

              <div class="moe-divider"></div>

              <h4
                style="
                  font-size: 14px;
                  margin-bottom: 10px;
                  color: var(--accent-color);
                "
              >
                ☁️ GitHub 云备份
              </h4>
              <div class="form-group">
                <input
                  type="password"
                  id="github-token"
                  placeholder="Token"
                  class="moe-input"
                  style="margin-bottom: 5px"
                />
                <input
                  type="text"
                  id="github-username"
                  placeholder="用户名"
                  class="moe-input"
                  style="margin-bottom: 5px"
                />
                <input
                  type="text"
                  id="github-repo"
                  placeholder="仓库名"
                  class="moe-input"
                  style="margin-bottom: 5px"
                />
                <input
                  type="text"
                  id="github-path"
                  placeholder="路径 (可选)"
                  class="moe-input"
                />
              </div>
              <div class="form-group">
                <label class="toggle-switch-label">
                  <span class="toggle-switch-text">自动备份 </span>
                  <input type="checkbox" id="github-auto-backup-switch" />
                  <span class="toggle-switch-slider"></span>
                </label>
              </div>
              <!-- 在 github-path 输入框下方插入 -->
              <div class="form-group" style="margin-top: 5px">
                <label>自动备份模式</label>
                <div style="display: flex; gap: 10px">
                  <select
                    id="github-backup-mode"
                    class="moe-input"
                    style="flex: 1"
                  >
                    <option value="full">全量</option>
                    <option value="stream">流式 (分片/稳定)</option>
                  </select>
                  <input
                    type="number"
                    id="github-backup-interval"
                    class="moe-input"
                    style="width: 80px"
                    placeholder="分钟"
                    value="30"
                    min="5"
                  />
                  <span style="align-self: center; font-size: 12px; color: #888"
                    >分钟</span
                  >
                </div>
              </div>

              <div class="moe-btn-group">
                <button id="manual-github-backup-btn" class="moe-btn-secondary">
                  ☁️ 上传 (全量)
                </button>
                <button
                  id="manual-github-restore-btn"
                  class="moe-btn-secondary"
                >
                  📥 恢复 (全量)
                </button>
              </div>
              <div class="moe-btn-group" style="margin-top: 10px">
                <button
                  id="git-stream-upload-btn"
                  class="moe-btn-secondary"
                  style="background-color: #6f42c1; color: white"
                >
                  🌊 Git流式上传
                </button>
                <button
                  id="git-stream-restore-btn"
                  class="moe-btn-secondary"
                  style="background-color: #6f42c1; color: white"
                >
                  🎣 Git流式导入
                </button>
              </div>
              <p style="font-size: 12px; color: #999; margin-top: 5px">
                *
                流式模式会将数据拆分为多个文件(按表)上传，解决大文件导致崩溃的问题。
              </p>

              <div class="moe-divider"></div>

              <h4
                style="
                  font-size: 14px;
                  margin-bottom: 10px;
                  color: var(--accent-color);
                "
              >
                🛡️ 浏览器持久化保护
              </h4>
              <div id="persistence-status-container" style="margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span id="persistence-status-icon" style="font-size: 20px;">⏳</span>
                  <span id="persistence-status-text" style="font-size: 13px; color: #666;">检测中...</span>
                </div>
                <div id="storage-usage-bar" style="background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 5px;">
                  <div id="storage-usage-fill" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <p id="storage-usage-text" style="font-size: 11px; color: #888; text-align: center; margin: 0;">存储使用: --</p>
              </div>
              <div class="moe-btn-group">
                <button class="moe-btn-secondary" id="request-persistence-btn" style="flex: 1;">
                  🔒 请求持久化
                </button>
                <button class="moe-btn-secondary" id="check-data-integrity-btn" style="flex: 1;">
                  🔍 检查数据
                </button>
              </div>
              <p style="font-size: 11px; color: #999; margin-top: 8px; line-height: 1.5;">
                持久化存储可防止浏览器在存储空间不足时自动清理您的数据。建议定期备份数据到本地或云端。
              </p>

              <div class="moe-divider"></div>

              <h4
                style="
                  font-size: 14px;
                  margin-bottom: 10px;
                  color: var(--accent-color);
                "
              >
                📦 本地备份
              </h4>
              <div class="moe-btn-group">
                <button class="moe-btn-secondary" id="export-data-btn">
                  导出
                </button>
                <button class="moe-btn-secondary" id="import-btn">导入</button>
                <button class="moe-btn-secondary" id="export-data-stream-btn">
                  流式导出
                </button>
              </div>
              <button
                class="moe-btn-secondary"
                id="advanced-transfer-btn"
                style="margin-top: 8px; width: 100%"
              >
                高级导入/导出
              </button>

              <div class="moe-divider"></div>
              <button class="moe-btn-danger" id="clear-orphaned-data-btn">
                🧹 清理失效数据
              </button>
              <div class="moe-divider"></div>
              <button
                class="moe-btn-secondary"
                id="repair-data-btn"
                style="
                  background-color: #ff9800;
                  color: white;
                  margin-bottom: 10px;
                  width: 100%;
                  font-weight: bold;
                "
              >
                🔧 一键修复 (修复数据结构错误)
              </button>
              <button
                class="moe-btn-danger"
                id="factory-reset-btn"
                style="
                  background-color: #c82333;
                  margin-top: 10px;
                  width: 100%;
                  font-weight: bold;
                "
              >
                🧨 初始化 (清空全部数据)
              </button>
            </div>
          </div>

          <div style="text-align: center; margin-bottom: 15px; margin-top: 5px">
            <a
              href="https://jcny642xl7ll.feishu.cn/wiki/KGsnwECKji2xdxkCqDbcZNOnndd"
              target="_blank"
              style="
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 10px 20px;
                background-color: rgba(255, 255, 255, 0.9);
                color: var(--accent-color, #007bff);
                text-decoration: none;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: 1px solid rgba(0, 0, 0, 0.05);
                transition: transform 0.2s;
              "
            >
              <span>📖</span> 兔k写的一些教程
            </a>
          </div>

          <!-- 底部留白，防止被悬浮按钮遮挡 -->
          <div style="height: 80px"></div>
        </div>

        <!-- ★★★ 萌系悬浮保存按钮 ★★★ -->
        <button id="save-api-settings-btn" class="moe-fab-save">
          💾<span style="font-size: 12px; display: block; margin-top: -2px"
            >保存</span
          >
        </button>

        <!-- 隐藏的 input -->
        <input
          id="import-data-input"
          type="file"
          accept="application/json"
          hidden
        />
      </div>

      <div id="chat-list-screen" class="screen">
        <!-- 主头部 (只在消息列表显示) -->
        <div class="header" id="main-chat-list-header">
          <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
          <span id="chat-list-title">消息</span>
          <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title="创建群聊">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M21 21L19 19"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>

            <span
              class="action-btn"
              id="import-character-card-btn"
              title="导入角色卡"
            >
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </span>

            <span class="action-btn" id="add-chat-btn">+</span>
          </div>
        </div>

        <!-- 消息列表视图 -->
        <div id="messages-view" class="chat-list-view active">
          <div id="chat-list">
            <!-- JS会在这里生成聊天列表 -->
          </div>
        </div>

        <!-- 动态界面视图 -->
        <div id="qzone-screen" class="chat-list-view">
          <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn">‹</span>
            <!-- 这个按钮现在只负责从动态返回 -->
            <span>好友动态</span>

            <div class="header-actions">
              <span
                class="action-btn"
                id="clear-qzone-posts-btn"
                title="清空动态"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                  />
                </svg>
              </span>
            </div>
          </div>
          <div class="qzone-content">
            <div class="qzone-profile-header">
              <div id="qzone-banner-container" class="qzone-banner-container">
                <img
                  id="qzone-banner-img"
                  src="https://files.catbox.moe/r5heyt.gif"
                  alt="背景"
                />
                <input
                  type="file"
                  id="qzone-banner-input"
                  accept="image/*"
                  hidden
                />
              </div>
              <div class="qzone-user-info">
                <div id="qzone-avatar-container" class="qzone-avatar-container">
                  <img
                    id="qzone-avatar-img"
                    src="https://files.catbox.moe/q6z5fc.jpeg"
                    alt="头像"
                  />
                  <input
                    type="file"
                    id="qzone-avatar-input"
                    accept="image/*"
                    hidden
                  />
                </div>
                <span id="qzone-nickname">{{user}}</span>
              </div>
            </div>
            <div class="qzone-actions-bar">
              <div class="action-item" id="create-shuoshuo-btn">
                <span>说说</span>
              </div>
              <div class="action-item" id="create-post-btn">
                <span>动态</span>
              </div>
              <div class="action-item" id="open-album-btn">
                <span>相册</span>
              </div>
            </div>
            <div id="qzone-posts-list"></div>
          </div>
        </div>

        <!-- 收藏界面视图 -->
        <div id="favorites-view" class="chat-list-view">
          <div class="header">
            <span class="back-btn" id="favorites-back-btn">‹</span>
            <span>我的收藏</span>
            <!-- 新增的编辑按钮 -->
            <span class="action-btn" id="favorites-edit-btn">编辑</span>
          </div>

          <!-- 搜索栏容器 -->
          <div class="search-bar-container">
            <input
              type="search"
              id="favorites-search-input"
              placeholder="搜索收藏的标题、内容或作者..."
            />
            <button
              id="favorites-search-clear-btn"
              class="search-clear-btn"
              style="display: none"
            >
              ×
            </button>
          </div>

          <div id="favorites-list" class="list-container">
            <!-- 收藏内容将由JS动态生成在这里 -->
          </div>

          <!-- 新增：收藏页底部操作栏 -->
          <div id="favorites-action-bar" style="display: none">
            <button id="favorites-delete-selected-btn" class="action-bar-btn">
              删除 (0)
            </button>
          </div>
        </div>

        <div id="memories-view" class="chat-list-view">
          <div class="header">
            <span class="back-btn" id="memories-back-btn">‹</span>
            <span>我们的回忆</span>
            <span class="action-btn" id="add-countdown-btn">+</span>
          </div>
          <div
            id="memories-list"
            class="list-container"
            style="
              padding: 15px;
              display: flex;
              flex-direction: column;
              gap: 15px;
            "
          >
            <!-- 回忆卡片将由JS动态生成在这里 -->
          </div>
        </div>

        <!-- 底部导航栏 -->
        <div id="chat-list-bottom-nav">
          <div class="nav-item active" data-view="messages-view">
            <span>消息</span>
          </div>
          <div class="nav-item" data-view="qzone-screen">
            <span>动态</span>
          </div>

          <div class="nav-item" data-view="memories-view">
            <span>回忆</span>
          </div>

          <div class="nav-item" data-view="favorites-view">
            <span>收藏</span>
          </div>
        </div>
      </div>

      <div id="album-screen" class="screen">
        <!-- 1. 页面头部，包含返回按钮和标题 -->
        <div class="header">
          <span class="back-btn" id="album-back-btn">‹</span>
          <span>我的相册</span>
          <span class="action-btn" id="create-album-btn-page">+</span>
        </div>

        <!-- 2. 页面内容容器 -->
        <div class="list-container">
          <div id="album-grid-page">
            <!-- 相册列表将由 JS 动态生成在这里 -->
          </div>
        </div>
      </div>

      <div id="album-photos-screen" class="screen">
        <!-- 1. 页面头部 -->
        <div class="header">
          <span class="back-btn" id="album-photos-back-btn">‹</span>
          <span id="album-photos-title">相册名称</span>
          <span class="action-btn" id="album-upload-photo-btn">上传</span>
        </div>

        <!-- 2. 页面内容容器 -->
        <div class="list-container">
          <div id="photos-grid-page">
            <!-- 照片列表将由 JS 动态生成在这里 -->
          </div>

          <div id="photo-viewer-modal" class="modal">
            <!-- 1. 关闭按钮 -->
            <button id="photo-viewer-close-btn">×</button>

            <!-- 2. 上一张照片按钮 -->
            <button id="photo-viewer-prev-btn" class="nav-arrow">‹</button>

            <!-- 3. 图片容器 -->
            <div class="photo-viewer-content">
              <img id="photo-viewer-image" src="" alt="全屏照片预览" />
            </div>

            <!-- 4. 下一张照片按钮 -->
            <button id="photo-viewer-next-btn" class="nav-arrow">›</button>
          </div>
        </div>
      </div>

      <input
        type="file"
        id="album-photo-input"
        accept="image/*"
        multiple
        hidden
      />

      <div id="chat-interface-screen" class="screen">
        <div class="header">
          <!-- 默认控件：包含标题、状态栏和常规按钮 -->
          <div class="default-controls">
            <span class="back-btn" id="back-to-list-btn">‹</span>

            <!-- 标题和状态的容器 -->
            <div id="chat-header-title-wrapper">
              <div id="chat-header-main-line">
                <span id="chat-header-title">聊天对象</span>
                <!-- 【全新】群公告按钮 -->
                <span id="group-announcement-btn" title="群公告">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="3"
                      y="3"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"
                    ></rect>
                    <line x1="7" y1="15" x2="17" y2="15"></line>
                  </svg>
                </span>
              </div>
              <div id="chat-header-status">
                <span class="status-dot"></span>
                <span class="status-text">在线</span>
              </div>
            </div>

            <div class="header-actions">
              <!-- 心声按钮 -->
              <span
                class="action-btn"
                id="char-heart-btn"
                title="心声"
                style="display: none; cursor: pointer"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="#ff4d6d"
                  stroke="#ffc3d0"
                  stroke-width="1.5"
                >
                  <path
                    d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                  />
                </svg>
              </span>
              <span class="action-btn" id="listen-together-btn" title="一起听"
                ><img
                  src="https://i.postimg.cc/CxjpF6gK/yi-qi-ting.png"
                  alt="一起听"
              /></span>
              <span class="action-btn" id="chat-settings-btn" title="聊天设置"
                ><img
                  src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png"
                  alt="设置"
              /></span>
            </div>
          </div>

          <!-- 多选模式控件 -->
          <div class="selection-controls">
            <span id="selection-cancel-btn">取消</span>
            <span id="selection-count"></span>
            <div class="header-actions">
              <span id="selection-favorite-btn" class="action-btn">收藏</span>
              <span id="selection-share-btn" class="action-btn">分享</span>
              <span id="selection-screenshot-btn" class="action-btn">长截图</span>
              <span
                id="selection-delete-btn"
                class="action-btn"
                style="color: #ff3b30"
                >删除</span
              >
            </div>
          </div>
        </div>

        <div
          id="chat-pet-container"
          style="
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
          "
        >
          <div
            id="chat-pet"
            style="
              display: none;
              position: absolute;
              cursor: grab;
              user-select: none;
              pointer-events: all;
              font-size: 80px;
              line-height: 1;
              text-align: center;
            "
          >
            <!-- 宠物会显示在这里 -->
          </div>
        </div>

        <!-- 聊天消息区域 (保持不变) -->
        <div id="chat-messages">
          <div id="typing-indicator">对方正在输入...</div>
        </div>

        <!-- 输入区域 (这是修改后的最终版本) -->
        <div id="chat-input-area">
          <div id="reply-preview-bar">
            <div class="reply-preview-content">
              <div class="sender">回复 xxx:</div>
              <div class="text">被引用的消息内容...</div>
            </div>
            <span id="cancel-reply-btn">×</span>
          </div>

          <div id="chat-input-actions-top">
            <button
              id="open-sticker-panel-btn"
              class="chat-action-icon-btn action-button"
              title="表情面板"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>

            <!-- “重新生成回复”按钮的新家 -->
            <button id="reroll-btn" class="action-button" title="重新生成回复">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>

            <button
              id="quick-reply-btn"
              class="chat-action-icon-btn action-button"
              title="快捷回复"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <!-- 气泡轮廓 -->
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
                <!-- 里面的两行文字线，代表预设内容 -->
                <line x1="8" y1="9" x2="16" y2="9"></line>
                <line x1="8" y1="13" x2="14" y2="13"></line>
              </svg>
            </button>

            <button
              id="send-photo-btn"
              class="chat-action-icon-btn action-button"
              title="发送照片"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                />
                <circle cx="12" cy="13" r="4" />
              </svg>
            </button>
            <button
              id="upload-image-btn"
              class="chat-action-icon-btn action-button"
              title="上传图片"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <button
              id="transfer-btn"
              class="chat-action-icon-btn action-button"
              title="转账"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M7 4L12 12L17 4M12 12V20M8 10H16M8 13H16"></path>
              </svg>
            </button>
            <button
              id="voice-message-btn"
              class="chat-action-icon-btn action-button"
              title="发送语音"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                />
                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                <path d="M12 19v4" />
                <path d="M8 23h8" />
              </svg>
            </button>
            <button
              id="send-waimai-request-btn"
              class="chat-action-icon-btn action-button"
              title="发起外卖请求"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
                <line x1="3" y1="6" x2="21" y2="6" />
                <path d="M16 10a4 4 0 0 1-8 0" />
              </svg>
            </button>
            <button
              id="video-call-btn"
              class="chat-action-icon-btn action-button"
              title="视频通话"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
              </svg>
            </button>
            <button
              id="group-video-call-btn"
              class="chat-action-icon-btn action-button"
              title="群视频通话"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </button>
            <button
              id="send-poll-btn"
              class="chat-action-icon-btn action-button"
              title="发起投票"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M8 6h10" />
                <path d="M6 6h.01" />
                <path d="M8 12h10" />
                <path d="M6 12h.01" />
                <path d="M8 18h10" />
                <path d="M6 18h.01" />
              </svg>
            </button>
            <button
              id="advance-plot-btn"
              class="chat-action-icon-btn action-button"
              title="推进剧情"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="9 18 15 12 9 6"></polyline>
                <polyline points="15 18 21 12 15 6"></polyline>
              </svg>
            </button>
            <button
              id="share-link-btn"
              class="chat-action-icon-btn action-button"
              title="分享链接"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"
                ></path>
                <path
                  d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"
                ></path>
              </svg>
            </button>

            <button
              id="send-location-btn"
              class="chat-action-icon-btn action-button"
              title="发送定位"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
            </button>

            <!-- 时间轴/存档按钮 (放入工具栏) -->
            <button
              id="timeline-branch-btn"
              class="chat-action-icon-btn action-button"
              title="时间轴/存档"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <!-- 这是一个分叉线的图标 -->
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 21v-6"></path>
                <path d="M12 9V3"></path>
                <path
                  d="M7 3.3a9.8 9.8 0 0 0-4.7 8.7c0 5.5 4.5 10 10 10s10-4.5 10-10a9.8 9.8 0 0 0-4.7-8.7"
                ></path>
              </svg>
            </button>

            <button
              id="open-tarot-btn"
              class="chat-action-icon-btn action-button"
              title="塔罗占卜"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <!-- 背景左侧卡牌 -->
                <path
                  d="M7 6.5L4 7.5V17.5L7 16.5V6.5Z"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linejoin="round"
                />
                <!-- 背景右侧卡牌 -->
                <path
                  d="M17 6.5L20 7.5V17.5L17 16.5V6.5Z"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linejoin="round"
                />
                <!-- 前方中心卡牌 -->
                <rect
                  x="7"
                  y="5"
                  width="10"
                  height="15"
                  rx="1.5"
                  stroke="currentColor"
                  stroke-width="2.6"
                />
                <!-- 中心卡牌的星星 -->
                <path
                  d="M12 9.5L13.12 11.79L15.61 12.17L13.8 13.92L14.24 16.4L12 15.2L9.76 16.4L10.2 13.92L8.39 12.17L10.88 11.79L12 9.5Z"
                  fill="currentColor"
                />
              </svg>
            </button>

            <button
              id="pet-action-btn"
              class="chat-action-icon-btn action-button"
              title="我的宠物"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <!-- 主体轮廓: 耳朵不对称，营造歪头效果 -->
                <path
                  d="M3.5 14.5C3.5 20.5 20.5 20.5 20.5 14.5C20.5 9 17.5 5.5 12.5 8.7C6.5 4.5 3.5 9 3.5 14.5Z"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <!-- 眼睛 -->
                <circle cx="8.5" cy="15" r="1.5" fill="currentColor" />
                <circle cx="15.5" cy="15" r="1.5" fill="currentColor" />
                <!-- 左边两根小胡须 -->
                <path
                  d="M4.5 14.3L2.5 13.3"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linecap="round"
                />
                <path
                  d="M4.5 15.7L2.5 16.7"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linecap="round"
                />
                <!-- 右边两根小胡须 -->
                <path
                  d="M19.5 14.3L21.5 13.3"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linecap="round"
                />
                <path
                  d="M19.5 15.7L21.5 16.7"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linecap="round"
                />
              </svg>
            </button>
            <!-- 极光多媒体按钮 (已改为单色) -->
            <button
              id="aurora-media-btn"
              class="chat-action-icon-btn action-button"
              title="漫游共赏 (视频/小说)"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 3C7.03 3 3 7.03 3 12C3 16.97 7.03 21 12 21C16.97 21 21 16.97 21 12C21 7.03 16.97 3 12 3Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M15 9L9 15M9 9L15 15"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M12 8V16"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>
          <div id="chat-input-main-row">
            <textarea
              id="chat-input"
              rows="1"
              placeholder="输入消息..."
            ></textarea>
            <div id="input-actions-wrapper">
              <button id="wait-reply-btn" title="等待回复">
                <img
                  src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png"
                  alt="等待回复"
                />
              </button>
              <button id="send-btn" class="action-button">发送</button>
            </div>
          </div>
        </div>

        <div id="chat-lock-overlay">
          <div id="chat-lock-content"></div>
        </div>

        <div id="sticker-panel">
          <div id="sticker-panel-header">
            <span class="panel-btn" id="close-sticker-panel-btn">取消</span>
            <span class="title">表情包</span>
            <!-- “编辑”和“完成”按钮 -->
            <div style="display: flex; gap: 10px">
              <span class="panel-btn" id="edit-user-stickers-btn">编辑</span>
              <span
                class="panel-btn"
                id="done-user-stickers-btn"
                style="display: none"
                >完成</span
              >
              <span class="panel-btn" id="add-sticker-btn">添加</span>
              <span class="panel-btn" id="upload-sticker-btn">上传</span>
            </div>
          </div>
          <!-- 搜索框 -->
          <div id="sticker-search-container">
            <input
              type="text"
              id="sticker-search-input"
              placeholder="搜索表情包名称..."
              autocomplete="off"
            />
          </div>
          <div id="sticker-grid"></div>

          <!-- 在 #sticker-panel 中，找到 id="sticker-panel-footer" -->

          <div id="sticker-category-tabs">
            <!-- 分类胶囊将由JS动态生成在这里 -->
          </div>

          <div id="sticker-panel-footer" style="display: none">
            <!-- 全选按钮 -->
            <button id="select-all-stickers-btn">全选</button>
            <!-- 移动表情按钮 -->
            <button id="move-selected-stickers-btn">移动到分类...</button>
            <!-- 删除表情按钮 -->
            <button id="delete-selected-user-stickers-btn">删除已选 (0)</button>
          </div>
        </div>

        <input
          type="file"
          id="sticker-upload-input"
          accept="image/*"
          style="display: none"
          multiple
        />
        <input
          type="file"
          id="image-upload-input"
          accept="image/*"
          style="display: none"
        />

        <!-- 音乐播放器 (保持不变) -->
        <div id="music-player-overlay">
          <div class="music-player-window">
            <!-- 1. 顶部头像区域 -->
            <div id="music-avatars-container">
              <img id="music-char-avatar" src="" alt="角色头像" />
              <svg id="heartbeat-line" viewBox="0 0 80 30">
                <path
                  class="heartbeat-path"
                  d="M 5 15 Q 20 0 30 15 T 55 15 L 75 15"
                ></path>
                <path
                  class="heartbeat-heart"
                  d="M 0 -2 a 2 2 0 0 1 4 0 v 2 a 2 2 0 0 1 -4 0 z"
                ></path>
              </svg>
              <img id="music-user-avatar" src="" alt="用户头像" />
            </div>

            <div id="music-time-counter">已经一起听了0.0小时</div>

            <!-- 2. 顶部操作按钮 -->
            <div class="music-player-top-actions">
              <div class="top-left-cluster">
                <button id="music-return-btn">‹</button>
                <button id="music-exit-btn">×</button>
              </div>
              <span id="music-playlist-btn">☰</span>
            </div>

            <!-- 3. 封面和歌词的切换容器 -->
            <div id="music-display-area">
              <img
                id="music-album-cover"
                src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
                alt="歌曲封面"
              />
              <div id="music-lyrics-container">
                <div id="music-lyrics-list">
                  <div class="lyric-line">♪ 暂无歌词 ♪</div>
                </div>
              </div>
            </div>

            <!-- 4. 歌曲信息 -->
            <div id="music-player-song-title">请添加歌曲</div>
            <div id="music-player-artist">...</div>

            <!-- 5. 播放控制区 (保持不变) -->
            <div class="music-player-controls-wrapper">
              <div class="music-progress-bar-container">
                <div id="music-current-time" class="time-display">0:00</div>
                <div class="progress-bar">
                  <div id="music-progress-fill" class="progress-bar-fill"></div>
                </div>
                <div id="music-total-time" class="time-display">0:00</div>
              </div>
              <div class="music-controls">
                <button id="music-prev-btn">◀</button>
                <button id="music-play-pause-btn" class="play-pause-btn">
                  ▶
                </button>
                <button id="music-next-btn">▶</button>
                <button id="music-mode-btn">顺序</button>
                <button id="toggle-lyrics-bar-btn" title="桌面歌词">
                  悬浮
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="music-playlist-panel">
        <div class="playlist-header">
          <span class="panel-btn" id="close-playlist-btn">返回</span>
          <span>播放列表</span>
          <div>
            <span
              class="panel-btn"
              id="delete-expired-songs-btn"
              title="清理失效的搜索歌曲"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M3 6H5H21"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
            <span class="panel-btn" id="add-song-local-btn">本地</span>
            <span class="panel-btn" id="add-song-url-btn">URL</span>
            <span class="panel-btn" id="add-song-search-btn">搜索</span>
          </div>
        </div>

        <div class="playlist-body" id="playlist-body"></div>
      </div>
      <input
        type="file"
        id="local-song-upload-input"
        accept="audio/*"
        multiple
        style="display: none"
      />
      <input
        type="file"
        id="lrc-upload-input"
        accept=".lrc"
        style="display: none"
      />
    </div>

    <!-- 外观设置页面 (已修复ID和布局) -->
    <div id="wallpaper-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>外观设置</span>
        <span style="width: 30px"></span>
      </div>

      <!-- 内容滚动区域 -->
      <div class="form-container settings-scroll-container">
        <!-- 1. 锁屏与安全卡片 -->
        <div class="settings-group-card">
          <div class="settings-section-title">🔒 锁屏与安全</div>

          <div class="setting-row">
            <label class="setting-label">启用锁屏界面</label>
            <label class="toggle-switch-label">
              <input type="checkbox" id="enable-lock-screen-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <label>锁屏密码 (留空则无)</label>
            <input
              type="text"
              id="password-set-input"
              class="moe-input"
              placeholder="设置解锁密码"
            />
          </div>

          <div class="setting-item">
            <label>锁屏壁纸</label>
            <div class="preview-upload-box">
              <div id="lockscreen-wallpaper-preview" class="mini-preview">
                预览
              </div>
              <button
                class="upload-btn-pill"
                onclick="document.getElementById('lockscreen-wallpaper-upload-input').click();"
              >
                更换壁纸
              </button>
            </div>
            <input
              type="file"
              id="lockscreen-wallpaper-upload-input"
              accept="image/*"
              hidden
            />
          </div>
        </div>
        <!-- 5. 高级美化 (CSS) 卡片 -->
        <div class="settings-group-card">
          <div class="settings-section-title">自定义css美化 (CSS)</div>

          <div class="setting-item">
            <div style="display: flex; gap: 5px; margin-bottom: 5px">
              <select
                id="theme-selector"
                class="moe-input select"
                style="flex: 1"
              ></select>
              <button id="rename-theme-btn" class="btn-icon">✏️</button>
              <button id="delete-theme-btn" class="btn-icon danger">🗑️</button>
            </div>
            <textarea
              id="theme-css-editor"
              class="moe-input code-area"
              rows="6"
              placeholder="在此输入CSS代码..."
            ></textarea>
            <div class="css-actions">
              <button id="apply-theme-btn" class="upload-btn-pill primary">
                应用
              </button>
              <button id="save-theme-btn" class="upload-btn-pill">保存</button>
              <button id="save-as-new-theme-btn" class="upload-btn-pill">
                另存为
              </button>
              <button id="export-theme-btn" class="upload-btn-pill secondary">
                导出
              </button>
              <button id="import-theme-btn" class="upload-btn-pill secondary">
                导入
              </button>
              <button
                id="reset-theme-css-btn"
                class="upload-btn-pill danger"
                style="background-color: #ff3b30; color: white"
              >
                重置
              </button>
              <input
                type="file"
                id="import-theme-input"
                accept=".json, .txt, .css, .docx"
                hidden
              />
            </div>
          </div>
        </div>

        <!-- 2. 主屏幕视觉卡片 -->
        <div class="settings-group-card">
          <div class="settings-section-title">📱 主屏幕视觉</div>

          <div class="setting-row">
            <label class="setting-label">显示状态栏</label>
            <label class="toggle-switch-label">
              <input type="checkbox" id="show-status-bar-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <label class="setting-label">夜间模式</label>
            <label class="toggle-switch-label">
              <!-- ★★★ 核心修复：ID 改回 theme-toggle-switch，解决报错 ★★★ -->
              <input type="checkbox" id="theme-toggle-switch" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <label class="setting-label">去除文字阴影</label>
            <label class="toggle-switch-label">
              <input type="checkbox" id="remove-home-font-shadow-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <label>主屏幕壁纸</label>
            <div class="preview-upload-box">
              <div id="wallpaper-preview" class="mini-preview">预览</div>
              <button
                class="upload-btn-pill"
                onclick="document.getElementById('wallpaper-upload-input').click();"
              >
                更换壁纸
              </button>
            </div>
            <input
              type="file"
              id="wallpaper-upload-input"
              accept="image/*"
              hidden
            />
          </div>

          <div class="setting-item">
            <label>图标/组件字体颜色</label>
            <div class="color-picker-wrapper">
              <!-- 1. 颜色选择器 (保持原ID) -->
              <input
                type="color"
                id="home-icon-widget-text-color-picker"
                value="#FFFFFF"
              />

              <!-- 2. 文本输入框，允许手动输入颜色代码 -->
              <input
                type="text"
                id="home-icon-widget-text-color-input"
                placeholder="#FFFFFF"
                maxlength="7"
                spellcheck="false"
              />
            </div>
          </div>

          <!-- 主屏幕预设部分 -->
          <div class="setting-item">
            <label>主屏幕预设管理</label>
            <div
              class="preset-manager-container"
              style="margin-top: 5px; border: none; padding: 0"
            >
              <div class="form-group">
                <select
                  id="home-preset-selector"
                  class="moe-input select"
                ></select>
                <div class="preset-manager-controls compact">
                  <button
                    id="apply-home-preset-btn"
                    class="preset-btn-capsule preset-btn-apply"
                    disabled
                  >
                    应用
                  </button>
                  <button
                    id="save-home-preset-btn"
                    class="preset-btn-capsule preset-btn-save"
                  >
                    保存当前
                  </button>
                  <button
                    id="update-home-preset-btn"
                    class="preset-btn-capsule preset-btn-secondary"
                    disabled
                  >
                    更新
                  </button>
                  <button
                    id="rename-home-preset-btn"
                    class="preset-btn-capsule preset-btn-secondary"
                    disabled
                  >
                    重命名
                  </button>
                  <button
                    id="delete-home-preset-btn"
                    class="preset-btn-capsule preset-btn-delete"
                    disabled
                  >
                    删除
                  </button>
                  <button
                    id="import-home-preset-btn"
                    class="preset-btn-capsule preset-btn-secondary"
                  >
                    导入
                  </button>
                  <button
                    id="export-home-preset-btn"
                    class="preset-btn-capsule preset-btn-secondary"
                    disabled
                  >
                    导出
                  </button>
                  <input
                    type="file"
                    id="import-home-preset-input"
                    accept=".json"
                    hidden
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 3. App 图标与名称卡片 -->
        <div class="settings-group-card">
          <div class="settings-section-title">🎨 图标与名称</div>
          <div class="setting-item">
            <label>App 图标定制</label>
            <div id="icon-settings-grid" class="icon-grid-compact">
              <!-- JS生成 -->
            </div>
          </div>

          <div class="setting-item">
            <label>App 名称定制</label>
            <div id="icon-rename-grid" class="name-grid-compact">
              <!-- JS生成 -->
            </div>
            <button
              class="form-button-secondary small-btn"
              id="reset-app-names-btn"
            >
              恢复默认名字
            </button>
          </div>
        </div>

        <!-- 4. 声音与背景卡片 -->
        <div class="settings-group-card">
          <div class="settings-section-title">🎵 声音与背景</div>

          <div class="setting-item">
            <label>来电铃声 URL</label>
            <input
              type="text"
              id="ringtone-url-input"
              class="moe-input"
              placeholder="音频链接..."
            />
          </div>

          <div class="setting-item">
            <label>提示音 URL</label>
            <input
              type="text"
              id="notification-sound-url-input"
              class="moe-input"
              placeholder="音频链接..."
            />
          </div>

          <div class="setting-item">
            <label>全局聊天背景</label>
            <div class="preview-upload-box">
              <!-- ★★★ 修改点：删除了 landscape 类名，现在它是竖屏的了 ★★★ -->
              <div id="global-bg-preview" class="mini-preview">预览</div>
              <div class="btn-col">
                <button
                  class="upload-btn-pill"
                  onclick="document.getElementById('global-bg-upload-input').click();"
                >
                  上传背景
                </button>
                <button
                  class="upload-btn-pill danger"
                  id="remove-global-bg-btn"
                >
                  移除背景
                </button>
              </div>
            </div>
            <input
              type="file"
              id="global-bg-upload-input"
              accept="image/*"
              hidden
            />
            <button
              class="form-button-secondary small-btn danger-text"
              id="clear-all-single-bgs-btn"
              style="margin-top: 10px"
            >
              一键清空所有单人聊天背景
            </button>
          </div>
        </div>

        <!-- 底部留白，防止被保存按钮遮挡 -->
        <div style="height: 80px"></div>
      </div>

      <!-- ★★★ 悬浮保存按钮 ★★★ -->
      <button id="save-wallpaper-btn" class="moe-fab-save">
        💾<span style="font-size: 12px; display: block; margin-top: -2px"
          >保存</span
        >
      </button>
    </div>

    <!-- 分享链接功能 HTML -->
    <div id="browser-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="browser-back-btn">‹</span>
        <span id="browser-title"></span>
        <span style="width: 30px"></span>
      </div>
      <div id="browser-content" class="list-container">
        <!-- 文章内容将由JS动态生成在这里 -->
      </div>
    </div>

    <div id="font-settings-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>字体预设</span>
        <span style="width: 30px"></span>
        <!-- 保留这个占位符，让标题能完美居中 -->
      </div>
      <div class="form-container" style="gap: 20px">
        <p
          style="
            font-size: 13px;
            color: #ff6b6b;
            background-color: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.2);
            text-align: center;
            width: 100%;
            box-sizing: border-box;
          "
        >
          字体太大了导入本地字体会闪退！最好用url。
        </p>
        <!-- 字体预设卡槽的容器 -->
        <div id="font-preset-container">
          <!-- 5个卡槽将由JavaScript动态生成在这里 -->
        </div>

        <!-- 全局字体预览区 -->
        <div class="form-group" style="width: 100%">
          <label>当前全局字体预览</label>
          <div id="font-preview">
            <p style="font-size: 20px; margin: 0 0 10px 0">
              你好世界 Hello World
            </p>
            <p style="margin: 0">这是全局字体预览效果，12345。</p>
          </div>
        </div>

        <button class="form-button form-button-secondary" id="reset-font-btn">
          恢复默认字体
        </button>
      </div>
    </div>

    <!-- 这个是隐藏的文件选择器，用来处理本地上传 -->
    <input
      type="file"
      id="font-preset-local-upload"
      accept=".ttf,.otf,.woff,.woff2"
      style="display: none"
    />

    <!-- “查角色手机”功能的所有HTML界面 -->

    <!-- 1. 角色选择屏幕 (保持不变) -->
    <div id="character-selection-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>选择要查看的手机</span>
        <span style="width: 30px"></span>
      </div>
      <div id="character-selection-list" class="list-container"></div>
    </div>

    <div id="character-phone-container" class="screen">
      <div class="character-phone-frame">
        <div class="character-phone-notch"></div>
        <div class="character-phone-inner-screen">
          <!-- 1. 角色手机的主界面 -->
          <div id="character-phone-screen" class="character-phone-page active">
            <div class="header character-phone-header">
              <span
                class="back-btn"
                data-target-screen="character-selection-screen"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span id="character-phone-owner-name"></span>
              <div class="header-actions">
                <span
                  class="action-btn"
                  id="clear-character-data-btn"
                  title="清空全部数据"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-character-data-btn"
                  title="刷新全部数据"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M23 4v6h-6M1 20v-6h6" />
                    <path
                      d="M3.51 9a9 9 0 0114.85-3.36L20.5 10M3.5 14a9 9 0 0114.85 3.36L20.5 14"
                    />
                  </svg>
                </span>
              </div>
            </div>

            <!-- 这是左上角的小组件 -->
            <div id="char-phone-widget-1" class="char-phone-widget">
              <img id="char-phone-widget-img-1" src="" />
            </div>
            <!-- 这是右下角的小组件 -->
            <div id="char-phone-widget-2" class="char-phone-widget">
              <img id="char-phone-widget-img-2" src="" />
            </div>

            <div
              id="character-app-grid"
              class="app-grid-standard"
              style="padding-top: 60px"
            ></div>
          </div>

          <!-- 2. 角色手机 - 聊天列表 -->
          <div
            id="character-chat-list-screen"
            class="character-phone-page"
            style="display: flex; flex-direction: column; height: 100%"
          >
            <div class="header character-phone-header" style="flex-shrink: 0">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>消息</span>
              <div class="header-actions">
                <!-- ★ 新增：消息页的删除按钮 ★ -->
                <span
                  class="action-btn"
                  id="clear-npc-chats-btn"
                  title="清空所有NPC聊天"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-chat-message-btn"
                  title="生成新聊天"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                    />
                  </svg>
                </span>
              </div>
            </div>

            <div
              id="character-chat-list"
              class="list-container"
              style="
                padding: 0;
                flex-grow: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
              "
            ></div>
          </div>

          <!-- 3. 角色手机 - 具体聊天记录 -->
          <div id="character-chat-history-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span
                class="back-btn"
                data-target-page="character-chat-list-screen"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span id="character-chat-with-name"></span>
            </div>
            <div
              id="character-chat-history-messages"
              class="list-container"
              style="
                padding: 15px;
                display: flex;
                flex-direction: column;
                gap: 15px;
                background-color: #e5ddd5;
              "
            ></div>
          </div>

          <!-- 4. 角色手机 - 购物车 -->
          <div id="character-shopping-cart-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>购物车</span>
              <div class="header-actions">
                <!-- ★ 新增：购物车页的删除按钮 ★ -->
                <span
                  class="action-btn"
                  id="clear-cart-items-btn"
                  title="清空购物车"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-cart-item-btn"
                  title="添加新商品"
                >
                  <svg
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-shopping-cart-list" class="list-container"></div>
          </div>

          <!-- 5. 角色手机 - 备忘录 -->
          <div id="character-memos-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>备忘录</span>
              <div class="header-actions">
                <!-- ★ 新增：备忘录页的删除按钮 ★ -->
                <span
                  class="action-btn"
                  id="clear-memos-btn"
                  title="清空备忘录"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-memo-btn"
                  title="写新备忘录"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                    />
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-memos-list" class="list-container"></div>
          </div>

          <!-- 6. 角色手机 - 浏览器 -->
          <div id="character-browser-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>浏览器</span>
              <div class="header-actions">
                <!-- ★ 新增：浏览器页的删除按钮 ★ -->
                <span
                  class="action-btn"
                  id="clear-browser-history-btn"
                  title="清空历史记录"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-browser-history-btn"
                  title="生成新历史"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"
                    ></path>
                    <path
                      d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"
                    ></path>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-browser-list" class="list-container"></div>
          </div>

          <!-- 7. 角色手机 - 浏览器搜索结果详情 -->
          <div
            id="character-browser-detail-screen"
            class="character-phone-page"
          >
            <div class="header character-phone-header">
              <span
                class="back-btn"
                data-target-page="character-browser-screen"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span id="character-browser-detail-title">搜索结果</span>
            </div>
            <div
              id="character-browser-detail-content"
              class="list-container"
              style="padding: 15px; line-height: 1.7"
            ></div>
          </div>

          <!-- 8. 角色手机 - 相册 -->
          <div id="character-album-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>相册</span>
              <div class="header-actions">
                <!-- ★ 新增：相册页的删除按钮 ★ -->
                <span
                  class="action-btn"
                  id="clear-album-photos-btn"
                  title="清空相册"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-album-photo-btn"
                  title="生成新照片"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="3"
                      y="3"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"
                    ></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-album-grid" class="list-container"></div>
          </div>

          <!-- 9. 角色手机 - 银行 -->
          <div id="character-bank-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>钱包</span>
              <div class="header-actions">
                <!-- ★ 新增：钱包页的删除按钮 ★ -->
                <span
                  class="action-btn"
                  id="clear-bank-transactions-btn"
                  title="清空交易记录"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-bank-transaction-btn"
                  title="生成新交易"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path
                      d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                    ></path>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-bank-details" class="list-container"></div>
          </div>

          <!-- 10. 角色手机 - 行动轨迹 -->
          <div id="character-trajectory-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>足迹</span>
              <div class="header-actions">
                <!-- ★ 新增：足迹页的删除按钮 ★ -->
                <span
                  class="action-btn"
                  id="clear-trajectory-btn"
                  title="清空足迹"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-trajectory-btn"
                  title="生成新足迹"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                    ></path>
                    <circle cx="12" cy="10" r="3"></circle>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-trajectory-list" class="list-container"></div>
          </div>

          <!-- 11. 角色手机 - APP使用记录 -->
          <div id="character-app-usage-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>屏幕使用时间</span>
              <div class="header-actions">
                <!-- ★ 新增：使用记录页的删除按钮 ★ -->
                <span
                  class="action-btn"
                  id="clear-app-usage-btn"
                  title="清空记录"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-app-usage-btn"
                  title="生成新记录"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"
                    ></path>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-app-usage-list" class="list-container"></div>
          </div>

          <!-- 12. 角色手机 - 日记 -->
          <div id="character-diary-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>日记</span>
              <div class="header-actions">
                <!-- ★ 新增：日记页的删除按钮 ★ -->
                <span
                  class="action-btn"
                  id="clear-diary-entries-btn"
                  title="清空日记"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-diary-entry-btn"
                  title="写新日记"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                    />
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-diary-list" class="list-container"></div>
          </div>

          <div
            id="character-phone-appearance-screen"
            class="character-phone-page"
          >
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>外观设置</span>
              <span style="width: 30px"></span>
            </div>
            <!-- 复用你已有的.form-container样式，方便滚动和布局 -->
            <div class="form-container" style="padding: 15px; gap: 25px">
              <!-- 壁纸设置区 -->
              <div>
                <label style="font-weight: 500; color: var(--text-secondary)"
                  >手机壁纸</label
                >
                <div
                  id="char-phone-wallpaper-preview"
                  class="wallpaper-preview"
                  style="
                    height: 240px;
                    width: 135px;
                    margin: 10px auto;
                    border-radius: 12px;
                  "
                >
                  点击下方上传
                </div>
                <button
                  id="upload-char-phone-wallpaper-btn"
                  class="form-button"
                >
                  上传壁纸
                </button>
                <button
                  id="remove-char-phone-wallpaper-btn"
                  class="form-button form-button-secondary"
                  style="margin-top: 10px"
                >
                  移除壁纸
                </button>
              </div>

              <hr style="width: 100%; opacity: 0.2" />

              <div>
                <label style="font-weight: 500; color: var(--text-secondary)"
                  >App 内壁纸</label
                >
                <div
                  id="char-phone-app-wallpaper-preview"
                  class="wallpaper-preview"
                  style="
                    height: 240px;
                    width: 135px;
                    margin: 10px auto;
                    border-radius: 12px;
                  "
                >
                  点击下方上传
                </div>
                <button
                  id="upload-char-phone-app-wallpaper-btn"
                  class="form-button"
                >
                  上传 App 内壁纸
                </button>
                <button
                  id="remove-char-phone-app-wallpaper-btn"
                  class="form-button form-button-secondary"
                  style="margin-top: 10px"
                >
                  移除 App 内壁纸
                </button>
              </div>

              <hr style="width: 100%; opacity: 0.2" />

              <!-- App图标设置区 -->
              <div>
                <label style="font-weight: 500; color: var(--text-secondary)"
                  >App 图标</label
                >
                <div
                  id="char-phone-icon-settings-grid"
                  style="
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 20px;
                    margin-top: 15px;
                    text-align: center;
                  "
                >
                  <!-- App图标设置将由JS动态生成在这里 -->
                </div>
              </div>

              <hr style="width: 100%; opacity: 0.2" />
              <!-- 桌面小组件设置区 -->
              <div>
                <label style="font-weight: 500; color: var(--text-secondary)"
                  >桌面小组件</label
                >
                <!-- 小组件1: 左上角 -->
                <div class="form-group" style="margin-top: 15px">
                  <label>左上角小组件</label>
                  <div class="avatar-upload">
                    <img
                      id="char-phone-widget-preview-1"
                      class="wallpaper-preview"
                      style="height: 100px; width: 100px; margin-bottom: 0"
                    />
                    <div
                      style="display: flex; flex-direction: column; gap: 8px"
                    >
                      <button
                        class="form-button-secondary"
                        id="upload-widget-1-btn"
                        style="margin-top: 0"
                      >
                        上传图片
                      </button>
                      <button
                        class="form-button-secondary"
                        id="remove-widget-1-btn"
                        style="
                          margin-top: 0;
                          border-color: #ff3b30;
                          color: #ff3b30;
                        "
                      >
                        移除图片
                      </button>
                    </div>
                  </div>
                </div>
                <!-- 小组件2: 右下角 -->
                <div class="form-group" style="margin-top: 15px">
                  <label>右下角小组件</label>
                  <div class="avatar-upload">
                    <img
                      id="char-phone-widget-preview-2"
                      class="wallpaper-preview"
                      style="height: 100px; width: 100px; margin-bottom: 0"
                    />
                    <div
                      style="display: flex; flex-direction: column; gap: 8px"
                    >
                      <button
                        class="form-button-secondary"
                        id="upload-widget-2-btn"
                        style="margin-top: 0"
                      >
                        上传图片
                      </button>
                      <button
                        class="form-button-secondary"
                        id="remove-widget-2-btn"
                        style="
                          margin-top: 0;
                          border-color: #ff3b30;
                          color: #ff3b30;
                        "
                      >
                        移除图片
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <hr style="width: 100%; opacity: 0.2; margin-top: 25px" />
              <div class="preset-manager-container">
                <div style="width: 100%; text-align: left; margin-bottom: 15px">
                  <label style="font-weight: 500; color: var(--text-secondary)"
                    >外观预设</label
                  >
                </div>
                <div class="form-group">
                  <select
                    id="char-phone-preset-selector"
                    class="form-group select"
                  ></select>
                  <div class="preset-manager-controls">
                    <!-- 独占一行的应用按钮 -->
                    <button
                      id="apply-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-apply"
                      disabled
                    >
                      应用
                    </button>

                    <!-- 2x2 网格按钮 -->
                    <button
                      id="save-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-save"
                    >
                      保存
                    </button>
                    <button
                      id="update-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-secondary"
                      disabled
                    >
                      更新
                    </button>
                    <button
                      id="rename-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-secondary"
                      disabled
                    >
                      重命名
                    </button>
                    <button
                      id="import-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-secondary"
                    >
                      导入
                    </button>
                    <button
                      id="export-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-secondary"
                      disabled
                    >
                      导出
                    </button>
                    <button
                      id="delete-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-delete"
                      disabled
                    >
                      删除
                    </button>

                    <input
                      type="file"
                      id="import-char-phone-preset-input"
                      accept=".json"
                      hidden
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- 隐藏的文件选择器，用于处理上传 -->
          <input
            type="file"
            id="char-phone-wallpaper-upload-input"
            accept="image/*"
            hidden
          />
          <input
            type="file"
            id="char-phone-icon-upload-input"
            accept="image/*"
            hidden
          />

          <input
            type="file"
            id="char-phone-widget-1-upload-input"
            accept="image/*"
            hidden
          />
          <input
            type="file"
            id="char-phone-widget-2-upload-input"
            accept="image/*"
            hidden
          />
          <input
            type="file"
            id="char-phone-app-wallpaper-upload-input"
            accept="image/*"
            hidden
          />
        </div>
      </div>
    </div>
    <!-- “查手机”功能-生成聊天对象选择弹窗 -->
    <div id="chat-gen-selector-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>选择聊天对象</span>
        </div>
        <div
          class="modal-body"
          style="padding: 0; display: flex; flex-direction: column"
        >
          <!-- 顶部：随机选项 -->
          <div
            style="
              padding: 15px;
              border-bottom: 1px solid var(--border-color);
              background: var(--secondary-bg);
            "
          >
            <label class="toggle-switch-label" style="margin: 0">
              <span class="toggle-switch-text" style="font-weight: bold"
                >🎲 随机生成 (AI决定)</span
              >
              <input type="checkbox" id="chat-gen-random-checkbox" checked />
              <span class="toggle-switch-slider"></span>
            </label>
            <p
              style="
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 5px;
                margin-bottom: 0;
              "
            >
              关闭后可指定下方特定角色/NPC。
            </p>
          </div>

          <!-- 列表：特定角色选择 -->
          <div
            id="chat-gen-list"
            class="contact-picker-list"
            style="flex-grow: 1; opacity: 0.5; pointer-events: none"
          >
            <!-- 列表项由JS生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-chat-gen-btn">取消</button>
          <button class="save" id="confirm-chat-gen-btn">开始生成</button>
        </div>
      </div>
    </div>

    <div id="generation-overlay" class="modal">
      <button id="generation-back-btn" class="generation-back-btn" style="display: none;">← 返回</button>
      <div class="loading-content">
        <!-- 这是一个粉色的猫爪爪 -->
        <div class="cat-paw">
          <div class="pad main"></div>
          <div class="pad toe t1"></div>
          <div class="pad toe t2"></div>
          <div class="pad toe t3"></div>
        </div>
        <p id="generation-text">少女祈祷中...</p>
      </div>
    </div>

    <!-- 选择联系人以创建群聊的屏幕 -->
    <div id="contact-picker-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="cancel-contact-picker-btn">取消</span>
        <span>选择联系人</span>
        <span class="save-btn" id="confirm-contact-picker-btn">完成(0)</span>
      </div>
      <div class="list-container" id="contact-picker-list">
        <!-- 联系人列表将由JS动态生成 -->
      </div>
    </div>

    <!-- 群成员管理屏幕 -->
    <div id="member-management-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-member-management">‹</span>
        <span>群成员管理</span>
        <span style="width: 30px"></span>
      </div>
      <div class="list-container" id="member-management-list">
        <!-- 现有成员列表会在这里动态生成 -->
      </div>
      <div id="member-management-actions">
        <button id="add-existing-contact-btn">从好友列表添加</button>
        <button id="create-new-member-btn">创建群内新成员</button>
        <button id="ai-generate-members-btn">✨ AI 生成成员</button>
      </div>
    </div>

    <!-- 微博用户人设与职业设置模态框 -->
    <div id="weibo-user-settings-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>我的微博设定</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>预设方案</label>
            <div class="bubble-preset-manager">
              <!-- 复用现有样式 -->
              <select
                id="weibo-user-preset-select"
                class="form-group select"
              ></select>
              <button id="manage-weibo-user-presets-btn" class="action-btn">
                管理
              </button>
            </div>
          </div>
          <div class="form-group">
            <label for="weibo-user-profession-modal-input"
              >职业 (显示在昵称下方)</label
            >
            <input
              type="text"
              id="weibo-user-profession-modal-input"
              placeholder="例如：职业电竞选手、美妆博主"
            />
          </div>
          <div class="form-group">
            <label for="weibo-user-persona-modal-input"
              >隐藏人设 (仅供AI生成评论时参考)</label
            >
            <textarea
              id="weibo-user-persona-modal-input"
              rows="4"
              placeholder="例如：性格高冷，少与粉丝互动，只回复赞助商的评论。"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-weibo-user-settings-btn">
            取消
          </button>
          <button class="save" id="save-weibo-user-settings-btn">保存</button>
        </div>
      </div>
    </div>

    <div id="weibo-action-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span id="weibo-action-modal-title">执行操作</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="weibo-action-actor-select">选择操作者 (Actor)</label>
            <select
              id="weibo-action-actor-select"
              class="form-group select"
            ></select>
          </div>
          <div class="form-group">
            <label>选择操作类型</label>

            <div id="weibo-action-type-select" style="text-align: left">
              <label
                ><input
                  type="radio"
                  name="weibo_action_type"
                  value="post"
                  checked
                />
                发布一条新微博</label
              >
              <label
                ><input
                  type="radio"
                  name="weibo_action_type"
                  value="comment_plaza"
                />
                评论广场最新微博</label
              >

              <label
                ><input
                  type="radio"
                  name="weibo_action_type"
                  value="comment_user"
                />
                评论用户最新微博</label
              >
            </div>
          </div>
          <div class="form-group">
            <label for="weibo-action-prompt-input"
              >关于... (可选, 简要提示)</label
            >
            <textarea
              id="weibo-action-prompt-input"
              rows="2"
              placeholder="例如：今天比赛赢了很开心 or 回应最近的热搜"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-weibo-action-btn">取消</button>
          <button class="save" id="confirm-weibo-action-btn">执行</button>
        </div>
      </div>
    </div>

    <div id="char-sticker-manager-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-sticker-manager">‹</span>
        <span id="sticker-manager-title">表情包管理</span>
        <!-- 在这里添加“编辑/完成”按钮 -->
        <div class="header-actions">
          <span class="action-btn" id="edit-char-stickers-btn">编辑</span>
          <span
            class="action-btn"
            id="done-char-stickers-btn"
            style="display: none"
            >完成</span
          >
        </div>
      </div>
      <input
        type="file"
        id="char-sticker-upload-input"
        accept="image/*"
        style="display: none"
        multiple
      />
      <div
        class="modal-body"
        style="padding: 0; display: flex; flex-direction: column; flex-grow: 1"
      >
        <!-- 页签切换 -->
        <div class="frame-tabs">
          <div id="sticker-tab-exclusive" class="frame-tab active">
            专属表情
          </div>
          <div id="sticker-tab-common" class="frame-tab">通用表情</div>
        </div>

        <!-- 专属表情内容区 -->
        <div id="sticker-content-exclusive" class="frame-content active">
          <div class="sticker-panel-header" style="justify-content: flex-end">
            <div style="display: flex; gap: 10px">
              <span class="panel-btn" id="add-exclusive-sticker-btn"
                >批量添加</span
              >
              <span class="panel-btn" id="upload-exclusive-sticker-btn"
                >本地上传</span
              >
            </div>
          </div>
          <div id="exclusive-sticker-grid" class="sticker-grid"></div>
        </div>

        <!-- 通用表情内容区 -->
        <div id="sticker-content-common" class="frame-content">
          <div class="sticker-panel-header" style="justify-content: flex-end">
            <div style="display: flex; gap: 10px">
              <span class="panel-btn" id="add-common-sticker-btn"
                >批量添加</span
              >
              <span class="panel-btn" id="upload-common-sticker-btn"
                >本地上传</span
              >
            </div>
          </div>
          <div id="common-sticker-grid" class="sticker-grid"></div>
        </div>
      </div>
      <!-- 用于批量删除的操作栏 -->
      <div id="char-sticker-footer" style="display: none">
        <button id="delete-selected-char-stickers-btn">删除已选 (0)</button>
      </div>
    </div>

    <!-- 来电请求模态框 -->
    <div id="incoming-call-modal" class="modal">
      <div class="incoming-call-content">
        <img id="caller-avatar" class="caller-avatar" src="" />
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text">邀请你视频通话</div>
        <div class="incoming-call-actions">
          <div class="action-button-wrapper">
            <button
              id="decline-call-btn"
              class="call-action-btn decline"
            ></button>
            <span>拒绝</span>
          </div>
          <div class="action-button-wrapper">
            <button
              id="accept-call-btn"
              class="call-action-btn accept"
            ></button>
            <span>接听</span>
          </div>
        </div>
      </div>
    </div>

    <div id="music-search-results-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>搜索结果</span>
        </div>
        <div class="modal-body" id="search-results-list" style="padding: 0">
          <!-- 搜索结果将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="cancel-music-search-btn"
            style="width: 100%"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <div id="video-call-screen" class="screen">
      <!-- 这个 screen 同时为两种模式服务 -->

      <!-- ======================================================= -->
      <!-- 模式一：全新的【可视化】视频通话界面 -->
      <!-- ======================================================= -->
      <div id="visual-call-interface" style="display: none">
        <!-- 默认隐藏 -->
        <!-- 1. 视频背景层 (大图和小图都在这里) -->
        <div class="video-background">
          <!-- 大图容器 -->
          <div id="video-main-view" class="video-container">
            <img src="" alt="主视频画面" />
          </div>
          <!-- 小图容器 (画中画) -->
          <div id="video-pip-view" class="video-container pip">
            <img src="" alt="小窗视频画面" />
          </div>
        </div>

        <!-- 2. 顶部状态栏 -->
        <div class="video-call-top-bar">
          <button class="video-minimize-btn" onclick="minimizeVideoCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="4 14 10 14 10 20"></polyline>
              <polyline points="20 10 14 10 14 4"></polyline>
            </svg>
          </button>

          <span id="visual-call-timer">00:00</span>
        </div>

        <!-- 3. 聊天气泡显示区域 -->
        <div id="video-call-messages-visual" class="video-call-main">
          <!-- 聊天气泡会由JS动态生成在这里 -->
        </div>
        <!-- ▼▼▼ 用下面这【一整块】代码，替换掉 id="visual-call-interface" 里面那个旧的 video-call-controls 的 div ▼▼▼ -->
        <div class="video-call-controls">
          <!-- 重-roll按钮 -->
          <button
            id="reroll-call-btn"
            class="control-btn reroll-btn"
            title="重新生成"
          ></button>
          <!-- 【核心新增】发言按钮 -->
          <button
            id="user-speak-btn-visual"
            class="control-btn speak-btn"
            title="发言"
          ></button>
          <!-- 切换镜头按钮 -->
          <button
            id="switch-camera-btn"
            class="control-btn switch-camera-btn"
            title="切换镜头"
          ></button>
          <!-- 挂断按钮 -->
          <button
            id="hang-up-btn-visual"
            class="control-btn hangup-btn"
          ></button>
        </div>
        <!-- ▲▲▲ 替换结束 ▲▲▲ -->
      </div>

      <!-- ======================================================= -->

      <!-- ======================================================= -->
      <div id="text-call-interface" style="display: none">
        <!-- 默认隐藏 -->
        <div class="video-call-top-bar">
          <button class="video-minimize-btn" onclick="minimizeVideoCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="4 14 10 14 10 20"></polyline>
              <polyline points="20 10 14 10 14 4"></polyline>
            </svg>
          </button>
          <!-- ▲▲▲ -->
          <span id="call-timer">00:00</span>
        </div>
        <div class="video-call-avatar-area">
          <div id="participant-avatars-grid">
            <!-- JS会在这里动态生成头像 -->
          </div>
        </div>
        <div id="video-call-main" class="video-call-main">
          <!-- 对话内容会动态生成在这里 -->
        </div>
        <div class="video-call-controls">
          <!-- 【新增】为旧模式也加上重roll按钮 -->
          <button
            id="reroll-call-btn-text"
            class="control-btn reroll-btn"
            title="重新生成"
          ></button>
          <button id="user-speak-btn" class="control-btn speak-btn"></button>
          <button id="hang-up-btn" class="control-btn hangup-btn"></button>
          <button
            id="join-call-btn"
            class="control-btn join-btn"
            style="display: none"
          ></button>
        </div>
      </div>
    </div>

    <!-- 正在呼叫界面 -->
    <div id="outgoing-call-screen" class="screen">
      <div class="outgoing-call-content">
        <img id="outgoing-call-avatar" class="caller-avatar" src="" />
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">正在呼叫...</div>
        <div class="outgoing-call-actions">
          <button id="cancel-call-btn" class="call-action-btn decline"></button>
          <span>取消</span>
        </div>
      </div>
    </div>

    <!-- 通话记录页面 -->
    <div id="call-history-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="call-history-back-btn">‹</span>
        <span id="call-history-title">通话记录</span>
        <span style="width: 30px"></span>
        <!-- 占位符，保持标题居中 -->
      </div>
      <div
        id="call-history-list"
        class="list-container"
        style="padding: 15px; display: flex; flex-direction: column; gap: 15px"
      >
        <!-- 通话记录卡片将由JS动态生成在这里 -->
      </div>
    </div>

    <div id="chat-search-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="search-back-btn">‹</span>
        <span>查找聊天记录</span>
        <span style="width: 30px"></span>
        <!-- 占位符 -->
      </div>
      <div class="form-container" style="padding-bottom: 0">
        <!-- 搜索条件输入区 -->
        <div class="form-group">
          <label for="keyword-search-input">关键词</label>
          <input
            type="text"
            id="keyword-search-input"
            placeholder="输入要查找的关键词..."
          />
        </div>
        <div class="form-group">
          <label for="sender-search-select">人物</label>
          <select id="sender-search-select">
            <!-- 选项将由JS动态生成 -->
          </select>
        </div>
        <div class="form-group">
          <label for="date-search-input">日期</label>
          <input type="date" id="date-search-input" />
        </div>
        <button class="form-button" id="perform-search-btn">开始查找</button>

        <!-- 搜索结果显示区 -->
        <div
          id="chat-search-results-list"
          class="list-container"
          style="margin-top: 15px; padding: 0"
        >
          <!-- 搜索结果将由JS动态生成在这里 -->
        </div>
      </div>
    </div>

    <div id="lock-screen" class="screen">
      <div id="lock-clock-container">
        <div id="lock-main-time">12:00</div>
        <div id="lock-main-date">星期一, 1月1日</div>
      </div>
  <div id="unlock-hint">向上轻扫以解锁</div>
    </div>

    <div id="password-modal-overlay" class="modal">
      <div class="password-modal-content">
        <p>请输入密码</p>
        <input type="password" id="password-input-field" maxlength="20" />
        <div class="password-actions">
          <button id="password-cancel-btn">取消</button>
          <button id="password-confirm-btn">进入</button>
        </div>
      </div>
    </div>


    <div id="lovers-space-screen" class="screen">
      <!-- 头部 -->
      <div id="ls-header">
        <div class="ls-header-overlay"></div>
        <div class="ls-header-top-bar">
          <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
          <span id="ls-char-name"></span>
          <div class="header-actions">
            <span class="action-btn" id="ls-settings-btn" title="空间设置">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="3"></circle>
                <path
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                ></path>
              </svg>
            </span>
            <span class="action-btn" id="ls-change-bg-btn" title="更换背景">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
            </span>
            <span class="action-btn" id="ls-switch-char-btn">切换</span>
          </div>
        </div>
        <div class="ls-avatar-and-counter-wrapper">
          <div class="ls-header-avatars">
            <img id="ls-user-avatar" src="" />
            <span class="heart-icon">❤</span>
            <img id="ls-char-avatar" src="" />
          </div>
          <div id="ls-days-counter"></div>
        </div>
      </div>

      <div id="ls-tab-bar">
        <div
          class="ls-tab-item active"
          data-view="ls-moments-view"
          title="说说"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
            ></path>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-album-view" title="相册">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-letters-view" title="情书">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
            ></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-shares-view" title="分享">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-questions-view" title="提问">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-diary-view" title="日记">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-pomodoro-view" title="番茄钟">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-activity-view" title="今日足迹">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
      </div>

      <!-- 内容显示区域 -->
      <div id="ls-content-area">
        <div id="ls-moments-view" class="ls-view active">
          <div id="ls-moments-list"></div>
          <button id="ls-add-moment-btn" class="ls-fab-btn">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <line
                x1="12"
                y1="5"
                x2="12"
                y2="19"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
              <line
                x1="5"
                y1="12"
                x2="19"
                y2="12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>
        <div id="ls-album-view" class="ls-view">
          <div id="ls-album-list"></div>
          <button id="ls-add-album-btn" class="ls-fab-btn">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <line
                x1="12"
                y1="5"
                x2="12"
                y2="19"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
              <line
                x1="5"
                y1="12"
                x2="19"
                y2="12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div id="ls-letters-view" class="ls-view">
          <div id="ls-letters-list"></div>
          <button id="ls-add-letter-btn" class="ls-fab-btn">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <line
                x1="12"
                y1="5"
                x2="12"
                y2="19"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
              <line
                x1="5"
                y1="12"
                x2="19"
                y2="12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div id="ls-shares-view" class="ls-view">
          <div id="ls-shares-list"></div>
        </div>
        <div id="ls-questions-view" class="ls-view">
          <div id="ls-questions-list"></div>
          <button id="ls-add-question-btn" class="ls-fab-btn">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <line
                x1="12"
                y1="5"
                x2="12"
                y2="19"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
              <line
                x1="5"
                y1="12"
                x2="19"
                y2="12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div id="ls-diary-view" class="ls-view">
          <!-- 日历和心情罐子的内容将由JS动态生成在这里 -->
        </div>

        <!-- ★★★ 这就是我们为番茄钟准备的全新界面 ★★★ -->
        <div id="ls-pomodoro-view" class="ls-view">
          <!-- 番茄钟主页，显示历史记录和开始按钮 -->
          <div id="ls-pomodoro-home">
            <div id="ls-pomodoro-start-btn-container">
              <div id="ls-pomodoro-start-icon">＋</div>
              <p>开启新的专注时光</p>
            </div>
            <div id="ls-pomodoro-history-list">
              <!-- 历史记录会由JS生成在这里 -->
            </div>
          </div>
          <!-- 正在计时的界面，默认隐藏 -->
          <div id="ls-pomodoro-timer-active" style="display: none">
            <div class="pomodoro-char-avatar-container">
              <img id="pomodoro-char-avatar" src="" />
              <div id="pomodoro-char-log"></div>
            </div>
            <div class="pomodoro-timer-display">
              <div id="pomodoro-current-task"></div>
              <div id="pomodoro-time">25:00</div>
            </div>
            <button id="pomodoro-end-btn">结束专注</button>
          </div>
        </div>
        <div id="ls-activity-view" class="ls-view">
          <!-- 今日足迹的内容将由JS动态生成在这里 -->
        </div>
      </div>
    </div>

    <!-- 聊天设置弹窗 (萌系布局 - 功能整合版) -->
    <div id="chat-settings-modal" class="modal">
      <div class="modal-content moe-settings-content">
        <div class="modal-header moe-modal-header">
          <span>✨ 聊天设置 ✨</span>
        </div>

        <div class="modal-body moe-settings-body">
          <!-- ============================== -->
          <!-- 1. 基础资料卡片 -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">📝 基础资料</div>
            <div class="form-group" id="chat-name-group">
              <label>角色真名 /群聊名称(AI只认这个，修改会影响记忆)</label>
              <input type="text" id="chat-name-input" class="moe-input" />
            </div>
            <!-- 新增的备注名输入框，默认隐藏，JS里控制显示 -->
            <div
              class="form-group"
              id="chat-remark-group"
              style="display: none"
            >
              <label>备注名 (仅显示用，AI不知道)</label>
              <input
                type="text"
                id="chat-remark-input"
                class="moe-input"
                placeholder="设置一个备注..."
              />
            </div>

            <div
              class="form-group"
              id="assign-group-section"
              style="display: none"
            >
              <label for="assign-group-select">好友分组</label>
              <div class="input-with-btn-row">
                <select id="assign-group-select" class="moe-input"></select>
                <button id="manage-groups-btn" class="moe-btn-small">
                  管理
                </button>
              </div>
            </div>

            <div class="form-group" id="my-group-nickname-group">
              <label for="my-group-nickname-input">我的群昵称</label>
              <input
                type="text"
                id="my-group-nickname-input"
                class="moe-input"
              />
            </div>

            <!-- 头像区域 (并排布局) -->
            <div class="moe-grid-row">
              <!-- 对方/群头像 -->
              <div class="form-group" id="ai-avatar-group">
                <label>对方头像</label>
                <div class="avatar-upload-column">
                  <img id="ai-avatar-preview" class="preview-img" />
                  <div class="btn-stack">
                    <button
                      onclick="document.getElementById('ai-avatar-input').click()"
                      class="moe-btn-mini"
                    >
                      上传
                    </button>
                    <button
                      class="change-frame-btn moe-btn-mini"
                      data-type="ai"
                    >
                      相框
                    </button>
                    <button
                      id="manage-ai-avatar-library-btn"
                      class="moe-btn-mini"
                    >
                      图库
                    </button>
                  </div>
                  <input
                    type="file"
                    id="ai-avatar-input"
                    accept="image/*"
                    hidden
                  />
                </div>
              </div>

              <div
                class="form-group"
                id="group-avatar-group"
                style="display: none"
              >
                <label>群头像</label>
                <div class="avatar-upload-column">
                  <img id="group-avatar-preview" class="preview-img" />
                  <div class="btn-stack">
                    <button
                      onclick="document.getElementById('group-avatar-input').click()"
                      class="moe-btn-mini"
                    >
                      上传
                    </button>
                  </div>
                  <input
                    type="file"
                    id="group-avatar-input"
                    accept="image/*"
                    hidden
                  />
                </div>
              </div>

              <!-- 我的头像 -->
              <div class="form-group" id="my-avatar-group">
                <label>我的头像</label>
                <div class="avatar-upload-column">
                  <img id="my-avatar-preview" class="preview-img" />
                  <div class="btn-stack">
                    <button
                      onclick="document.getElementById('my-avatar-input').click()"
                      class="moe-btn-mini"
                    >
                      上传
                    </button>
                    <button
                      class="change-frame-btn moe-btn-mini"
                      data-type="my"
                    >
                      相框
                    </button>
                    <button id="open-persona-library-btn" class="moe-btn-mini">
                      预设
                    </button>
                  </div>
                  <input
                    type="file"
                    id="my-avatar-input"
                    accept="image/*"
                    hidden
                  />
                </div>
              </div>
            </div>

            <div class="form-group" id="couple-avatar-group">
              <div class="moe-divider"></div>
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">情侣头像模式</span>
                <input type="checkbox" id="couple-avatar-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
              <div
                id="couple-avatar-desc-container"
                style="display: none; margin-top: 10px"
              >
                <label style="font-size: 12px; color: #aaa">情侣头像描述</label>
                <input
                  type="text"
                  id="couple-avatar-description"
                  class="moe-input"
                  placeholder="例如：一只小猫在看月亮"
                />
              </div>
            </div>
          </div>

          <!-- ============================== -->
          <!-- 2. 人设与记忆卡片 -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">🧠 AI大脑与设定</div>

            <div class="form-group" id="ai-persona-group">
              <label for="ai-persona">对方人设 (Persona)</label>
              <textarea id="ai-persona" rows="3" class="moe-input"></textarea>
            </div>
            <div class="form-group" id="my-persona-group">
              <label for="my-persona">我的人设 (My Persona)</label>
              <textarea id="my-persona" rows="3" class="moe-input"></textarea>
            </div>

            <div class="form-group" id="group-members-group">
              <label>群成员设定</label>
              <div
                id="group-members-settings"
                class="moe-list-box"
                style="margin-bottom: 10px"
              ></div>
              <button id="manage-members-btn" class="moe-btn-secondary">
                👥 管理群成员
              </button>
            </div>

            <!-- ★★★ 修改点：将NPC库和表情包并排放在这里 ★★★ -->
            <div style="display: flex; gap: 10px; margin-top: 15px">
              <!-- NPC库按钮 -->
              <div id="npc-library-group" style="flex: 1">
                <button
                  id="manage-npcs-btn"
                  class="moe-btn-secondary"
                  style="margin-top: 0; width: 100%"
                >
                  🤖 NPC库
                </button>
              </div>
              <!-- 表情包按钮 -->
              <div id="char-sticker-group" style="flex: 1">
                <button
                  id="manage-char-stickers-btn"
                  class="moe-btn-secondary"
                  style="margin-top: 0; width: 100%"
                >
                  😶 表情包
                </button>
              </div>
            </div>

            <!-- 微博设定 -->
            <div class="form-group" id="weibo-profession-group">
              <div class="moe-divider"></div>
              <label>微博职业</label>
              <input
                type="text"
                id="weibo-profession-input"
                class="moe-input"
                placeholder="例如：电竞选手"
              />
            </div>
            <div class="form-group" id="weibo-instruction-group">
              <label>微博指令 (AI发微博时的行为准则)</label>
              <textarea
                id="weibo-instruction-input"
                rows="2"
                class="moe-input"
                placeholder="例如：性格高冷，少与粉丝互动"
              ></textarea>
            </div>

            <!-- 关联设定 -->
            <div class="moe-divider"></div>
            <div class="form-group" id="world-book-link-group">
              <label>关联世界书 (多选)</label>
              <div class="custom-multiselect">
                <div class="select-box moe-input">
                  <span class="selected-options-text">-- 点击选择 --</span>
                  <span class="arrow-down">▼</span>
                </div>
                <div
                  id="world-book-checkboxes-container"
                  class="checkboxes-container"
                ></div>
              </div>
            </div>

            <div class="form-group" id="memory-link-group">
              <label>记忆互通 (选择要链接的聊天)</label>
              <div class="custom-multiselect" id="memory-link-multiselect">
                <div class="select-box moe-input">
                  <span class="selected-options-text">-- 点击选择 --</span>
                  <span class="arrow-down">▼</span>
                </div>
                <div
                  id="memory-link-checkboxes-container"
                  class="checkboxes-container"
                ></div>
              </div>
              <div
                style="
                  margin-top: 8px;
                  display: flex;
                  align-items: center;
                  gap: 10px;
                  background: #f9f9f9;
                  padding: 8px;
                  border-radius: 8px;
                "
              >
                <label style="margin: 0; font-size: 13px; color: #666"
                  >互通条数:</label
                >
                <input
                  type="number"
                  id="link-memory-depth-input"
                  value="5"
                  min="1"
                  max="20"
                  class="moe-input"
                  style="width: 80px; text-align: center"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="max-memory">上下文记忆条数</label>
              <input
                type="number"
                id="max-memory"
                value="10"
                class="moe-input"
              />
            </div>

            <div class="info-tags">
              <span class="tag"
                >总消息:
                <span id="total-message-count-display">-- 条</span></span
              >
              <span class="tag"
                >token:
                <span id="context-token-count-display">-- Tokens</span></span
              >
            </div>
          </div>

          <!-- ============================== -->
          <!-- 2.5. 角色音频卡片 -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card" id="character-audio-card" style="display: none;">
            <div class="settings-section-title">🎵 角色音频</div>
            <div class="form-group">
              <label>上传角色音频</label>
              <p style="font-size: 12px; color: #888; margin: 5px 0;">
                上传音频文件或输入音频URL（如角色唱歌录音），并添加说明词。当聊天内容匹配说明词时，会自动播放对应音频。
              </p>
              <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button
                  id="upload-character-audio-btn"
                  class="moe-btn-secondary"
                  style="flex: 1;"
                >
                  📤 上传文件
                </button>
                <button
                  id="add-audio-url-btn"
                  class="moe-btn-secondary"
                  style="flex: 1;"
                >
                  🔗 添加URL
                </button>
              </div>
              <input
                type="file"
                id="character-audio-upload-input"
                accept="audio/*"
                hidden
              />
            </div>
            <div class="form-group">
              <label>音频列表</label>
              <div id="character-audio-list" class="moe-list-box" style="max-height: 300px; overflow-y: auto;">
                <p style="text-align: center; color: #888; padding: 20px; font-size: 13px;">
                  暂无音频，请先上传
                </p>
              </div>
            </div>
          </div>

          <!-- ============================== -->
          <!-- 3. 玩法模式卡片 -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">🎮 玩法与模式</div>

            <!-- 线下模式 -->
            <div class="form-group" id="offline-mode-section">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">线下模式 (Online Dating)</span>
                <input type="checkbox" id="offline-mode-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>
            <div
              id="offline-mode-details"
              class="moe-details-box"
              style="display: none"
            >
              <div class="form-group">
                <label>预设管理</label>
                <div class="input-with-btn-row">
                  <select id="offline-preset-select" class="moe-input"></select>
                  <button id="manage-offline-presets-btn" class="moe-btn-small">
                    管理
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>场景提示词 (Prompt)</label>
                <textarea
                  id="offline-prompt-input"
                  rows="3"
                  class="moe-input"
                  placeholder="例如：你正在一家安静的咖啡馆..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>文风要求 (Style)</label>
                <textarea
                  id="offline-style-input"
                  rows="2"
                  class="moe-input"
                  placeholder="例如：详细描写动作神态..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>期望字数</label>
                <input
                  type="number"
                  id="offline-word-count-input"
                  value="300"
                  class="moe-input"
                />
              </div>
              <div
                class="form-group"
                style="border-top: 1px dashed #ddd; padding-top: 10px"
              >
                <label class="toggle-switch-label" style="margin: 0">
                  <span class="toggle-switch-text" style="font-size: 13px"
                    >每轮自动生图 (NovelAI)</span
                  >
                  <input type="checkbox" id="offline-novelai-toggle" />
                  <span
                    class="toggle-switch-slider"
                    style="transform: scale(0.8)"
                  ></span>
                </label>
              </div>
            </div>

            <!-- 聊天总结 -->
            <div class="form-group">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">长期记忆总结</span>
                <input type="checkbox" id="summary-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>
            <div
              id="summary-details-container"
              class="moe-details-box"
              style="display: none"
            >
              <div class="form-group">
                <label>总结模式</label>
                <div style="display: flex; gap: 20px; margin-top: 5px">
                  <label
                    ><input
                      type="radio"
                      name="summary-mode"
                      value="auto"
                      checked
                    />
                    自动总结</label
                  >
                  <label
                    ><input type="radio" name="summary-mode" value="manual" />
                    手动总结</label
                  >
                </div>
              </div>
              <div class="form-group">
                <label>触发条数</label>
                <input
                  type="number"
                  id="summary-count-input"
                  value="20"
                  min="5"
                  class="moe-input"
                />
              </div>
              <div class="form-group">
                <label>总结提示词</label>
                <textarea
                  id="summary-prompt-input"
                  rows="3"
                  class="moe-input"
                ></textarea>
              </div>
              <div class="moe-btn-group">
                <button id="view-summaries-btn" class="moe-btn-secondary">
                  查看/管理总结
                </button>
                <button id="manual-summary-btn" class="moe-btn-secondary">
                  立即手动总结
                </button>
              </div>
            </div>

            <!-- 续火花 -->
            <div class="form-group" id="streak-settings-section">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">续火花系统</span>
                <input type="checkbox" id="streak-enabled-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
              <button
                id="open-intimacy-panel-btn"
                class="moe-btn-secondary"
                style="display: none; margin-bottom: 10px"
              >
                🏅 查看亲密关系面板
              </button>

              <div
                id="streak-details-container"
                class="moe-details-box"
                style="display: none"
              >
                <div class="moe-grid-row">
                  <div class="form-group">
                    <label>初始天数</label>
                    <input
                      type="number"
                      id="streak-initial-days-input"
                      class="moe-input"
                    />
                  </div>
                  <div class="form-group">
                    <label>熄灭规则</label>
                    <select
                      id="streak-extinguish-threshold-select"
                      class="moe-input"
                    >
                      <option value="1">1天不聊熄灭</option>
                      <option value="3">3天不聊熄灭</option>
                      <option value="7">7天不聊熄灭</option>
                      <option value="-1">永不熄灭</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label>点亮图标 URL (可选)</label>
                  <input
                    type="text"
                    id="streak-lit-icon-url"
                    class="moe-input"
                    placeholder="默认: 🔥"
                  />
                </div>
                <div class="form-group">
                  <label>熄灭图标 URL (可选)</label>
                  <input
                    type="text"
                    id="streak-extinguished-icon-url"
                    class="moe-input"
                    placeholder="默认: 🧊"
                  />
                </div>
                <div class="form-group">
                  <label>字体颜色</label>
                  <input
                    type="color"
                    id="streak-font-color-picker"
                    class="moe-input"
                    style="height: 40px; padding: 2px"
                  />
                </div>
              </div>
            </div>

            <!-- 群聊后台 -->
            <div
              class="form-group"
              id="group-background-activity-group"
              style="display: none"
            >
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">群聊后台实时活动</span>
                <input type="checkbox" id="group-background-activity-switch" />
                <span class="toggle-switch-slider"></span>
              </label>
              <div
                id="group-background-interval-settings"
                class="moe-details-box"
                style="display: none"
              >
                <label>活动间隔 (秒)</label>
                <input
                  type="number"
                  id="group-background-interval-input"
                  min="60"
                  value="120"
                  class="moe-input"
                />
              </div>
            </div>

            <div class="form-group">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">实时时间感知</span>
                <input type="checkbox" id="time-perception-toggle" checked />
                <span class="toggle-switch-slider"></span>
              </label>
              <div id="timezone-container" style="margin-top: 10px;">
                <label>时区选择</label>
                <select id="timezone-select" class="moe-input">
                  <option value="UTC-12">UTC-12 (国际日期变更线西)</option>
                  <option value="UTC-11">UTC-11 (夏威夷标准时间)</option>
                  <option value="UTC-10">UTC-10 (阿拉斯加标准时间)</option>
                  <option value="UTC-9">UTC-9 (阿拉斯加夏令时)</option>
                  <option value="UTC-8">UTC-8 (太平洋标准时间)</option>
                  <option value="UTC-7">UTC-7 (山地标准时间)</option>
                  <option value="UTC-6">UTC-6 (中部标准时间)</option>
                  <option value="UTC-5">UTC-5 (东部标准时间)</option>
                  <option value="UTC-4">UTC-4 (大西洋标准时间)</option>
                  <option value="UTC-3">UTC-3 (南美东部时间)</option>
                  <option value="UTC-2">UTC-2 (大西洋中部时间)</option>
                  <option value="UTC-1">UTC-1 (亚速尔群岛时间)</option>
                  <option value="UTC+0">UTC+0 (格林威治标准时间)</option>
                  <option value="UTC+1">UTC+1 (中欧时间)</option>
                  <option value="UTC+2">UTC+2 (东欧时间)</option>
                  <option value="UTC+3">UTC+3 (莫斯科时间)</option>
                  <option value="UTC+4">UTC+4 (海湾标准时间)</option>
                  <option value="UTC+5">UTC+5 (巴基斯坦标准时间)</option>
                  <option value="UTC+5.5">UTC+5:30 (印度标准时间)</option>
                  <option value="UTC+6">UTC+6 (孟加拉标准时间)</option>
                  <option value="UTC+7">UTC+7 (印度支那时间)</option>
                  <option value="UTC+8" selected>UTC+8 (中国标准时间/北京时间)</option>
                  <option value="UTC+9">UTC+9 (日本标准时间)</option>
                  <option value="UTC+10">UTC+10 (澳大利亚东部标准时间)</option>
                  <option value="UTC+11">UTC+11 (所罗门群岛时间)</option>
                  <option value="UTC+12">UTC+12 (新西兰标准时间)</option>
                </select>
              </div>

              <!-- 【实时天气感知】天气感知设置 -->
              <div id="weather-perception-container" style="margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="weather-perception-toggle" style="width: auto;">
                  <span>实时天气感知</span>
                </label>
                
                <div id="weather-location-settings" style="margin-top: 10px; display: none;">
                  <!-- 角色所在地区 -->
                  <div style="margin-bottom: 12px;">
                    <label style="font-size: 13px; color: #666; margin-bottom: 6px; display: block;">角色所在地区</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input 
                        type="text" 
                        id="char-location-virtual-name" 
                        placeholder="虚拟名称（如：桃源居）" 
                        class="moe-input"
                        style="flex: 1;"
                      />
                      <input 
                        type="text" 
                        id="char-location-real-city" 
                        placeholder="真实城市（英文，如：Beijing）" 
                        class="moe-input"
                        style="flex: 1;"
                      />
                      <button 
                        id="search-char-location-btn" 
                        class="moe-btn"
                        style="padding: 8px 12px; white-space: nowrap;"
                      >
                        搜索
                      </button>
                    </div>
                    <div id="char-location-result" style="font-size: 12px; color: #888; margin-top: 4px;"></div>
                  </div>

                  <!-- 用户所在地区 -->
                  <div>
                    <label style="font-size: 13px; color: #666; margin-bottom: 6px; display: block;">用户所在地区</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input 
                        type="text" 
                        id="user-location-virtual-name" 
                        placeholder="虚拟名称（如：桃源居）" 
                        class="moe-input"
                        style="flex: 1;"
                      />
                      <input 
                        type="text" 
                        id="user-location-real-city" 
                        placeholder="真实城市（英文，如：Shanghai）" 
                        class="moe-input"
                        style="flex: 1;"
                      />
                      <button 
                        id="search-user-location-btn" 
                        class="moe-btn"
                        style="padding: 8px 12px; white-space: nowrap;"
                      >
                        搜索
                      </button>
                    </div>
                    <div id="user-location-result" style="font-size: 12px; color: #888; margin-top: 4px;"></div>
                  </div>
                </div>
              </div>
              <div
                id="custom-time-container"
                style="display: none; margin-top: 5px"
              >
                <label>自定义时间</label>
                <input
                  type="datetime-local"
                  id="custom-time-input"
                  class="moe-input"
                />
              </div>
            </div>
          </div>

          <!-- ============================== -->
          <!-- 4. 语音与视频卡片 -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">📞 语音与视频</div>

            <div class="form-group" id="minimax-voice-id-group">
              <label>Minimax 语音ID</label>
              <input
                type="text"
                id="minimax-voice-id-input"
                class="moe-input"
                placeholder="例如：male-01"
              />
            </div>

            <div class="form-group" id="minimax-language-boost-group">
              <label for="minimax-language-boost-select"
                >Minimax 语言增强</label
              >
              <p
                style="
                  font-size: 12px;
                  font-weight: normal;
                  color: #999;
                  margin-top: 5px;
                  margin-bottom: 10px;
                "
              >
                增强对特定语言或方言的识别能力。通常选择“自动判断”即可。
              </p>
              <select id="minimax-language-boost-select">
                <option value="">无 (默认)</option>
                <option value="auto">自动判断</option>
                <option value="Chinese">中文普通话</option>
                <option value="Chinese,Yue">粤语</option>
                <option value="English">英语</option>
                <option value="Japanese">日语</option>
                <option value="Korean">韩语</option>
                <option value="French">法语</option>
                <option value="Spanish">西班牙语</option>
                <option value="Arabic">阿拉伯语</option>
                <option value="Russian">俄语</option>
                <option value="Portuguese">葡萄牙语</option>
                <option value="German">德语</option>
                <option value="Turkish">土耳其语</option>
                <option value="Dutch">荷兰语</option>
                <option value="Ukrainian">乌克兰语</option>
                <option value="Vietnamese">越南语</option>
                <option value="Indonesian">印尼语</option>
                <option value="Italian">意大利语</option>
                <option value="Thai">泰语</option>
                <option value="Polish">波兰语</option>
                <option value="Romanian">罗马尼亚语</option>
                <option value="Greek">希腊语</option>
                <option value_="">--- 其他 ---</option>
                <option value="Czech">捷克语</option>
                <option value="Finnish">芬兰语</option>
                <option value="Hindi">印地语</option>
                <option value="Bulgarian">保加利亚语</option>
                <option value="Danish">丹麦语</option>
                <option value="Hebrew">希伯来语</option>
                <option value="Malay">马来语</option>
                <option value="Persian">波斯语</option>
                <option value="Slovak">斯洛伐克语</option>
                <option value="Swedish">瑞典语</option>
                <option value="Croatian">克罗地亚语</option>
                <option value="Filipino">菲律宾语</option>
                <option value="Hungarian">匈牙利语</option>
                <option value="Norwegian">挪威语</option>
                <option value="Slovenian">斯洛文尼亚语</option>
                <option value="Catalan">加泰罗尼亚语</option>
                <option value="Nynorsk">新挪威语</option>
                <option value="Tamil">泰米尔语</option>
                <option value="Afrikaans">南非语</option>
              </select>
            </div>

            <div class="form-group" id="minimax-speed-group">
              <label>语音语速: <span id="minimax-speed-value">1.0</span></label>
              <input
                type="range"
                id="minimax-speed-slider"
                min="0.5"
                max="2"
                step="0.1"
                value="1.0"
                class="moe-slider"
              />
            </div>

            <div class="form-group" id="video-call-settings-group">
              <div class="moe-divider"></div>
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">可视化视频通话界面</span>
                <input type="checkbox" id="visual-video-call-switch" />
                <span class="toggle-switch-slider"></span>
              </label>

              <div
                id="video-call-image-uploads"
                class="moe-details-box"
                style="display: none"
              >
                <div class="moe-grid-row">
                  <div class="center-text">
                    <label>对方画面</label>
                    <div
                      class="video-preview-box"
                      onclick="document.getElementById('char-video-image-input').click()"
                    >
                      <img
                        id="char-video-image-preview"
                        src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
                      />
                      <span>点击上传</span>
                    </div>
                    <input
                      type="file"
                      id="char-video-image-input"
                      accept="image/*"
                      hidden
                    />
                  </div>
                  <div class="center-text">
                    <label>我的画面</label>
                    <div
                      class="video-preview-box"
                      onclick="document.getElementById('user-video-image-input').click()"
                    >
                      <img
                        id="user-video-image-preview"
                        src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
                      />
                      <span>点击上传</span>
                    </div>
                    <input
                      type="file"
                      id="user-video-image-input"
                      accept="image/*"
                      hidden
                    />
                  </div>
                </div>
              </div>

              <label class="toggle-switch-label" style="margin-top: 10px">
                <span class="toggle-switch-text">开启语音接入</span>
                <input type="checkbox" id="video-call-voice-access-switch" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>
          </div>

          <!-- ============================== -->
          <!-- 5. 视觉美化卡片 -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">🎨 视觉美化</div>

            <div class="form-group">
              <label>聊天背景</label>
              <div class="bg-upload-container">
                <div class="bg-preview-wrapper">
                  <img
                    id="bg-preview"
                    class="bg-preview-img"
                    style="width: 100px; height: 150px; border-radius: 10px"
                  />
                  <button
                    id="remove-bg-btn"
                    style="
                      position: absolute;
                      top: -5px;
                      right: -5px;
                      width: 20px;
                      height: 20px;
                      border-radius: 50%;
                      background: red;
                      color: white;
                      border: none;
                      cursor: pointer;
                    "
                  >
                    ×
                  </button>
                </div>
                <button
                  onclick="document.getElementById('bg-input').click()"
                  class="moe-btn-small"
                  style="width: auto"
                >
                  上传
                </button>
                <input type="file" id="bg-input" accept="image/*" hidden />
              </div>
            </div>

            <div class="form-group">
              <label>气泡主题</label>
              <div
                class="theme-selector"
                style="display: flex; flex-wrap: wrap; gap: 10px"
              >
                <!-- 原生单选按钮，JS会填充或保持原样 -->
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="default"
                    id="theme-default"
                  />
                  默认</label
                >
                <label
                  ><input type="radio" name="theme-select" value="pink_blue" />
                  粉蓝</label
                >
                <label
                  ><input type="radio" name="theme-select" value="blue_white" />
                  蓝白</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="purple_yellow"
                  />
                  紫黄</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="black_white"
                  />
                  黑白</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="yellow_white"
                  />
                  黄白</label
                >
                <label
                  ><input type="radio" name="theme-select" value="red_black" />
                  红黑</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="blue_yellow"
                  />
                  蓝黄</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="pink_yellow"
                  />
                  粉黄</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="pink_purple"
                  />
                  粉紫</label
                >
                <label
                  ><input type="radio" name="theme-select" value="gray_white" />
                  灰白</label
                >
                <label
                  ><input type="radio" name="theme-select" value="blue_green" />
                  蓝绿</label
                >
                <label
                  ><input type="radio" name="theme-select" value="pink_white" />
                  粉白</label
                >
                <label
                  ><input type="radio" name="theme-select" value="pink_black" />
                  粉黑</label
                >
                <label
                  ><input type="radio" name="theme-select" value="pink_green" />
                  粉绿</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="green_black"
                  />
                  绿黑</label
                >
              </div>
              <button
                id="reset-theme-btn"
                class="moe-btn-mini"
                style="width: auto; margin-top: 5px"
              >
                恢复默认主题
              </button>
            </div>

            <div class="form-group">
              <label>字体大小: <span id="font-size-value">13px</span></label>
              <input
                type="range"
                id="font-size-slider"
                min="12"
                max="20"
                step="1"
                class="moe-slider"
              />
            </div>

            <div class="form-group">
              <label>气泡样式预设</label>
              <div class="input-with-btn-row">
                <select
                  id="bubble-style-preset-select"
                  class="moe-input"
                ></select>
                <button id="manage-bubble-presets-btn" class="moe-btn-small">
                  管理
                </button>
              </div>
              <div class="moe-btn-group">
                <button id="export-bubble-preset-btn" class="moe-btn-mini">
                  导出
                </button>
                <button id="import-bubble-preset-btn" class="moe-btn-mini">
                  导入
                </button>
              </div>
              <input
                type="file"
                id="import-bubble-preset-input"
                accept=".json, .txt, .css, .docx"
                hidden
              />
            </div>

            <div class="form-group">
              <label
                >自定义CSS
                <button
                  id="reset-custom-css-btn"
                  class="moe-btn-mini"
                  style="margin-left: 5px; padding: 2px 6px"
                >
                  重置
                </button></label
              >
              <textarea
                id="custom-css-input"
                rows="4"
                class="moe-input code-area"
                placeholder="/* 在此输入自定义CSS代码 */"
              ></textarea>
            </div>

            <div class="form-group">
              <label>实时预览</label>
              <div id="settings-preview-area" class="preview-box"></div>
            </div>

            <!-- NAI出图设置 -->
            <div
              class="form-group"
              id="nai-character-settings-group"
              style="display: none"
            >
              <div class="moe-divider"></div>
              <label>NovelAI 出图 (单聊)</label>
              <div style="display: flex; gap: 15px; margin: 10px 0">
                <label
                  ><input
                    type="radio"
                    name="nai-prompt-source"
                    value="system"
                    checked
                  />
                  系统默认</label
                >
                <label
                  ><input
                    type="radio"
                    name="nai-prompt-source"
                    value="character"
                  />
                  角色专属</label
                >
              </div>
              <button id="character-nai-prompts-btn" class="moe-btn-secondary">
                配置角色专属提示词
              </button>
            </div>

            <div
              class="form-group"
              id="group-nai-settings-group"
              style="display: none"
            >
              <div class="moe-divider"></div>
              <label>NovelAI 出图 (群聊)</label>
              <div style="display: flex; gap: 15px; margin: 10px 0">
                <label
                  ><input
                    type="radio"
                    name="group-nai-prompt-source"
                    value="system"
                    checked
                  />
                  系统默认</label
                >
                <label
                  ><input
                    type="radio"
                    name="group-nai-prompt-source"
                    value="character"
                  />
                  角色专属</label
                >
              </div>
              <button
                id="group-character-nai-prompts-btn"
                class="moe-btn-secondary"
              >
                配置角色专属提示词
              </button>
            </div>

          </div>

          <!-- ============================== -->
          <!-- 5.5. 桌宠设置卡片 -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card" id="desktop-pet-settings-card" style="display: none">
            <div class="settings-section-title">🐾 桌宠设置</div>

            <!-- 桌宠开关 -->
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input
                  type="checkbox"
                  id="desktop-pet-switch"
                  style="width: 18px; height: 18px; cursor: pointer;"
                />
                <span>启用桌宠</span>
              </label>
              <small style="color: #888; font-size: 12px; display: block; margin-top: 4px;">
                开启后，小手机界面会出现该角色的桌宠，可以拖拽移动。同时只能有一个角色开启桌宠。
              </small>
            </div>

            <!-- 桌宠图片设置 -->
            <div class="form-group" id="desktop-pet-image-group">
              <label style="font-weight: 500; margin-bottom: 8px; display: block;">桌宠图片</label>
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <img id="desktop-pet-image-preview" src="" alt="桌宠预览" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color);">
                <div style="flex: 1;">
                  <div class="moe-btn-group" style="display: flex; gap: 8px;">
                    <button id="desktop-pet-upload-local-btn" class="moe-btn-secondary" style="flex: 1; font-size: 13px;">📁 本地上传</button>
                    <button id="desktop-pet-upload-url-btn" class="moe-btn-secondary" style="flex: 1; font-size: 13px;">🌐 URL上传</button>
                    <button id="desktop-pet-reset-image-btn" class="moe-btn-secondary" style="flex: 1; font-size: 13px;">🔄 恢复默认</button>
                  </div>
                  <input type="file" id="desktop-pet-upload-input" accept="image/*" hidden>
                  <input type="text" id="desktop-pet-image-url" placeholder="图片URL" style="width: 100%; margin-top: 8px; padding: 8px; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px; display: none;" hidden>
                </div>
              </div>
            </div>

            <!-- 桌宠形状选择 -->
            <div class="form-group">
              <label style="font-weight: 500; margin-bottom: 8px; display: block;">桌宠形状</label>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                  <input type="radio" name="desktop-pet-shape" value="circle" checked style="width: 16px; height: 16px; cursor: pointer;">
                  <span>⭕ 圆形</span>
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                  <input type="radio" name="desktop-pet-shape" value="diamond" style="width: 16px; height: 16px; cursor: pointer;">
                  <span>💎 菱形</span>
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                  <input type="radio" name="desktop-pet-shape" value="square" style="width: 16px; height: 16px; cursor: pointer;">
                  <span>⬜ 方形</span>
                </label>
              </div>
            </div>

            <!-- 桌宠大小设定 -->
            <div class="form-group">
              <label style="font-weight: 500; margin-bottom: 8px; display: block;">
                桌宠大小: <span id="desktop-pet-size-value">80</span>px
              </label>
              <input 
                type="range" 
                id="desktop-pet-size-slider" 
                min="40" 
                max="200" 
                value="80" 
                step="5"
                style="width: 100%;"
              >
              <small style="color: #888; font-size: 11px; display: block; margin-top: 4px;">
                范围: 40px - 200px
              </small>
            </div>

            <!-- 桌宠位置重置 -->
            <div class="form-group">
              <button id="desktop-pet-reset-position-btn" class="moe-btn-secondary" style="width: 100%; font-size: 13px;">
                🔄 重置桌宠位置
              </button>
              <small style="color: #888; font-size: 11px; display: block; margin-top: 4px;">
                将桌宠重置到屏幕中心，确保桌宠可见
              </small>
            </div>

            <!-- 桌宠小台词重新生成 -->
            <div class="form-group">
              <button id="desktop-pet-reroll-lines-btn" class="moe-btn-secondary" style="width: 100%; font-size: 13px;">
                🎲 重新生成所有小台词
              </button>
              <small style="color: #888; font-size: 11px; display: block; margin-top: 4px;">
                重新生成该角色在所有界面的点击台词（需要API配置）
              </small>
            </div>
          </div>

          <!-- ============================== -->
          <!-- 6. 数据与操作卡片 -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">💾 数据与操作</div>

            <div class="moe-btn-group">
              <button id="import-chat-history-btn" class="moe-btn-secondary">
                导入聊天记录
              </button>
              <button id="export-chat-history-btn" class="moe-btn-secondary">
                导出聊天记录
              </button>
            </div>
            <input
              type="file"
              id="import-chat-history-input"
              accept="application/json"
              hidden
            />

            <button
              id="search-chat-btn"
              class="moe-btn-secondary"
              style="margin-top: 10px"
            >
              🔍 查找聊天内容
            </button>

            <div class="moe-divider"></div>

            <div class="moe-btn-group">
              <button id="clear-chat-btn" class="moe-btn-danger">
                🧹 清空聊天
              </button>
              <button id="block-chat-btn" class="moe-btn-danger">
                🚫 拉黑对方
              </button>
            </div>
          </div>

          <!-- 底部垫高，防止被悬浮按钮遮挡 -->
          <div style="height: 80px"></div>
        </div>

        <!-- 悬浮保存按钮 (FAB) -->
        <div
          class="modal-footer"
          style="
            border: none;
            padding: 0;
            position: absolute;
            bottom: 0;
            width: 100%;
            pointer-events: none;
          "
        >
          <!-- 取消按钮放左边 -->
          <button
            id="cancel-chat-settings-btn"
            class="moe-fab-cancel"
            style="pointer-events: auto"
          >
            ❌<span style="font-size: 10px; display: block">取消</span>
          </button>

          <!-- 保存按钮放右边 -->
          <button
            id="save-chat-settings-btn"
            class="moe-fab-save"
            style="pointer-events: auto"
          >
            💾<span style="font-size: 10px; display: block">保存</span>
          </button>
        </div>
      </div>
    </div>

    <div id="persona-library-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>我的人设库</span
          ><button id="add-persona-preset-btn" class="action-button">
            添加
          </button>
        </div>
        <div class="modal-body"><div id="persona-library-grid"></div></div>
        <div class="modal-footer">
          <button class="cancel" id="close-persona-library-btn">关闭</button>
        </div>
      </div>
    </div>

    <div id="persona-editor-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span id="persona-editor-title">添加人设预设</span>
        </div>
        <div class="modal-body">
          <!-- NPC名字输入框 -->
          <div class="form-group" id="npc-editor-name-group">
            <label for="npc-editor-name-input">NPC 名字</label>
            <input type="text" id="npc-editor-name-input" />
          </div>
          <div class="form-group">
            <label>头像</label>
            <div class="avatar-upload">
              <img id="preset-avatar-preview" />
              <button
                onclick="document.getElementById('preset-avatar-input').click()"
              >
                上传头像
              </button>

              <button
                id="persona-editor-change-frame-btn"
                class="change-frame-btn"
                data-type="member"
              >
                更换头像框
              </button>
              <input type="file" id="preset-avatar-input" accept="image/*" />
            </div>
          </div>
          <div class="form-group">
            <label for="preset-persona-input">人设</label>
            <textarea
              id="preset-persona-input"
              rows="4"
              placeholder="在此输入这个人设的详细设定..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-persona-editor-btn">取消</button>
          <button class="save" id="save-persona-preset-btn">保存</button>
        </div>
      </div>
    </div>

    <div id="member-settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><span>编辑群成员</span></div>
        <div class="modal-body">
          <div class="form-group">
            <label for="member-name-input">名字</label
            ><input type="text" id="member-name-input" />
          </div>
          <div class="form-group">
            <label for="member-persona-input">人设</label
            ><textarea id="member-persona-input" rows="4"></textarea>
          </div>

          <div class="form-group">
            <label>头像</label>
            <div class="avatar-upload">
              <img id="member-avatar-preview" />
              <button
                onclick="document.getElementById('member-avatar-input').click()"
              >
                上传头像
              </button>
              <!-- 更换头像框按钮 -->
              <button
                id="member-editor-change-frame-btn"
                class="change-frame-btn"
              >
                更换头像框
              </button>
              <input
                type="file"
                id="member-avatar-input"
                accept="image/*"
                hidden
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-member-settings-btn">取消</button
          ><button class="save" id="save-member-settings-btn">保存</button>
        </div>
      </div>
    </div>

    <div id="custom-modal-overlay">
      <div id="custom-modal">
        <div class="custom-modal-header" id="custom-modal-title"></div>
        <div class="custom-modal-body" id="custom-modal-body"></div>
        <div class="custom-modal-footer">
          <button id="custom-modal-cancel">取消</button>
          <button id="custom-modal-confirm" class="confirm-btn">确定</button>
        </div>
      </div>
    </div>

    <div id="preset-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <button id="preset-action-edit">编辑预设</button>
          <button id="preset-action-delete" class="btn-danger">删除预设</button>
          <button
            id="preset-action-cancel"
            style="
              margin-top: 8px;
              border-radius: 8px;
              background-color: #f0f0f0;
            "
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <div id="transfer-modal">
      <div class="transfer-content">
        <div class="transfer-header">给Ta一个惊喜！</div>
        <div class="transfer-input-group">
          <label for="transfer-amount">转账金额</label>
          <input
            type="number"
            id="transfer-amount"
            placeholder="0.00"
            min="0"
            max="9999999999999"
            step="0.01"
          />
        </div>
        <div class="transfer-input-group">
          <label for="transfer-note">备注 (可选)</label>
          <input
            type="text"
            id="transfer-note"
            placeholder="留下你的小心思~"
            maxlength="20"
          />
        </div>
        <div class="transfer-actions">
          <button id="transfer-cancel-btn">取消</button>
          <button id="transfer-confirm-btn">确认转账</button>
        </div>
      </div>
    </div>

    <div id="battery-alert-modal">
      <div class="battery-alert-content">
        <img id="battery-alert-image" src="" />
        <p id="battery-alert-text"></p>
      </div>
    </div>

    <audio id="audio-player" style="display: none"></audio>

    <audio id="dating-bgm-player" loop></audio>

    <audio id="tts-audio-player" style="display: none"></audio>

    <audio id="ringtone-player" loop></audio>
    <audio id="notification-sound-player" preload="auto"></audio>

    <div id="create-post-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 90%">
        <div class="modal-header">
          <span id="create-post-modal-title">发布动态</span>
          <!-- 使用ID方便JS修改标题 -->
        </div>
        <div class="modal-body">
          <!-- 公开文字输入区 -->
          <div class="form-group">
            <textarea
              id="post-public-text"
              rows="3"
              placeholder="分享新鲜事..."
            ></textarea>
          </div>

          <!-- 模式切换开关 -->
          <div class="post-mode-switcher">
            <button id="switch-to-image-mode" class="mode-btn active">
              上传图片
            </button>
            <button id="switch-to-text-image-mode" class="mode-btn">
              使用文字图
            </button>
          </div>

          <!-- 图片模式区域 -->
          <div id="image-mode-content" class="post-mode-content active">
            <div class="form-group">
              <div
                id="post-image-preview-container"
                class="post-image-preview-container"
              >
                <img id="post-image-preview" src="" alt="图片预览" />
                <button id="post-remove-image-btn">×</button>
              </div>
              <div class="post-image-upload-options">
                <button
                  id="post-upload-local-btn"
                  class="form-button-secondary"
                >
                  本地上传
                </button>
                <button id="post-use-url-btn" class="form-button-secondary">
                  网络URL
                </button>
                <input
                  type="file"
                  id="post-local-image-input"
                  accept="image/*"
                  hidden
                />
              </div>
            </div>
            <!-- 这个是给AI看的图片描述，在微博模式下我们会用JS隐藏它 -->
            <div
              id="post-image-desc-group"
              class="form-group"
              style="display: none"
            >
              <label>图片描述 (必填，给AI看)</label>
              <input
                type="text"
                id="post-image-description"
                placeholder="简单描述图片内容，帮助AI理解"
              />
            </div>
          </div>

          <!-- 文字图模式区域 -->
          <div id="text-image-mode-content" class="post-mode-content">
            <div class="form-group">
              <label>文字图 (给AI理解用的描述，点击图片后可见)</label>
              <textarea
                id="post-hidden-text"
                rows="4"
                placeholder="在这里写下图片描述..."
              ></textarea>
            </div>
          </div>

          <div class="form-group" id="post-visibility-group">
            <label>可见范围</label>
            <div style="display: flex; gap: 20px; margin-bottom: 10px">
              <label
                ><input type="radio" name="visibility" value="all" checked />
                所有人可见</label
              >
              <label
                ><input type="radio" name="visibility" value="groups" />
                仅分组可见</label
              >
            </div>
            <div
              id="post-visibility-groups"
              style="
                display: none;
                max-height: 120px;
                overflow-y: auto;
                background-color: #f0f2f5;
                padding: 10px;
                border-radius: 8px;
              "
            >
              <!-- 分组的多选框会由JS动态生成在这里 -->
            </div>
          </div>

          <!-- 这个是动态功能的评论开关，在微博模式下我们会用JS隐藏它 -->
          <div
            class="form-group"
            id="post-comments-toggle-group"
            style="margin-top: 15px"
          >
            <label for="post-comments-toggle" class="toggle-switch-label">
              <span class="toggle-switch-text">允许角色看见评论区</span>
              <input type="checkbox" id="post-comments-toggle" checked />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-post-btn">取消</button>
          <button class="save" id="confirm-create-post-btn">发布</button>
        </div>
      </div>
    </div>

    <!-- NovelAI 生成设置弹窗 -->
    <div id="novelai-settings-modal" class="modal" style="display: none">
      <div
        class="modal-content"
        style="max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto"
      >
        <div class="modal-header">
          <span>NovelAI 生成设置</span>
          <span
            class="close"
            id="close-novelai-settings"
            style="
              cursor: pointer;
              float: right;
              font-size: 28px;
              font-weight: bold;
            "
            >&times;</span
          >
        </div>
        <div class="modal-body" style="padding: 20px">
          <div class="form-group">
            <label style="color: #333">图像尺寸（oplus可无限出小图）</label>
            <select
              id="nai-resolution"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            >
              <optgroup label="小">
                <option value="512x768">纵向 (512x768)</option>
                <option value="768x512">横向 (768x512)</option>
                <option value="640x640">正方形 (640x640)</option>
              </optgroup>
              <optgroup label="正常">
                <option value="832x1216">竖图 (832x1216)</option>
                <option value="1216x832">横图 (1216x832)</option>
                <option value="1024x1024" selected>方图 (1024x1024)</option>
              </optgroup>
              <optgroup label="壁纸">
                <option value="1088x1920">纵向 (1088x1920)</option>
                <option value="1920x1088">风景 (1920x1088)</option>
              </optgroup>
            </select>
            <small style="color: #666"
              >建议使用官方支持的标准尺寸以获得最佳效果</small
            >
          </div>

          <div class="form-group">
            <label style="color: #333">采样步数 (Steps)</label>
            <input
              type="number"
              id="nai-steps"
              value="28"
              min="1"
              max="50"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            />
            <small style="color: #666"
              >推荐值: 28 (值越高质量越好但耗时越长)</small
            >
          </div>

          <div class="form-group">
            <label style="color: #333">提示词相关性 (CFG Scale)</label>
            <input
              type="number"
              id="nai-cfg-scale"
              value="5"
              min="1"
              max="20"
              step="0.5"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            />
            <small style="color: #666"
              >推荐值: 5 (控制图像与提示词的相关程度)</small
            >
          </div>

          <div class="form-group">
            <label style="color: #333">采样器 (Sampler)</label>
            <select
              id="nai-sampler"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            >
              <option value="k_euler">Euler</option>
              <option value="k_euler_ancestral" selected>
                Euler Ancestral
              </option>
              <option value="k_dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
              <option value="k_dpmpp_2m">DPM++ 2M</option>
              <option value="k_dpmpp_sde">DPM++ SDE</option>
              <option value="ddim">DDIM</option>
            </select>
          </div>

          <div class="form-group">
            <label style="color: #333">随机种子 (Seed)</label>
            <input
              type="number"
              id="nai-seed"
              value="-1"
              min="-1"
              max="9999999999"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            />
            <small style="color: #666"
              >-1 表示随机，固定种子可复现相同图像</small
            >
          </div>

          <div class="form-group">
            <label style="color: #333">负面提示词预设 (UC Preset)</label>
            <select
              id="nai-uc-preset"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            >
              <option value="0">Preset 0 - Heavy</option>
              <option value="1" selected>Preset 1 - Light</option>
              <option value="2">Preset 2 - Human Focus</option>
              <option value="3">Preset 3 - None</option>
            </select>
          </div>

          <div class="form-group">
            <label style="color: #333">质量标签</label>
            <div style="display: flex; align-items: center; gap: 10px">
              <input
                type="checkbox"
                id="nai-quality-toggle"
                checked
                style="width: auto"
              />
              <span style="color: #666; font-size: 14px"
                >自动添加质量提升标签</span
              >
            </div>
          </div>

          <div class="form-group">
            <label style="color: #333">SMEA (提升细节)</label>
            <div style="display: flex; align-items: center; gap: 10px">
              <input
                type="checkbox"
                id="nai-smea"
                checked
                style="width: auto"
              />
              <span style="color: #666; font-size: 14px">启用SMEA增强</span>
            </div>
          </div>

          <div class="form-group">
            <label style="color: #333">SMEA DYN (动态优化)</label>
            <div style="display: flex; align-items: center; gap: 10px">
              <input type="checkbox" id="nai-smea-dyn" style="width: auto" />
              <span style="color: #666; font-size: 14px">启用动态SMEA</span>
            </div>
          </div>

          <div class="form-group">
            <label style="color: #333">默认正面提示词</label>
            <textarea
              id="nai-default-positive"
              rows="3"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
              "
              placeholder="masterpiece, best quality, 1girl, beautiful..."
            >
masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style</textarea
            >
            <small style="color: #666"
              >此提示词将在生成时自动使用（如果测试弹窗中未填写）</small
            >
          </div>

          <div class="form-group">
            <label style="color: #333">默认负面提示词</label>
            <textarea
              id="nai-default-negative"
              rows="3"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
              "
              placeholder="lowres, bad anatomy, bad hands, text, error..."
            >
lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry</textarea
            >
          </div>

          <div
            class="form-group"
            style="
              border-top: 1px solid #ddd;
              padding-top: 15px;
              margin-top: 15px;
            "
          >
            <label style="color: #333">🌐 CORS 代理设置</label>
            <select
              id="nai-cors-proxy"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            >
              <option value="">❌ 直连（无代理）</option>
              <option value="https://corsproxy.io/?" selected>
                ✅ corsproxy.io（推荐）
              </option>
              <option value="https://api.allorigins.win/raw?url=">
                allorigins.win
              </option>
              <option value="https://cors-anywhere.herokuapp.com/">
                cors-anywhere（需激活）
              </option>
              <option value="custom">🔧 自定义代理</option>
            </select>
            <small style="color: #e74c3c; display: block; margin-top: 8px">
              ⚠️ 本地运行会遇到CORS跨域问题，需使用代理。推荐使用 corsproxy.io
            </small>
          </div>

          <div
            id="nai-custom-proxy-group"
            class="form-group"
            style="display: none"
          >
            <label style="color: #333">自定义代理地址</label>
            <input
              type="text"
              id="nai-custom-proxy-url"
              placeholder="https://your-proxy.com/?"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            />
            <small style="color: #666"
              >代理URL应以 / 或 ? 结尾，例如：https://proxy.com/?</small
            >
          </div>
        </div>
        <div class="modal-footer">
          <button
            id="reset-nai-settings-btn"
            class="form-button form-button-secondary"
            style="margin-right: 10px"
          >
            恢复默认
          </button>
          <button
            id="save-nai-settings-btn"
            class="form-button form-button-secondary"
          >
            保存设置
          </button>
        </div>
      </div>
    </div>

    <!-- NovelAI 测试生成弹窗 -->
    <div id="novelai-test-modal" class="modal" style="display: none">
      <div
        class="modal-content"
        style="max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto"
      >
        <div class="modal-header">
          <span>🖼️ NovelAI 测试生成</span>
          <span
            class="close"
            id="close-novelai-test"
            style="
              cursor: pointer;
              float: right;
              font-size: 28px;
              font-weight: bold;
            "
            >&times;</span
          >
        </div>
        <div class="modal-body" style="padding: 20px">
          <div class="form-group">
            <label style="color: #333"
              >正面提示词（此处提示词仅用于该弹窗测试）</label
            >
            <textarea
              id="nai-test-prompt"
              rows="4"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 10px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
              "
              placeholder="1girl, solo, long hair, blue eyes, smile..."
            >
1girl, solo, long hair, blue eyes, smile, outdoors, cherry blossoms, spring</textarea
            >
          </div>

          <div class="form-group">
            <label style="color: #333">负面提示词（可选，留空使用默认）</label>
            <textarea
              id="nai-test-negative"
              rows="3"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 10px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
              "
              placeholder="留空将使用设置中的默认负面提示词"
            ></textarea>
          </div>

          <div style="text-align: center; margin: 20px 0">
            <button
              id="nai-generate-btn"
              style="
                background-color: #007bff;
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                font-weight: bold;
              "
            >
              生成图像
            </button>
          </div>

          <div
            id="nai-test-status"
            style="
              text-align: center;
              color: #666;
              margin: 15px 0;
              display: none;
            "
          >
            正在生成中，请稍候...
          </div>

          <div id="nai-test-result" style="display: none; margin-top: 20px">
            <div style="font-weight: bold; color: #333; margin-bottom: 10px">
              生成结果：
            </div>
            <div
              style="
                text-align: center;
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                border: 1px solid #e9ecef;
              "
            >
              <img
                id="nai-result-image"
                style="
                  max-width: 100%;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                "
              />
            </div>
            <div style="margin-top: 10px; text-align: center">
              <button
                id="nai-download-btn"
                class="form-button-secondary"
                style="margin: 0"
              >
                下载图像
              </button>
            </div>
          </div>

          <div
            id="nai-test-error"
            style="
              display: none;
              margin-top: 15px;
              padding: 12px;
              background: #f8d7da;
              color: #721c24;
              border-radius: 6px;
              border: 1px solid #f5c6cb;
            "
          ></div>
        </div>
        <div class="modal-footer">
          <button id="close-nai-test-btn" class="form-button">关闭</button>
        </div>
      </div>
    </div>

    <!-- 角色专属NAI出图设置弹窗 -->
    <div id="character-nai-prompts-modal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <span>角色专属NAI提示词配置</span>
          <span
            class="close"
            id="close-character-nai-prompts"
            style="
              cursor: pointer;
              float: right;
              font-size: 28px;
              font-weight: bold;
            "
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <p
            style="
              font-size: 13px;
              color: #666;
              margin-bottom: 20px;
              background-color: #f0f8ff;
              padding: 12px;
              border-radius: 6px;
              border-left: 3px solid #007bff;
            "
          >
            💡 这里配置的提示词仅用于当前角色的NAI出图，不影响其他角色或系统设置
          </p>

          <div class="form-group">
            <label
              for="character-nai-positive"
              style="color: #333; font-weight: 600"
            >
              正面提示词 (Positive Prompt)
            </label>
            <textarea
              id="character-nai-positive"
              rows="4"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 10px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
                font-size: 13px;
              "
              placeholder="例如: masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style"
            ></textarea>
            <small
              style="
                display: block;
                color: #666;
                font-size: 12px;
                margin-top: 5px;
              "
            >
              描述你希望生成的图像风格，可填入画师串
            </small>
          </div>

          <div class="form-group">
            <label
              for="character-nai-negative"
              style="color: #333; font-weight: 600"
            >
              负面提示词 (Negative Prompt)
            </label>
            <textarea
              id="character-nai-negative"
              rows="4"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 10px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
                font-size: 13px;
              "
              placeholder="例如: lowres, bad anatomy, bad hands, text, error, missing fingers"
            ></textarea>
            <small
              style="
                display: block;
                color: #666;
                font-size: 12px;
                margin-top: 5px;
              "
            >
              描述你希望避免的元素
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button
            id="reset-character-nai-prompts-btn"
            class="form-button form-button-secondary"
            style="margin-right: 10px"
          >
            清空配置
          </button>
          <button
            id="save-character-nai-prompts-btn"
            class="form-button form-button-secondary"
          >
            保存
          </button>
        </div>
      </div>
    </div>

    <div id="group-management-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>管理好友分组</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>新建分组</label>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="new-group-name-input"
                placeholder="输入分组名..."
                style="flex-grow: 1"
              />
              <button
                id="add-new-group-btn"
                class="form-button"
                style="width: auto; margin-top: 0; padding: 0 15px"
              >
                添加
              </button>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <div
            id="existing-groups-list"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <!-- 分组列表将由JS动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="close-group-manager-btn" style="width: 100%">
            完成
          </button>
        </div>
      </div>
    </div>

    <div id="message-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <!-- 新的操作按钮 -->
          <button
            id="reroll-nai-btn"
            style="display: none; background-color: #e3f2fd; color: #1976d2"
          >
            🎨 重绘图片
          </button>
          <!-- 新增这行 -->
          <button id="edit-message-btn">编辑消息</button>
          <button id="copy-message-btn">复制文本</button>
          <button id="delete-message-btn" style="color: #ff3b30; font-weight: 600;">🗑️ 删除</button>
          <button id="recall-message-btn">撤回</button>
          <button id="quote-message-btn">引用</button>
          <button id="select-message-btn">进入多选</button>
          <!-- 取消按钮 -->
          <button
            id="cancel-message-action-btn"
            style="
              margin-top: 8px;
              border-radius: 8px;
              background-color: #f0f0f0;
            "
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <div id="post-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <button id="edit-post-btn">编辑动态</button>
          <button id="copy-post-btn">复制内容</button>
          <button id="cancel-post-action-btn">取消</button>
        </div>
      </div>
    </div>

    <!-- 可视化消息编辑器模态框 -->
    <div id="message-editor-modal" class="modal">
      <div class="modal-content" style="height: 75%">
        <div class="modal-header">
          <span>编辑与拆分消息</span>
        </div>
        <div class="modal-body" id="message-editor-body">
          <!-- 编辑器容器，JS会在这里动态生成文本框 -->
          <div id="message-editor-container"></div>
          <!-- 添加新消息的按钮 -->
          <button
            id="add-message-editor-block-btn"
            class="form-button form-button-secondary"
            style="margin-top: 15px"
          >
            [+] 添加下一条消息
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-advanced-editor-btn">取消</button>
          <button class="save" id="save-advanced-editor-btn">保存更改</button>
        </div>
      </div>
    </div>

    <!-- 【全新】外卖请求模态框 -->
    <div id="waimai-request-modal" class="modal">
      <div class="modal-content" style="width: 290px">
        <div class="modal-header">
          <span>发起外卖代付</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="waimai-product-info">商品信息</label>
            <input
              type="text"
              id="waimai-product-info"
              placeholder="例如：一杯杨枝甘露"
            />
          </div>
          <div class="form-group">
            <label for="waimai-amount">代付金额 (元)</label>
            <input
              type="number"
              id="waimai-amount"
              placeholder="例如：21"
              min="0"
              step="0.01"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="waimai-cancel-btn">取消</button>
          <button class="save" id="waimai-confirm-btn">发起请求</button>
        </div>
      </div>
    </div>

    <!-- 新建约定/倒计时模态框 -->
    <div id="create-countdown-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>新建约定</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="countdown-title-input">约定标题</label>
            <input
              type="text"
              id="countdown-title-input"
              placeholder="例如：我的生日"
            />
          </div>
          <div class="form-group">
            <label for="countdown-date-input">约定日期与时间</label>
            <input
              type="datetime-local"
              id="countdown-date-input"
              style="
                width: 95%;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
              "
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-countdown-btn">取消</button>
          <button class="save" id="confirm-create-countdown-btn">
            保存约定
          </button>
        </div>
      </div>
    </div>

    <!-- 【全新】发红包模态框 -->
    <div id="red-packet-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>发红包</span>
        </div>
        <div class="modal-body" style="padding: 0">
          <!-- 1. 页签切换 -->
          <div class="frame-tabs">
            <div id="rp-tab-group" class="frame-tab active">拼手气红包</div>
            <div id="rp-tab-direct" class="frame-tab">专属红包</div>
          </div>

          <!-- 2. 拼手气红包内容区 -->
          <div
            id="rp-content-group"
            class="frame-content"
            style="padding: 20px 15px"
          >
            <div class="form-group">
              <label>总金额 (元)</label>
              <input type="number" id="rp-group-amount" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>红包个数</label>
              <input
                type="number"
                id="rp-group-count"
                placeholder="填写红包个数"
              />
            </div>
            <div class="form-group">
              <label>祝福语</label>
              <input
                type="text"
                id="rp-group-greeting"
                placeholder="恭喜发财，大吉大利！"
              />
            </div>
            <p
              id="rp-group-total"
              style="
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                margin: 10px 0;
              "
            >
              ¥ 0.00
            </p>
            <button id="send-group-packet-btn" class="form-button">
              塞钱进红包
            </button>
          </div>

          <!-- 3. 专属红包内容区 -->
          <div
            id="rp-content-direct"
            class="frame-content"
            style="display: none; padding: 20px 15px"
          >
            <div class="form-group">
              <label>发送给</label>
              <select id="rp-direct-receiver"></select>
            </div>
            <div class="form-group">
              <label>金额 (元)</label>
              <input type="number" id="rp-direct-amount" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>祝福语</label>
              <input
                type="text"
                id="rp-direct-greeting"
                placeholder="恭喜发财，大吉大利！"
              />
            </div>
            <p
              id="rp-direct-total"
              style="
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                margin: 10px 0;
              "
            >
              ¥ 0.00
            </p>
            <button id="send-direct-packet-btn" class="form-button">
              塞钱进红包
            </button>
          </div>
        </div>
        <div class="modal-footer" style="justify-content: center">
          <button class="cancel" id="cancel-red-packet-btn" style="width: 100%">
            取消
          </button>
        </div>
      </div>
    </div>

    <!--【全新】红包详情模态框 -->
    <div id="red-packet-details-modal" class="modal">
      <div
        class="modal-content"
        style="width: 280px; height: auto; background-color: #f7f7f7"
      >
        <div
          class="modal-header"
          style="
            background-color: #f96259;
            color: white;
            border-bottom: none;
            padding-bottom: 5px;
          "
        >
          <div style="text-align: center; width: 100%">
            <div id="rp-details-sender" style="font-size: 16px"></div>
            <div style="font-size: 13px; opacity: 0.8">的红包</div>
          </div>
        </div>
        <div class="modal-body" style="padding: 15px">
          <p
            id="rp-details-greeting"
            style="
              text-align: center;
              font-size: 20px;
              color: #333;
              margin: 0 0 20px 0;
            "
          ></p>
          <div
            id="rp-details-my-amount"
            style="text-align: center; display: none; margin-bottom: 20px"
          >
            <span style="font-size: 40px; font-weight: bold; color: #e44d44"
              >0.00</span
            >
            <span style="font-size: 18px; color: #e44d44">元</span>
          </div>
          <div
            id="rp-details-summary"
            style="
              font-size: 13px;
              color: #8a8a8a;
              border-top: 1px solid #e0e0e0;
              padding-top: 10px;
            "
          ></div>
          <div
            id="rp-details-list"
            style="max-height: 150px; overflow-y: auto; margin-top: 10px"
          >
            <!-- 领取详情将由JS动态生成在这里 -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="close-rp-details-btn" style="width: 100%">
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 创建投票模态框 -->
    <div id="create-poll-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>发起投票</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="poll-question-input">投票问题</label>
            <textarea
              id="poll-question-input"
              rows="2"
              placeholder="例如：今晚我们看什么电影？"
            ></textarea>
          </div>
          <div class="form-group">
            <label>投票选项 (至少2项)</label>
            <div
              id="poll-options-container"
              style="display: flex; flex-direction: column; gap: 8px"
            >
              <!-- 投票选项将由JS动态生成在这里 -->
            </div>
            <button
              id="add-poll-option-btn"
              class="form-button form-button-secondary"
              style="margin-top: 12px"
            >
              + 添加选项
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-poll-btn">取消</button>
          <button class="save" id="confirm-create-poll-btn">发起投票</button>
        </div>
      </div>
    </div>

    <!-- AI头像库管理模态框 -->
    <div id="ai-avatar-library-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="ai-avatar-library-title">对方的头像库</span>
          <button id="add-ai-avatar-btn" class="action-button">添加</button>
        </div>
        <div class="modal-body" style="padding: 15px">
          <div
            id="ai-avatar-library-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
              gap: 15px;
            "
          >
            <!-- 头像库内容将由JS动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-ai-avatar-library-btn"
            style="width: 100%"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 用户分享链接模态框 -->
    <div id="share-link-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>分享链接</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="link-title-input">标题</label>
            <input
              type="text"
              id="link-title-input"
              placeholder="输入文章或链接的标题"
            />
          </div>
          <div class="form-group">
            <label for="link-description-input">摘要 (可选)</label>
            <textarea
              id="link-description-input"
              rows="2"
              placeholder="简单描述一下链接内容"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="link-source-input">来源名称 (可选)</label>
            <input
              type="text"
              id="link-source-input"
              placeholder="例如：知乎日报、B站"
            />
          </div>
          <div class="form-group">
            <label for="link-content-input"
              >完整内容 (可选，用于浏览器内显示)</label
            >
            <textarea
              id="link-content-input"
              rows="4"
              placeholder="粘贴或输入完整的文章内容"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-share-link-btn">取消</button>
          <button class="save" id="confirm-share-link-btn">分享</button>
        </div>
      </div>
    </div>

    <!-- 转账操作弹窗 -->
    <div id="transfer-actions-modal" class="modal">
      <div class="transfer-actions-content">
        <div class="transfer-actions-header">请选择操作</div>
        <div class="transfer-actions-body">
          <p>
            你收到了来自
            <strong id="transfer-sender-name"></strong> 的一笔转账。
          </p>
        </div>
        <div class="transfer-actions-footer">
          <button id="transfer-action-decline" class="action-btn decline">
            残忍拒绝
          </button>
          <button id="transfer-action-accept" class="action-btn accept">
            开心收下
          </button>
        </div>
        <button id="transfer-action-cancel" class="cancel-btn">×</button>
      </div>
    </div>

    <!-- 通话记录详情模态框 -->
    <div id="call-transcript-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="transcript-modal-title">通话详情</span>
        </div>
        <div
          class="modal-body"
          id="transcript-modal-body"
          style="background-color: #f0f2f5"
        >
          <!-- 通话文字记录将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="delete-transcript-btn"
            style="
              background-color: #ff3b30;
              color: white;
              border-color: #ff3b30;
            "
          >
            删除记录
          </button>
          <button
            class="save"
            id="close-transcript-modal-btn"
            style="width: 100%"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 分享目标选择器模态框 -->
    <div id="share-target-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="share-target-modal-title">分享到...</span>
        </div>
        <div class="modal-body" id="share-target-list" style="padding: 0">
          <!-- 聊天列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-share-target-btn">取消</button>
          <button class="save" id="confirm-share-target-btn">确认分享</button>
        </div>
      </div>
    </div>

    <!-- 分享记录查看器模态框 -->
    <div id="shared-history-viewer-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span id="shared-history-viewer-title">聊天记录</span>
        </div>
        <div
          class="modal-body"
          id="shared-history-viewer-content"
          style="background-color: #f0f2f5"
        >
          <!-- 分享的聊天记录气泡将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-shared-history-viewer-btn"
            style="width: 100%"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 世界书分类管理模态框 -->
    <div id="world-book-category-manager-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>管理世界书分类</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>新建分类</label>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="new-category-name-input"
                placeholder="输入分类名..."
                style="flex-grow: 1"
              />
              <button
                id="add-new-category-btn"
                class="form-button"
                style="width: auto; margin-top: 0; padding: 0 15px"
              >
                添加
              </button>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <div
            id="existing-categories-list"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <!-- 分类列表将由JS动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-category-manager-btn"
            style="width: 100%"
          >
            完成
          </button>
        </div>
      </div>
    </div>

    <!-- 角色专属NPC库管理界面 -->
    <div id="npc-management-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-npc-management">‹</span>
        <span id="npc-management-title">NPC 库管理</span>
        <span class="action-btn" id="add-new-npc-btn">+</span>
      </div>
      <div class="list-container" id="npc-management-list">
        <!-- NPC列表将由JS动态生成在这里 -->
      </div>
    </div>

    <!-- 日历app屏幕 -->
    <div id="calendar-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span id="calendar-header-title">日历</span>
        <span class="action-btn" id="calendar-today-btn" title="今天">今天</span>
      </div>
      <div style="display: flex; flex-direction: column; height: calc(100% - 60px); overflow-y: auto;">
        <!-- 上半部分：日历 -->
        <div style="flex: 0 0 auto; padding: 20px; border-bottom: 1px solid var(--border-color);">
          <!-- 月份导航 -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <span id="calendar-prev-month" style="font-size: 24px; cursor: pointer; color: var(--text-primary); user-select: none;">◀</span>
            <h2 id="calendar-month-year" style="margin: 0; font-size: 20px; font-weight: 600;"></h2>
            <span id="calendar-next-month" style="font-size: 24px; cursor: pointer; color: var(--text-primary); user-select: none;">▶</span>
          </div>
          
          <!-- 星期标题 -->
          <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">
            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 8px;">日</div>
            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 8px;">一</div>
            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 8px;">二</div>
            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 8px;">三</div>
            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 8px;">四</div>
            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 8px;">五</div>
            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 8px;">六</div>
          </div>
          
          <!-- 日历网格 -->
          <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
            <!-- 日历日期将由JS动态生成 -->
          </div>
        </div>

        <!-- 下半部分：当日信息 -->
        <div style="flex: 0 0 auto; padding: 20px;">
          <div id="calendar-day-info" style="display: none;">
            <h3 id="calendar-selected-date" style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;"></h3>
            
            <!-- 标签切换 -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color);">
              <button id="calendar-tab-events" class="calendar-tab-btn active" style="padding: 10px 20px; border: none; background: transparent; border-bottom: 2px solid var(--accent-color); color: var(--accent-color); font-weight: 600; cursor: pointer;">行程</button>
              <button id="calendar-tab-todos" class="calendar-tab-btn" style="padding: 10px 20px; border: none; background: transparent; border-bottom: 2px solid transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer;">待办事项</button>
            </div>

            <!-- 行程内容 -->
            <div id="calendar-events-content" class="calendar-tab-content">
              <div style="margin-bottom: 15px;">
                <h4 style="margin: 0; font-size: 16px; font-weight: 600;">今日行程</h4>
              </div>
              <div id="calendar-events-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- 行程列表将由JS动态生成 -->
              </div>
            </div>

            <!-- 待办事项内容 -->
            <div id="calendar-todos-content" class="calendar-tab-content" style="display: none;">
              <div style="margin-bottom: 15px;">
                <h4 style="margin: 0; font-size: 16px; font-weight: 600;">待办事项</h4>
              </div>
              <div id="calendar-todos-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- 待办事项列表将由JS动态生成 -->
              </div>
            </div>
          </div>

          <div id="calendar-no-selection" style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
            <p>请点击日历中的日期查看详细信息</p>
          </div>
        </div>
      </div>
      
      <!-- 右下角漂浮气泡添加按钮 -->
      <div id="calendar-floating-add-btn" style="position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--accent-color); color: white; display: none; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 1000; transition: transform 0.2s, box-shadow 0.2s; user-select: none;">+</div>
    </div>

    <!-- 添加行程模态框 -->
    <div id="calendar-add-event-modal" class="modal">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <span>添加行程</span>
          <span class="modal-close" id="calendar-close-event-modal">×</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>日期</label>
            <input type="date" id="calendar-event-date" class="moe-input" required>
          </div>
          <div class="form-group">
            <label>开始时间</label>
            <input type="time" id="calendar-event-start-time" class="moe-input" required>
          </div>
          <div class="form-group">
            <label>结束时间（可选）</label>
            <input type="time" id="calendar-event-end-time" class="moe-input">
          </div>
          <div class="form-group">
            <label>行程内容</label>
            <textarea id="calendar-event-content" class="moe-input" rows="3" placeholder="请输入行程内容..." required></textarea>
          </div>
          <div class="form-group">
            <label style="display: flex; justify-content: space-between; align-items: center;">
              <span>分类</span>
              <button type="button" id="calendar-manage-categories-btn" class="moe-btn" style="padding: 4px 8px; font-size: 12px; border-radius: 12px;">管理分类</button>
            </label>
            <select id="calendar-event-category" class="moe-input">
              <option value="">无分类</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="moe-btn form-button-secondary" id="calendar-cancel-event-btn">取消</button>
          <button class="moe-btn" id="calendar-save-event-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 添加待办事项模态框 -->
    <div id="calendar-add-todo-modal" class="modal">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <span>添加待办事项</span>
          <span class="modal-close" id="calendar-close-todo-modal">×</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>日期</label>
            <input type="date" id="calendar-todo-date" class="moe-input" required>
          </div>
          <div class="form-group">
            <label>待办内容</label>
            <textarea id="calendar-todo-content" class="moe-input" rows="3" placeholder="请输入待办事项..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="moe-btn form-button-secondary" id="calendar-cancel-todo-btn">取消</button>
          <button class="moe-btn" id="calendar-save-todo-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 分类管理模态框 -->
    <div id="calendar-categories-modal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <span>管理分类</span>
          <span class="modal-close" id="calendar-close-categories-modal">×</span>
        </div>
        <div class="modal-body">
          <div style="margin-bottom: 20px;">
            <button id="calendar-add-category-btn" class="moe-btn" style="width: 100%; margin-bottom: 15px;">+ 添加新分类</button>
            <div id="calendar-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
              <!-- 分类列表将由JS动态生成 -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="moe-btn" id="calendar-close-categories-btn">完成</button>
        </div>
      </div>
    </div>

    <!-- 添加/编辑分类模态框 -->
    <div id="calendar-category-edit-modal" class="modal">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <span id="calendar-category-edit-title">添加分类</span>
          <span class="modal-close" id="calendar-close-category-edit-modal">×</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>分类名称</label>
            <input type="text" id="calendar-category-name" class="moe-input" placeholder="请输入分类名称" required>
          </div>
          <div class="form-group">
            <label>颜色</label>
            <input type="color" id="calendar-category-color" class="moe-input" value="#4CAF50" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="moe-btn form-button-secondary" id="calendar-cancel-category-edit-btn">取消</button>
          <button class="moe-btn" id="calendar-save-category-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 添加/编辑月经记录模态框 -->
    <div id="calendar-add-period-modal" class="modal">
      <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
          <span id="calendar-period-modal-title">添加月经记录</span>
          <span class="modal-close" id="calendar-close-period-modal">×</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>选择日期范围（仅限当月）</label>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
              <input type="date" id="calendar-period-start-date" class="moe-input" required>
              <span>至</span>
              <input type="date" id="calendar-period-end-date" class="moe-input">
            </div>
            <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">留空结束日期则为单日记录。每个日期可以单独设置经量和疼痛程度。</p>
          </div>
          <div id="calendar-period-dates-list" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
            <!-- 日期列表将由JS动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="moe-btn form-button-secondary" id="calendar-cancel-period-btn">取消</button>
          <button class="moe-btn" id="calendar-save-period-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 添加类型选择菜单 -->
    <div id="calendar-add-type-menu" class="modal" style="background: transparent; box-shadow: none;">
      <div style="position: fixed; bottom: 150px; right: 20px; background: white; border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); min-width: 150px; z-index: 1001;">
        <div id="calendar-menu-add-event" style="padding: 12px; cursor: pointer; border-radius: 8px; transition: background-color 0.2s;">
          <span>📅 添加行程</span>
        </div>
        <div id="calendar-menu-add-todo" style="padding: 12px; cursor: pointer; border-radius: 8px; transition: background-color 0.2s;">
          <span>✅ 添加待办</span>
        </div>
        <div id="calendar-menu-add-period" style="padding: 12px; cursor: pointer; border-radius: 8px; transition: background-color 0.2s;">
          <span>🌸 添加月经记录</span>
        </div>
      </div>
    </div>

    <!-- 1. 论坛主屏幕 (显示所有小组) -->
    <div id="forum-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>圈子</span>
        <div class="header-actions">
          <span
            class="action-btn filter-btn"
            id="forum-filter-btn"
            title="筛选"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon
                points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"
              ></polygon>
            </svg>
          </span>

          <span
            class="action-btn"
            id="create-group-btn"
            style="font-size: 28px; font-weight: 300"
            >+</span
          >
        </div>
      </div>
      <div
        id="forum-group-list"
        class="list-container"
        style="
          padding: 15px;
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          align-content: start;
        "
      >
        <!-- 小组列表将由JS动态生成在这里 -->
      </div>
    </div>

    <div id="group-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-to-forum-list">‹</span>
        <span id="group-screen-title">小组名称</span>
        <div class="header-actions">
          <span
            class="action-btn filter-btn"
            id="group-filter-btn"
            title="筛选"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon
                points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"
              ></polygon>
            </svg>
          </span>

          <span
            class="action-btn"
            id="generate-group-content-btn"
            title="生成内容"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
            </svg>
          </span>
          <span
            class="action-btn"
            id="create-forum-post-btn"
            style="font-size: 28px; font-weight: 300"
            >+</span
          >
        </div>
      </div>
      <!-- 同人文创作控制台 (无按钮版) -->
      <div id="fanfic-preference-bar" style="display: none">
        <!-- 1. 顶部标题栏 -->
        <div id="fanfic-bar-header">
          <span class="bar-title">🪄 同人创作控制台</span>
          <span id="fanfic-bar-toggle-icon">▼</span>
        </div>

        <!-- 2. 可折叠的内容区域 -->
        <div id="fanfic-bar-content">
          <!-- 预设管理 -->
          <div class="fanfic-row presets-row">
            <select id="fanfic-preset-select">
              <option value="">-- 读取配置 --</option>
            </select>
            <button id="save-fanfic-preset-btn" class="mini-btn">保存</button>
            <button id="delete-fanfic-preset-btn" class="mini-btn danger">
              删除
            </button>
          </div>

          <!-- CP 选择 -->
          <div class="fanfic-row cp-row">
            <select id="fanfic-char1-select"></select>
            <span class="cp-symbol">×</span>
            <select id="fanfic-char2-select"></select>
          </div>

          <!-- 核心参数 -->
          <div class="fanfic-row params-row">
            <div class="input-group">
              <label>期望字数</label>
              <input
                type="text"
                id="fanfic-wordcount-input"
                placeholder="例: 3000字"
              />
            </div>
            <div class="input-group">
              <label>文章类型</label>
              <input
                type="text"
                id="fanfic-type-input"
                placeholder="例: 甜文/ABO"
              />
            </div>
          </div>

          <!-- 写作规范 -->
          <div class="fanfic-row full-width">
            <label>文风 / 写作规范</label>
            <input
              type="text"
              id="fanfic-style-input"
              placeholder="例: 心理描写细腻，第一人称..."
            />
          </div>

          <!-- 世界观 -->
          <div class="fanfic-row full-width">
            <label>世界观 / 剧情梗概</label>
            <textarea
              id="fanfic-worldview-input"
              rows="2"
              placeholder="在这里输入背景设定..."
            ></textarea>
          </div>
        </div>
      </div>

      <div id="group-post-list" class="list-container" style="padding-top: 0">
        <!-- 帖子列表将由JS动态生成在这里 -->
      </div>
    </div>

    <!-- 3. 单个帖子页面 (显示帖子内容和评论) -->
    <div id="post-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-to-group-screen">‹</span>
        <span>帖子详情</span>
        <div class="header-actions">
          <span class="action-btn" id="repost-to-chat-btn">转载</span>
        </div>
      </div>
      <div
        id="post-detail-content"
        class="list-container"
        style="padding: 20px"
      >
        <!-- 帖子和评论将由JS动态生成在这里 -->
      </div>
      <!-- 帖子页的评论输入框 -->
      <div
        id="post-comment-input-area"
        class="chat-input-area"
        style="visibility: visible"
      >
        <div class="chat-input-main-row">
          <textarea
            id="post-comment-input"
            rows="1"
            placeholder="发布你的评论..."
          ></textarea>
          <button id="send-post-comment-btn" class="action-button">发送</button>
        </div>
      </div>
    </div>

    <div id="forum-filter-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 60%">
        <div class="modal-header">
          <span>按分类筛选</span>
        </div>
        <div class="modal-body">
          <div id="forum-filter-category-list">
            <!-- 分类标签将由JS动态生成在这里 -->
          </div>
        </div>
        <div class="modal-footer" style="justify-content: space-between">
          <button class="cancel" id="reset-forum-filter-btn" style="width: 30%">
            重置
          </button>
          <button
            class="cancel"
            id="cancel-forum-filter-btn"
            style="width: 30%"
          >
            取消
          </button>
          <button class="save" id="apply-forum-filter-btn" style="width: 30%">
            应用
          </button>
        </div>
      </div>
    </div>

    <!-- 自定义头像框管理模态框 -->
    <div id="custom-frame-manager-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>管理我的头像框</span>
          <button id="upload-custom-frame-btn" class="action-button">
            上传
          </button>
        </div>
        <div class="modal-body" style="padding: 15px">
          <div
            id="custom-frame-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
              gap: 15px;
            "
          >
            <!-- 自定义头像框将由JS动态生成在这里 -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="close-frame-manager-btn" style="width: 100%">
            关闭
          </button>
        </div>
      </div>
    </div>
    <input
      type="file"
      id="custom-frame-upload-input"
      accept="image/png, image/gif"
      hidden
      multiple
    />

    <!-- 头像框选择模态框 -->
    <div id="avatar-frame-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>选择头像框</span>

          <button id="manage-custom-frames-btn" class="action-button">
            管理
          </button>
        </div>
        <div class="modal-body" style="padding: 15px">
          <div id="avatar-frame-grid" class="frame-grid">
            <!-- 头像框选项（包括“无”和自定义的）会在这里生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-frame-settings-btn">取消</button>
          <button class="save" id="save-frame-settings-btn">保存</button>
        </div>
      </div>
    </div>

    <div id="send-location-modal" class="modal">
      <div
        class="modal-content"
        style="width: 300px; height: auto; max-height: 80%"
      >
        <div class="modal-header">
          <span>发送定位与轨迹</span>
        </div>
        <div class="modal-body" style="padding-bottom: 5px">
          <!-- 核心信息 -->
          <div class="form-group">
            <label for="user-location-input">我的位置 (起点)</label>
            <input
              type="text"
              id="user-location-input"
              placeholder="例如：市中心的咖啡馆"
            />
          </div>
          <div class="form-group">
            <label for="ai-location-input">Ta的位置 (终点)</label>
            <input
              type="text"
              id="ai-location-input"
              placeholder="例如：海边的灯塔"
            />
          </div>
          <div class="form-group">
            <label for="distance-input">相距</label>
            <input
              type="text"
              id="distance-input"
              placeholder="例如：约5公里 (必填)"
            />
          </div>

          <hr style="opacity: 0.2" />

          <!-- 行动轨迹输入区 -->
          <div class="form-group">
            <label>行动轨迹 (可选，按顺序填写)</label>
            <div
              id="trajectory-points-container"
              style="display: flex; flex-direction: column; gap: 8px"
            >
              <!-- JS会在这里动态添加输入框 -->
            </div>
            <button
              id="add-trajectory-point-btn"
              class="form-button form-button-secondary"
              style="margin-top: 12px"
            >
              + 添加途经点
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="location-cancel-btn">取消</button>
          <button class="save" id="location-confirm-btn">发送</button>
        </div>
      </div>
    </div>

    <!-- 粘贴悬浮歌词栏设置模态框 -->
    <div id="lyrics-settings-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>悬浮歌词设置</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="lyrics-font-size-slider"
              >字体大小: <span id="lyrics-font-size-value">14px</span></label
            >
            <input
              type="range"
              id="lyrics-font-size-slider"
              min="12"
              max="24"
              value="14"
              style="width: 100%"
            />
          </div>
          <div class="form-group">
            <label for="lyrics-bg-opacity-slider"
              >背景不透明度: <span id="lyrics-bg-opacity-value">0%</span></label
            >
            <input
              type="range"
              id="lyrics-bg-opacity-slider"
              min="0"
              max="100"
              value="0"
              style="width: 100%"
            />
          </div>
          <div class="form-group">
            <label for="lyrics-font-color-picker">字体颜色</label>
            <input
              type="color"
              id="lyrics-font-color-picker"
              value="#FFFFFF"
              style="width: 100%; height: 40px"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="reset-lyrics-settings-btn">
            恢复默认
          </button>
          <button class="save" id="close-lyrics-settings-btn">完成</button>
        </div>
      </div>
    </div>
    <div id="music-source-selector-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>选择搜索源</span>
        </div>
        <div class="modal-body" style="text-align: left; padding: 20px">
          <!-- ▼▼▼ 修改/新增部分开始 ▼▼▼ -->
          <label style="display: block; margin-bottom: 15px; cursor: pointer">
            <input type="radio" name="search-source" value="all" checked />
            聚合搜索 (网易云 + QQ音乐)
          </label>
          <label style="display: block; margin-bottom: 15px; cursor: pointer">
            <input type="radio" name="search-source" value="netease" /> 仅网易云
            (vkeys接口)
          </label>
          <label style="display: block; margin-bottom: 15px; cursor: pointer">
            <input type="radio" name="search-source" value="tencent" /> 仅QQ音乐
            (vkeys接口)
          </label>
          <!-- 新增 GD 音乐台的选项 -->
          <label
            style="
              display: block;
              cursor: pointer;
              color: #ff5722;
              font-weight: bold;
            "
          >
            <input type="radio" name="search-source" value="gdstudio" />
            GD音乐台 (推荐)
          </label>
          <!-- ▲▲▲ 修改/新增部分结束 ▲▲▲ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-source-select-btn">取消</button>
          <button class="save" id="confirm-source-select-btn">开始搜索</button>
        </div>
      </div>
    </div>

    <div id="weibo-following-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>关注列表</span>
        </div>
        <div class="modal-body" style="padding: 0">
          <div id="weibo-following-list-container">
            <!-- 关注列表将由JS动态生成在这里 -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-following-list-btn"
            style="width: 100%"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 塔罗牌占卜主模态框 -->
    <div id="tarot-divination-modal" class="modal">
      <div class="modal-content" style="height: 85%; width: 95%">
        <!-- 1. 占卜设置界面 -->
        <div id="tarot-setup-view">
          <div class="modal-header">
            <span>塔罗牌占卜</span>
            <div>
              <span
                id="tarot-history-btn"
                class="action-btn"
                style="font-size: 16px"
                >历史</span
              >
              <span
                id="close-tarot-modal-btn"
                class="action-btn"
                style="font-size: 16px"
                >关闭</span
              >
            </div>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="tarot-question-input">您的问题或关注点</label>
              <textarea
                id="tarot-question-input"
                rows="2"
                placeholder="例如：我近期的桃花运如何？"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="tarot-spread-select">选择牌阵</label>
              <select id="tarot-spread-select">
                <option value="single">单张牌 - 快速指引</option>
                <option value="three_past_present_future">
                  三张牌 - 过去/现在/未来
                </option>
                <option value="three_situation_challenge_advice">
                  三张牌 - 情境/挑战/建议
                </option>
                <option value="celtic_cross">
                  凯尔特十字 - 深度分析 (10张牌)
                </option>
              </select>
            </div>
            <div class="form-group">
              <label>牌面方向</label>
              <div style="display: flex; gap: 20px">
                <label
                  ><input
                    type="radio"
                    name="tarot-orientation"
                    value="upright"
                    checked
                  />
                  仅正位</label
                >
                <label
                  ><input
                    type="radio"
                    name="tarot-orientation"
                    value="reversed"
                  />
                  包含逆位</label
                >
              </div>
            </div>
            <button
              id="draw-tarot-cards-btn"
              class="form-button"
              style="margin-top: 20px"
            >
              洗牌并抽牌
            </button>
          </div>
        </div>

        <!-- 2. 占卜结果界面 (默认隐藏) -->
        <div
          id="tarot-result-view"
          style="
            display: none;
            height: 100%;
            display: flex;
            flex-direction: column;
          "
        >
          <div class="modal-header">
            <span
              id="back-to-tarot-setup-btn"
              class="action-btn"
              style="font-size: 16px"
              >返回</span
            >
            <span>占卜结果</span>
          </div>
          <div class="modal-body" id="tarot-result-display">
            <!-- 结果将由JS动态生成在这里 -->
          </div>
          <div class="modal-footer">
            <button id="send-tarot-result-btn" class="save" style="width: 100%">
              发给塔罗师解读
            </button>
          </div>
        </div>

        <!-- 3. 历史记录界面 (默认隐藏) -->
        <div
          id="tarot-history-view"
          style="
            display: none;
            height: 100%;
            display: flex;
            flex-direction: column;
          "
        >
          <div class="modal-header">
            <span
              id="back-to-tarot-main-btn"
              class="action-btn"
              style="font-size: 16px"
              >返回</span
            >
            <span>占卜历史</span>
          </div>
          <div class="modal-body" id="tarot-history-list">
            <!-- 历史记录将由JS动态生成在这里 -->
          </div>
        </div>
      </div>
    </div>

    <!-- 2. 切换角色的弹窗 -->
    <div id="ls-char-selector-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>选择空间</span>
        </div>
        <div class="modal-body" id="ls-char-selector-list" style="padding: 0">
          <!-- 角色列表会由JS动态生成 -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="ls-cancel-switch-char-btn"
            style="width: 100%"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <!-- 3. 发布说说的弹窗 -->
    <div id="ls-create-moment-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>想对Ta说...</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <textarea
              id="ls-moment-content-input"
              rows="5"
              placeholder="在这里写下你们的私密话语..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-moment-btn">取消</button>
          <button class="save" id="ls-confirm-moment-btn">发布</button>
        </div>
      </div>
    </div>

    <!-- 4. 创建相册/上传照片的弹窗 (这是修改后的版本) -->
    <div id="ls-create-album-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <!-- 标题已修改 -->
          <span id="ls-album-modal-title">上传照片</span>
        </div>
        <div class="modal-body">
          <!-- 新增：模式切换开关 (复用动态的样式) -->
          <div class="post-mode-switcher">
            <button id="ls-switch-to-image-mode" class="mode-btn active">
              上传图片
            </button>
            <button id="ls-switch-to-text-image-mode" class="mode-btn">
              使用文字图
            </button>
          </div>

          <!-- 模式1: 上传图片 -->
          <div id="ls-image-mode-content" class="post-mode-content active">
            <div class="form-group">
              <label>选择照片 (仅限单张)</label>
              <div id="ls-photo-preview-container"></div>
              <button
                class="form-button form-button-secondary"
                id="ls-select-photos-btn"
              >
                选择照片
              </button>
              <!-- 关键：这里的 input 移除了 multiple 属性，现在只能单选 -->
              <input type="file" id="ls-photo-input" accept="image/*" hidden />
            </div>
            <div class="form-group">
              <label>图片描述 (必填)</label>
              <textarea
                id="ls-photo-desc-input"
                rows="3"
                placeholder="为这张照片写下注脚..."
              ></textarea>
            </div>
          </div>

          <!-- 模式2: 使用文字图 -->
          <div
            id="ls-text-image-mode-content"
            class="post-mode-content"
            style="display: none"
          >
            <div class="form-group">
              <label>文字图描述 (必填)</label>
              <textarea
                id="ls-text-image-desc-input"
                rows="5"
                placeholder="在这里写下你的心情或故事..."
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-album-btn">取消</button>
          <button class="save" id="ls-confirm-album-btn">确认上传</button>
        </div>
      </div>
    </div>

    <!-- 情侣空间-写情书/回信的弹窗 -->
    <div id="ls-create-letter-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span id="ls-letter-modal-title">给Ta写一封信</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ls-letter-recipient-input">收信人</label>
            <!-- 收信人通常是固定的，所以我们禁用这个输入框 -->
            <input type="text" id="ls-letter-recipient-input" disabled />
          </div>
          <div class="form-group">
            <label for="ls-letter-content-input">情书内容</label>
            <textarea
              id="ls-letter-content-input"
              rows="8"
              placeholder="在这里写下你的心意..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-letter-btn">取消</button>
          <button class="save" id="ls-confirm-letter-btn">寄出</button>
        </div>
      </div>
    </div>

    <!-- 情侣空间-情书查看器 -->
    <div id="ls-letter-viewer-modal" class="modal">
      <div class="ls-letter-viewer-content">
        <!-- 头部：收信人信息 -->
        <div class="letter-viewer-header">
          <img id="ls-viewer-recipient-avatar" class="meta-avatar" />
          <div class="recipient-info">
            <div class="label">To my dear:</div>
            <div id="ls-viewer-recipient-name" class="name"></div>
          </div>
        </div>
        <!-- 中间：信件正文 -->
        <div id="ls-viewer-body" class="letter-viewer-body">
          <!-- JS会在这里填充信件内容 -->
        </div>
        <!-- 底部：发信人信息和操作按钮 -->
        <div class="letter-viewer-footer">
          <div class="sender-info">
            <div id="ls-viewer-sender-name"></div>
            <div id="ls-viewer-timestamp" class="timestamp"></div>
          </div>
          <div class="letter-actions">
            <button id="ls-close-letter-viewer-btn">关闭</button>
            <button id="ls-reply-letter-btn" class="primary">回信</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 情侣空间设置弹窗 -->
    <div id="ls-settings-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>情侣空间设置</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ls-start-date-input">我们在一起的第一天</label>
            <input
              type="date"
              id="ls-start-date-input"
              style="width: 100%; padding: 10px; box-sizing: border-box"
            />
          </div>

          <hr style="opacity: 0.2; margin: 20px 0" />
          <div class="form-group">
            <label>危险操作</label>
            <div style="display: flex; gap: 10px">
              <button
                id="ls-cancel-space-btn"
                class="form-button form-button-secondary"
                style="
                  background-color: #ffe5e5;
                  color: #ff3b30;
                  border-color: #ffc2d1;
                  flex: 1;
                  margin: 0;
                "
              >
                取消空间
              </button>
              <button
                id="ls-disconnect-space-btn"
                class="form-button form-button-secondary"
                style="
                  background-color: #ff3b30;
                  color: white;
                  border-color: #ff3b30;
                  flex: 1;
                  margin: 0;
                "
              >
                解除关系
              </button>
            </div>
            <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px">
              <strong>取消空间</strong>:
              将空间变为未启用状态，但保留所有数据。不会通知对方。<br />
              <strong>解除关系</strong>:
              同样会取消空间，但会通知对方关系已解除，对方会对此发表意见。
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-settings-cancel-btn">取消</button>
          <button class="save" id="ls-settings-save-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 情侣空间-头像编辑弹窗 -->
    <div id="ls-avatar-edit-modal" class="modal">
      <div class="modal-content" style="height: auto; max-width: 400px">
        <div class="modal-header">
          <span id="ls-avatar-edit-title">编辑头像</span>
        </div>
        <div class="modal-body">
          <div style="text-align: center; margin-bottom: 20px">
            <img id="ls-avatar-edit-preview" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color);" />
          </div>
          <div class="form-group">
            <label>选择修改方式</label>
            <div style="display: flex; flex-direction: column; gap: 10px">
              <button id="ls-avatar-upload-btn" class="form-button" style="margin: 0">
                从本地上传
              </button>
              <button id="ls-avatar-url-btn" class="form-button" style="margin: 0">
                使用网络URL
              </button>
              <button id="ls-avatar-reset-btn" class="form-button form-button-secondary" style="margin: 0">
                重置为默认
              </button>
            </div>
          </div>
          <div id="ls-avatar-url-input-group" class="form-group" style="display: none; margin-top: 15px">
            <label for="ls-avatar-url-input">图片URL</label>
            <input
              type="text"
              id="ls-avatar-url-input"
              placeholder="请输入图片URL"
              style="width: 100%; padding: 10px; box-sizing: border-box"
            />
            <button id="ls-avatar-url-confirm-btn" class="form-button" style="margin-top: 10px; width: 100%">
              确认使用此URL
            </button>
          </div>
          <input type="file" id="ls-avatar-file-input" accept="image/*" style="display: none" />
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-avatar-edit-cancel-btn">取消</button>
        </div>
      </div>
    </div>

    <!-- 情侣空间-用户名编辑弹窗 -->
    <div id="ls-username-edit-modal" class="modal">
      <div class="modal-content" style="height: auto; max-width: 400px">
        <div class="modal-header">
          <span id="ls-username-edit-title">编辑昵称</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ls-username-input">昵称</label>
            <input
              type="text"
              id="ls-username-input"
              placeholder="请输入昵称"
              style="width: 100%; padding: 10px; box-sizing: border-box"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-username-edit-cancel-btn">取消</button>
          <button class="save" id="ls-username-edit-save-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 情侣空间-提问弹窗 -->
    <div id="ls-ask-question-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>发起一个提问</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <textarea
              id="ls-question-content-input"
              rows="5"
              placeholder="向Ta提个问题吧..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-ask-btn">取消</button>
          <button class="save" id="ls-confirm-ask-btn">向Ta提问</button>
        </div>
      </div>
    </div>

    <!-- 情侣空间-回答弹窗 -->
    <div id="ls-answer-question-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>回答Ta的问题</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>问题：</label>
            <p
              id="ls-answer-question-text"
              style="
                background-color: #f0f2f5;
                padding: 10px;
                border-radius: 8px;
              "
            ></p>
          </div>
          <div class="form-group">
            <label for="ls-answer-content-input">你的回答：</label>
            <textarea
              id="ls-answer-content-input"
              rows="5"
              placeholder="认真回答哦..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-answer-btn">取消</button>
          <button class="save" id="ls-confirm-answer-btn">确认回答</button>
        </div>
      </div>
    </div>

    <!-- 1. 这是播放器专属的音频引擎 -->
    <audio id="ls-audio-player" style="display: none"></audio>

    <!-- 2. 这是播放器的主窗口界面 -->
    <div id="ls-music-player-overlay" class="modal">
      <div class="music-player-window">
        <!-- 封面和歌词的切换容器 -->
        <div
          id="ls-display-area"
          style="
            width: 192px;
            height: 192px;
            margin-bottom: 20px;
            cursor: pointer;
          "
        >
          <!-- 歌曲封面 -->
          <img
            id="ls-album-cover"
            src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
            alt="歌曲封面"
            style="
              width: 100%;
              height: 100%;
              border-radius: 12px;
              box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            "
          />

          <!-- 歌词容器 -->
          <div
            id="ls-lyrics-container"
            style="
              display: none;
              width: 100%;
              height: 100%;
              overflow: hidden;
              text-align: center;
              color: #333;
              font-weight: 500;
            "
          >
            <div id="ls-lyrics-list" style="transition: transform 0.5s ease">
              <!-- 歌词会显示在这里 -->
            </div>
          </div>
        </div>

        <!-- 歌曲信息 -->
        <div id="ls-song-title" style="font-size: 18px; font-weight: 600">
          暂无歌曲
        </div>
        <div
          id="ls-artist"
          style="font-size: 14px; color: #666; margin-bottom: 15px"
        >
          ...
        </div>

        <!-- 进度条 -->
        <div class="music-progress-bar-container" style="width: 100%">
          <div id="ls-current-time" class="time-display">0:00</div>
          <div class="progress-bar" id="ls-progress-bar">
            <div id="ls-progress-fill" class="progress-bar-fill"></div>
          </div>
          <div id="ls-total-time" class="time-display">0:00</div>
        </div>

        <!-- 控制按钮 -->
        <div class="music-controls" style="margin-bottom: 15px">
          <button id="ls-prev-btn">◀</button>
          <button id="ls-play-pause-btn" class="play-pause-btn">▶</button>
          <button id="ls-next-btn">▶</button>
        </div>

        <!-- 底部操作按钮 -->
        <div class="music-bottom-actions" style="width: 100%">
          <button
            id="ls-playlist-btn"
            style="
              background-color: rgba(0, 123, 255, 0.1);
              color: var(--accent-color);
              margin-right: 5px;
            "
          >
            播放列表
          </button>
          <button
            id="ls-close-player-btn"
            style="
              background-color: rgba(0, 0, 0, 0.05);
              color: #333;
              margin-left: 5px;
            "
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 3. 这是播放列表的侧滑面板 -->
    <div id="ls-music-playlist-panel" class="music-playlist-panel">
      <div class="playlist-header">
        <span class="panel-btn" id="ls-close-playlist-btn">返回</span>
        <span>播放列表</span>
        <span
          class="panel-btn"
          id="ls-clear-playlist-btn"
          style="color: #ff3b30"
          >清空</span
        >
      </div>
      <div class="playlist-body" id="ls-playlist-body">
        <!-- 播放列表内容会在这里生成 -->
      </div>
    </div>

    <!-- 情侣番茄钟-设置弹窗 -->
    <div id="ls-pomodoro-setup-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>新的专注时光</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="pomodoro-task-input">专注任务</label>
            <input
              type="text"
              id="pomodoro-task-input"
              placeholder="例如：学习JS、完成工作报告"
            />
          </div>
          <div class="form-group">
            <label for="pomodoro-duration-input">专注时长 (分钟)</label>
            <input
              type="number"
              id="pomodoro-duration-input"
              value="25"
              min="1"
            />
          </div>
          <div class="form-group">
            <label>计时模式</label>
            <div style="display: flex; gap: 20px">
              <label
                ><input
                  type="radio"
                  name="pomodoro-mode"
                  value="countdown"
                  checked
                />
                倒计时</label
              >
              <label
                ><input type="radio" name="pomodoro-mode" value="countup" />
                正计时</label
              >
            </div>
          </div>
          <div class="form-group">
            <label for="pomodoro-talk-interval-input"
              >角色鼓励间隔 (分钟, 0为不自动鼓励)</label
            >
            <input
              type="number"
              id="pomodoro-talk-interval-input"
              value="5"
              min="0"
            />
          </div>

          <div class="form-group">
            <label>自定义背景 (可选)</label>
            <div style="display: flex; gap: 10px; align-items: center">
              <input
                type="text"
                id="pomodoro-bg-url-input"
                placeholder="粘贴图片URL"
                style="flex-grow: 1"
              />
              <button
                id="pomodoro-bg-local-upload-btn"
                class="form-button-secondary"
                style="margin: 0; padding: 12px; width: auto"
              >
                本地上传
              </button>
            </div>
            <input
              type="file"
              id="pomodoro-bg-file-input"
              accept="image/*"
              hidden
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="pomodoro-cancel-setup-btn">取消</button>
          <button class="save" id="pomodoro-confirm-setup-btn">开始专注</button>
        </div>
      </div>
    </div>

    <!-- 情侣番茄钟-历史详情弹窗 -->
    <div id="ls-pomodoro-history-viewer-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="pomodoro-history-viewer-title">专注记录</span>
        </div>
        <div class="modal-body" id="pomodoro-history-viewer-content">
          <!-- 聊天记录会由JS生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="pomodoro-close-history-viewer-btn"
            style="width: 100%"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 1. 小组编辑器弹窗 (用于修改小组信息和世界观) -->
    <div id="forum-group-editor-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>编辑小组信息</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="group-editor-name-input">小组名称</label>
            <input type="text" id="group-editor-name-input" />
          </div>
          <div class="form-group">
            <label for="group-editor-desc-input">小组简介</label>
            <input type="text" id="group-editor-desc-input" />
          </div>
          <div class="form-group">
            <label for="group-editor-icon-input">小组图标 (Emoji)</label>
            <input type="text" id="group-editor-icon-input" />
          </div>
          <div class="form-group">
            <label for="group-editor-categories-input"
              >小组分类 (用#号分隔, 例如: #科幻 #未来)</label
            >
            <input
              type="text"
              id="group-editor-categories-input"
              placeholder="例如: #科幻 #未来"
            />
          </div>
          <div class="form-group">
            <label for="group-editor-worldview-input"
              >小组世界观 (供AI生成内容时参考)</label
            >
            <textarea
              id="group-editor-worldview-input"
              rows="5"
              placeholder="详细描述这个小组独特的背景设定..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-group-editor-btn">取消</button>
          <button class="save" id="save-group-editor-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 2. 分类管理弹窗 -->
    <div id="forum-category-manager-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>管理圈子分类</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>新建分类</label>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="new-forum-category-name-input"
                placeholder="输入分类名，无需带'#'..."
                style="flex-grow: 1"
              />
              <button
                id="add-new-forum-category-btn"
                class="form-button"
                style="width: auto; margin-top: 0; padding: 0 15px"
              >
                添加
              </button>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <div
            id="existing-forum-categories-list"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <!-- 分类列表将由JS动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-forum-category-manager-btn"
            style="width: 100%"
          >
            完成
          </button>
        </div>
      </div>
    </div>

    <div id="aurora-setup-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>漫游共赏</span>
          <span
            id="open-aurora-bookshelf-btn"
            class="action-btn"
            style="font-size: 14px"
            >📚 书架</span
          >
        </div>
        <div class="modal-body">
          <!-- 1. 名字输入 -->
          <div class="form-group">
            <label for="aurora-title-input">漫游主题 / 作品名称</label>
            <input
              type="text"
              id="aurora-title-input"
              placeholder="例如：雨夜谈心、泰坦尼克号..."
            />
          </div>

          <!-- 2. 类型选择 -->
          <div class="form-group">
            <label>模式选择</label>
            <div style="display: flex; gap: 15px; flex-wrap: wrap">
              <label
                ><input type="radio" name="aurora-mode" value="video" checked />
                看视频</label
              >
              <label
                ><input type="radio" name="aurora-mode" value="text" />
                读小说</label
              >
              <!-- 新增自定义选项 -->
              <label
                ><input type="radio" name="aurora-mode" value="custom" />
                自定义(音画)</label
              >
            </div>
          </div>

          <!-- 3. 视频模式输入区 -->
          <div id="aurora-video-inputs" class="aurora-input-group">
            <div class="form-group">
              <label>视频文件 (mp4, webm)</label>
              <input type="file" id="aurora-video-file" accept="video/*,.mkv" />
            </div>
            <div class="form-group">
              <label>字幕文件 (可选 .srt, .vtt)</label>
              <input
                type="file"
                id="aurora-sub-file-video"
                accept=".srt,.vtt,.lrc"
              />
              <!-- ★★★ 新增：字幕URL输入框 ★★★ -->
              <input
                type="text"
                id="aurora-sub-url-video"
                placeholder="或粘贴字幕链接 (SRT/VTT/LRC)"
                style="margin-top: 5px"
              />
            </div>
          </div>

          <div
            id="aurora-text-inputs"
            class="aurora-input-group"
            style="display: none"
          >
            <div class="form-group">
              <label>小说/文本文件 (.txt)</label>
              <input type="file" id="aurora-text-file" accept=".txt" />
              <!-- ★★★ 新增：小说URL输入框 ★★★ -->
              <input
                type="text"
                id="aurora-text-url"
                placeholder="或粘贴txt文件链接"
                style="margin-top: 5px"
              />
            </div>
          </div>

          <!-- 5. 自定义模式输入区 -->
          <div
            id="aurora-custom-inputs"
            class="aurora-input-group"
            style="display: none"
          >
            <div class="form-group">
              <label>背景图片 (jpg, png, gif)</label>
              <input type="file" id="aurora-custom-img" accept="image/*" />
            </div>
            <div class="form-group">
              <label>音频文件 (mp3, wav, m4a)</label>
              <input type="file" id="aurora-custom-audio" accept="audio/*" />
            </div>
            <div class="form-group">
              <label>字幕文件 (可选 .srt, .vtt)</label>
              <input
                type="file"
                id="aurora-sub-file-custom"
                accept=".srt,.vtt,.lrc"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-aurora-setup">取消</button>
          <button class="save" id="confirm-aurora-setup">开始漫游</button>
        </div>
      </div>
    </div>

    <!-- 漫游播放器弹窗 (已修复关闭按钮消失问题) -->
    <div
      id="aurora-player-overlay"
      style="
        display: none;
        position: absolute;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        width: 320px;
        height: 400px;
        background: #000;
        border-radius: 12px;
        z-index: 9999;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        flex-direction: column;
        overflow: hidden;
      "
    >
      <!-- 顶部拖拽条 -->
      <div
        id="aurora-drag-handle"
        style="
          width: 100%;
          height: 40px;
          flex-shrink: 0;
          padding: 0 10px;
          background: linear-gradient(90deg, #e0c3fc 0%, #8ec5fc 100%);
          cursor: grab;
          display: flex;
          align-items: center;
          justify-content: space-between;
          z-index: 100;
          box-sizing: border-box; /* ★★★ 核心修复：防止内容被挤出容器 ★★★ */
        "
      >
        <span
          style="
            font-size: 14px;
            color: #333;
            font-weight: 800;
            pointer-events: none;
          "
          >✨ 漫游</span
        >

        <!-- 字号调整与关闭按钮组 -->
        <div style="display: flex; gap: 10px; align-items: center">
          <button
            id="aurora-font-down"
            style="
              background: rgba(255, 255, 255, 0.4);
              border: 1px solid rgba(0, 0, 0, 0.1);
              border-radius: 4px;
              padding: 2px 8px;
              font-weight: bold;
              cursor: pointer;
              color: #333;
              font-size: 12px;
            "
          >
            A-
          </button>
          <button
            id="aurora-font-up"
            style="
              background: rgba(255, 255, 255, 0.4);
              border: 1px solid rgba(0, 0, 0, 0.1);
              border-radius: 4px;
              padding: 2px 8px;
              font-weight: bold;
              cursor: pointer;
              color: #333;
              font-size: 12px;
            "
          >
            A+
          </button>
          <!-- 关闭按钮：加大字号，增加点击区域 -->
          <span
            id="aurora-close-player"
            style="
              cursor: pointer;
              font-weight: 900;
              color: #333;
              font-size: 24px;
              line-height: 1;
              padding: 0 5px;
            "
            >×</span
          >
        </div>
      </div>

      <!-- 内容区 -->
      <div
        id="aurora-content-area"
        style="
          width: 100%;
          flex-grow: 1;
          position: relative;
          background: #000;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
        "
      >
        <!-- 视频播放器 -->
        <video
          id="aurora-video-element"
          style="width: 100%; height: 100%; object-fit: contain; display: none"
          playsinline
          webkit-playsinline
        ></video>

        <!-- 文本阅读器 -->
        <div
          id="aurora-text-viewer"
          style="
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
            font-size: 16px;
            line-height: 1.8;
            color: #e0e0e0;
            font-family: sans-serif;
          "
        >
          <div id="aurora-text-body" style="white-space: pre-wrap"></div>
        </div>

        <!-- 自定义音画播放器 -->
        <div
          id="aurora-custom-viewer"
          style="display: none; width: 100%; height: 100%; position: relative"
        >
          <img
            id="aurora-custom-bg-img"
            style="width: 100%; height: 100%; display: block; object-fit: cover"
          />
          <div
            id="aurora-custom-subtitle-display"
            style="
              position: absolute;
              bottom: 10%;
              left: 0;
              width: 100%;
              text-align: center;
              color: white;
              text-shadow: 0 2px 4px black, 0 0 4px black;
              font-size: 16px;
              padding: 0 10px;
              pointer-events: none;
              font-weight: 500;
              z-index: 20;
            "
          ></div>
          <audio
            id="aurora-custom-audio-element"
            controls
            style="
              width: 100%;
              height: 40px;
              opacity: 0;
              position: absolute;
              bottom: 0;
              left: 0;
              z-index: 30;
            "
          ></audio>
        </div>
      </div>

      <!-- 底部栏 -->
      <div
        style="
          padding: 5px 12px;
          height: 28px;
          flex-shrink: 0;
          font-size: 12px;
          color: #888;
          background: #121212;
          border-top: 1px solid #333;
          display: flex;
          align-items: center;
          justify-content: space-between;
        "
      >
        <span
          id="aurora-playing-title"
          style="
            max-width: 50%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
          "
          >未播放</span
        >
        <span
          id="aurora-save-book-btn"
          style="
            cursor: pointer;
            display: none;
            color: #d4af37;
            font-weight: bold;
          "
          >📥 存入书架</span
        >
        <span id="aurora-info-status">等待中...</span>
      </div>

      <!-- 手机端触摸缩放手柄 -->
      <div
        id="aurora-resize-handle"
        style="
          position: absolute;
          bottom: 0;
          right: 0;
          width: 30px;
          height: 30px;
          background: linear-gradient(135deg, transparent 50%, #8ec5fc 50%);
          cursor: nwse-resize;
          z-index: 101;
          touch-action: none;
        "
      ></div>
    </div>

    <!-- 复古书架界面 -->
    <div id="aurora-bookshelf-screen" class="screen">
      <div
        class="header"
        style="
          background-color: #3e2723 !important;
          color: #e0c097 !important;
          border-bottom: 1px solid #5d4037;
        "
      >
        <span class="back-btn" id="back-from-bookshelf" style="color: #e0c097"
          >‹</span
        >
        <span
          style="font-family: 'serif'; font-weight: bold; letter-spacing: 2px"
          >藏书阁</span
        >
        <span style="width: 30px"></span>
      </div>
      <!-- 书架背景容器 -->
      <div id="bookshelf-container">
        <!-- 书籍将由JS生成在这里 -->
      </div>
    </div>

    <div id="game-hall-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>游戏大厅</span>
        <span style="width: 30px"></span>
        <!-- 占位符 -->
      </div>
      <div class="list-container" style="padding: 20px">
        <p style="text-align: center; color: var(--text-secondary)">
          选择一个游戏开始吧！
        </p>
        <div id="game-hall-grid">
          <!-- 游戏列表将显示在这里 -->
          <div class="game-card" data-game="werewolf">
            <div class="game-icon">🐺</div>
            <div class="game-info">
              <div class="game-title">狼人杀</div>
              <div class="game-desc">逻辑与谎言的对决</div>
            </div>
          </div>
          <div class="game-card" data-game="sea-turtle-soup">
            <div class="game-icon">🐢</div>
            <div class="game-info">
              <div class="game-title">海龟汤</div>
              <div class="game-desc">揭开情景的真相</div>
            </div>
          </div>
          <div class="game-card" data-game="script-kill">
            <div class="game-icon">📜</div>
            <div class="game-info">
              <div class="game-title">剧本杀</div>
              <div class="game-desc">扮演角色，探寻谜案</div>
            </div>
          </div>
          <div class="game-card" data-game="guess-what">
            <div class="game-icon">🗣️</div>
            <div class="game-info">
              <div class="game-title">你说我猜</div>
              <div class="game-desc">考验默契的时候到了</div>
            </div>
          </div>
          <div class="game-card" data-game="ludo">
            <div class="game-icon">🎲</div>
            <div class="game-info">
              <div class="game-title">心动飞行棋</div>
              <div class="game-desc">和Ta来一场只属于你们的冒险</div>
            </div>
          </div>

          <div class="game-card" data-game="undercover">
            <div class="game-icon">🕵️</div>
            <div class="game-info">
              <div class="game-title">谁是卧底</div>
              <div class="game-desc">语言的伪装，逻辑的陷阱</div>
            </div>
          </div>

          <p
            style="
              grid-column: 1 / -1;
              text-align: center;
              color: var(--text-secondary);
              font-size: 14px;
              margin-top: 20px;
            "
          >
            更多游戏正在火速开发中...
          </p>
        </div>
      </div>
    </div>

    <!-- 1. 狼人杀游戏设置屏幕 -->
    <div id="werewolf-setup-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">‹</span>
        <span>狼人杀 - 游戏设置</span>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label for="werewolf-player-count">选择游戏人数</label>
          <select id="werewolf-player-count">
            <option value="6">6人局 (2狼, 2民, 预言家, 守卫)</option>
            <option value="9">9人局 (3狼, 3民, 预言家, 女巫, 猎人)</option>
            <option value="12">
              12人局 (4狼, 4民, 预言家, 女巫, 猎人, 白痴)
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>邀请玩家 (你已自动加入)</label>
          <div
            id="werewolf-player-selection"
            class="list-container"
            style="
              height: 300px;
              border: 1px solid var(--border-color);
              border-radius: 8px;
            "
          >
            <!-- 玩家选择列表将由JS动态生成 -->
          </div>
        </div>
        <button id="start-werewolf-game-btn" class="form-button">
          开始游戏
        </button>
      </div>
    </div>

    <!-- 2. 狼人杀游戏主界面 -->
    <div id="werewolf-game-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-werewolf-game-btn">‹ 退出</span>
        <span id="werewolf-game-title">狼人杀</span>
        <span class="action-btn" id="werewolf-my-role-btn">我的身份</span>
      </div>
      <!-- 游戏主内容区 -->
      <div id="werewolf-game-content">
        <!-- 玩家座位区 -->
        <div id="werewolf-players-grid">
          <!-- 玩家头像和状态将由JS动态生成 -->
        </div>
        <!-- 游戏日志/信息区 -->
        <div id="werewolf-log-container">
          <div id="werewolf-game-log">
            <!-- 游戏过程信息会显示在这里 -->
          </div>
        </div>
        <!-- 玩家操作区 -->
        <div id="werewolf-action-area">
          <!-- 玩家的按钮会根据游戏阶段显示在这里 -->
        </div>
      </div>
    </div>

    <!-- 狼人杀游戏结算卡片 -->
    <div id="werewolf-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>游戏结算</span>
        </div>
        <div
          class="modal-body"
          id="werewolf-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- 结算内容将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="repost-summary-btn">发送复盘到聊天</button>
          <button class="save" id="back-to-hall-btn">返回大厅</button>
        </div>
      </div>
    </div>

    <!-- 狼人杀复盘发送目标选择器 -->
    <div id="werewolf-target-picker-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>选择要发送的玩家</span>
        </div>
        <div class="modal-body" id="werewolf-target-list" style="padding: 0">
          <!-- 玩家列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            id="wt-select-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            全选
          </button>
          <button
            id="wt-deselect-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            全不选
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="wt-cancel-btn">取消</button>
          <button class="save" id="wt-confirm-btn">确认发送</button>
        </div>
      </div>
    </div>

    <!-- 1. 海龟汤游戏主界面 -->
    <div id="sea-turtle-soup-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-sts-game-btn">‹ 退出</span>
        <span>海龟汤</span>
        <span class="action-btn" id="reveal-sts-answer-btn">揭晓答案</span>
      </div>
      <div
        id="sts-game-content"
        style="
          display: flex;
          flex-direction: column;
          height: 100%;
          overflow: hidden;
          padding: 10px;
          box-sizing: border-box;
        "
      >
        <!-- 玩家座位区 -->
        <div
          id="sts-players-grid"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            padding: 10px;
            flex-shrink: 0;
          "
        >
          <!-- 玩家头像和状态将由JS动态生成 -->
        </div>
        <!-- 游戏日志/信息区 -->
        <div
          id="sts-log-container"
          style="
            flex-grow: 1;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            margin: 10px 0;
            min-height: 0;
          "
        >
          <div id="sts-game-log">
            <!-- 游戏过程信息会显示在这里 -->
          </div>
        </div>

        <div
          id="sts-action-area"
          class="chat-input-area"
          style="visibility: visible"
        >
          <div class="chat-input-main-row">
            <textarea
              id="sts-question-input"
              rows="1"
              placeholder="输入问题或答案..."
            ></textarea>
            <!-- 新增“猜答案”按钮 -->
            <button
              id="guess-sts-answer-btn"
              class="action-button"
              style="background-color: #ff9800"
            >
              猜答案
            </button>
            <button id="send-sts-question-btn" class="action-button">
              提问
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. 海龟汤游戏设置模态框 -->
    <div id="sea-turtle-soup-setup-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 85%">
        <div class="modal-header">
          <span>海龟汤 - 游戏设置</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>邀请玩家 (你已自动加入)</label>
            <div
              id="sts-player-selection"
              class="list-container"
              style="
                height: 200px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
              "
            >
              <!-- 玩家选择列表将由JS动态生成 -->
            </div>
          </div>
          <div class="form-group">
            <label>谁来出题？</label>
            <select id="sts-riddle-provider-select">
              <option value="user">我来出题</option>
              <option value="random_ai">随机一位AI</option>
            </select>
          </div>
          <!-- 用户出题的输入区 (默认隐藏) -->
          <div id="sts-user-riddle-input-area" style="display: none">
            <div class="form-group">
              <label for="sts-user-riddle-surface">谜面</label>
              <textarea
                id="sts-user-riddle-surface"
                rows="2"
                placeholder="例如：一个男人走进酒吧，要了一杯水..."
              ></textarea>
            </div>
            <div class="form-group">
              <label for="sts-user-riddle-answer">谜底 (完整故事)</label>
              <textarea
                id="sts-user-riddle-answer"
                rows="4"
                placeholder="例如：男人在打嗝，他想喝水止嗝..."
              ></textarea>
            </div>
          </div>
          <!-- AI出题的输入区 (默认隐藏) -->
          <div id="sts-ai-riddle-input-area" style="display: none">
            <div class="form-group">
              <label for="sts-ai-riddle-type">谜题类型 (可选)</label>
              <input
                type="text"
                id="sts-ai-riddle-type"
                placeholder="例如：恐怖、温情、脑洞、经典"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-sts-setup-btn">取消</button>
          <button class="save" id="start-sts-game-btn">开始游戏</button>
        </div>
      </div>
    </div>

    <!-- 1. 海龟汤游戏结算卡片 -->
    <div id="sts-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>游戏结算</span>
        </div>
        <div
          class="modal-body"
          id="sts-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- 结算内容将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="share-sts-summary-btn">分享复盘</button>
          <button class="save" id="back-to-hall-from-sts-btn">返回大厅</button>
        </div>
      </div>
    </div>

    <!-- 2. 海龟汤复盘发送目标选择器 -->
    <div id="sts-share-target-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>选择要分享的玩家</span>
        </div>
        <div class="modal-body" id="sts-share-target-list" style="padding: 0">
          <!-- 玩家列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            id="sts-select-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            全选
          </button>
          <button
            id="sts-deselect-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            全不选
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="sts-cancel-share-btn">取消</button>
          <button class="save" id="sts-confirm-share-btn">确认分享</button>
        </div>
      </div>
    </div>

    <!-- 1. 剧本杀游戏设置屏幕 -->
    <div id="script-kill-setup-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">‹</span>
        <span>剧本杀 - 游戏设置</span>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label>选择剧本</label>
          <div style="display: flex; gap: 10px">
            <select
              id="script-kill-script-select"
              style="flex-grow: 1"
            ></select>
            <button
              id="manage-custom-scripts-btn"
              class="form-button-secondary"
              style="margin-top: 0; padding: 0 15px"
            >
              管理
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>邀请玩家 (你已自动加入)</label>
          <div
            id="script-kill-player-selection"
            class="list-container"
            style="
              height: 300px;
              border: 1px solid var(--border-color);
              border-radius: 8px;
            "
          >
            <!-- 玩家选择列表将由JS动态生成 -->
          </div>
        </div>
        <div class="form-group">
          <label class="toggle-switch-label">
            <span class="toggle-switch-text"
              >自由选择角色 (关闭则随机分配)</span
            >
            <input type="checkbox" id="script-kill-free-choice-toggle" />
            <span class="toggle-switch-slider"></span>
          </label>
        </div>
        <button id="start-script-kill-game-btn" class="form-button">
          开始游戏
        </button>
      </div>
    </div>

    <!-- 2. 剧本杀游戏主界面 -->
    <div id="script-kill-game-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-script-kill-game-btn">‹ 退出</span>
        <span id="script-kill-game-title">剧本杀</span>
        <div class="header-actions">
          <span class="action-btn" id="script-kill-my-role-btn">我的角色</span>
          <span class="action-btn" id="script-kill-all-evidence-btn"
            >公共线索</span
          >
        </div>
      </div>
      <div id="script-kill-game-content">
        <div id="script-kill-players-grid">
          <!-- 玩家头像和状态将由JS动态生成 -->
        </div>
        <div id="script-kill-log-container">
          <div id="script-kill-game-log">
            <!-- 游戏过程信息会显示在这里 -->
          </div>
        </div>
        <div id="script-kill-action-area">
          <!-- 玩家的按钮会根据游戏阶段显示在这里 -->
        </div>
      </div>
    </div>

    <!-- 剧本杀自定义剧本管理模态框 -->
    <div id="script-kill-manager-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>管理自定义剧本</span>
          <div class="header-actions">
            <button
              id="import-script-btn"
              class="action-button"
              style="font-size: 14px"
            >
              导入
            </button>

            <button
              id="open-sk-ai-generator-btn"
              class="action-button"
              style="font-size: 14px"
            >
              AI生成
            </button>

            <button id="add-new-script-btn" class="action-button">添加</button>
          </div>
        </div>

        <div class="modal-body" id="custom-scripts-list" style="padding: 0">
          <!-- 自定义剧本列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-script-manager-btn"
            style="width: 100%"
          >
            完成
          </button>
        </div>
      </div>
    </div>

    <!-- 1. 剧本编辑器主弹窗 (可视化版) -->
    <div id="script-kill-editor-modal" class="modal">
      <div class="modal-content" style="height: 90%">
        <div class="modal-header">
          <span id="script-editor-title">剧本编辑器</span>
        </div>
        <div
          class="modal-body"
          style="display: flex; flex-direction: column; gap: 15px"
        >
          <!-- 基础信息 -->
          <div class="form-group">
            <label for="script-name-input">剧本名称</label>
            <input type="text" id="script-name-input" />
          </div>
          <div class="form-group">
            <label for="script-background-input">故事背景</label>
            <textarea id="script-background-input" rows="3"></textarea>
          </div>

          <hr style="opacity: 0.2" />

          <!-- 角色设定区 -->
          <div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <label style="margin: 0; font-weight: 600">角色设定</label>
              <button
                id="sk-add-role-btn"
                class="form-button-secondary"
                style="margin: 0; padding: 5px 15px"
              >
                + 添加角色
              </button>
            </div>
            <div id="sk-roles-container" class="sk-item-container">
              <!-- 角色卡片将由JS动态生成在这里 -->
            </div>
          </div>

          <!-- 线索卡区 -->
          <div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <label style="margin: 0; font-weight: 600">线索卡</label>
              <button
                id="sk-add-clue-btn"
                class="form-button-secondary"
                style="margin: 0; padding: 5px 15px"
              >
                + 添加线索
              </button>
            </div>
            <div id="sk-clues-container" class="sk-item-container">
              <!-- 线索卡片将由JS动态生成在这里 -->
            </div>
          </div>

          <!-- 最终真相互动 -->
          <div class="form-group">
            <label for="sk-truth-input">最终真相</label>
            <textarea id="sk-truth-input" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-script-editor-btn">取消</button>
          <button class="save" id="save-script-btn">保存剧本</button>
        </div>
      </div>
    </div>

    <!-- 2. 用于编辑单个角色/线索的子弹窗 -->
    <div id="sk-item-editor-modal" class="modal" style="z-index: 1003">
      <div class="modal-content" style="height: auto; max-height: 85%">
        <div class="modal-header">
          <span id="sk-item-editor-title"></span>
        </div>
        <div class="modal-body">
          <!-- 角色编辑字段 (默认隐藏) -->
          <div id="sk-role-editor-fields" style="display: none">
            <div class="form-group">
              <label for="sk-role-name-input">角色名称</label>
              <input type="text" id="sk-role-name-input" />
            </div>
            <div class="form-group">
              <label for="sk-role-desc-input">角色介绍</label>
              <textarea id="sk-role-desc-input" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="sk-role-storyline-input"
                >故事线 (案发时间段的详细行动轨迹)</label
              >
              <textarea id="sk-role-storyline-input" rows="5"></textarea>
            </div>
            <div class="form-group">
              <label for="sk-role-tasks-input">秘密任务</label>
              <textarea id="sk-role-tasks-input" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">是凶手</span>
                <input type="checkbox" id="sk-role-killer-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>
          </div>
          <!-- 线索编辑字段 (默认隐藏) -->
          <div id="sk-clue-editor-fields" style="display: none">
            <div class="form-group">
              <label for="sk-clue-owner-select">线索归属</label>
              <select id="sk-clue-owner-select">
                <!-- 选项将由JS动态生成 -->
              </select>
            </div>
            <div class="form-group">
              <label for="sk-clue-desc-input">线索描述</label>
              <textarea id="sk-clue-desc-input" rows="4"></textarea>
            </div>
            <div class="form-group">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">是关键线索</span>
                <input type="checkbox" id="sk-clue-key-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="sk-item-editor-cancel-btn">取消</button>
          <button class="save" id="sk-item-editor-save-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 4. 角色身份卡模态框 -->
    <div id="script-kill-role-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="sk-role-name">你的角色</span>
        </div>
        <div
          class="modal-body"
          id="sk-role-details"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- 角色介绍、任务等将显示在这里 -->
        </div>
        <div class="modal-footer">
          <button class="save" id="close-sk-role-modal-btn" style="width: 100%">
            我已了解
          </button>
        </div>
      </div>
    </div>

    <!-- 5. 个人线索板模态框 -->
    <div id="script-kill-evidence-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>我的线索板</span>
        </div>
        <div
          class="modal-body"
          id="sk-evidence-list"
          style="
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
          "
        >
          <!-- 搜到的线索卡片会显示在这里 -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-sk-evidence-modal-btn"
            style="width: 100%"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 6. 投票模态框 -->
    <div id="script-kill-vote-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 70%">
        <div class="modal-header">
          <span id="sk-vote-title">最终投票</span>
        </div>
        <div
          class="modal-body"
          id="sk-vote-options-list"
          style="text-align: left; padding: 20px"
        >
          <!-- 投票选项将由JS动态生成 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-sk-vote-btn">取消</button>
          <button class="save" id="confirm-sk-vote-btn">确认投票</button>
        </div>
      </div>
    </div>
    <!-- 剧本杀游戏结算卡片 -->
    <div id="script-kill-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>游戏结算</span>
        </div>
        <div
          class="modal-body"
          id="script-kill-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- 结算内容将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="repost-sk-summary-btn">
            转发复盘到单聊
          </button>
          <button class="save" id="back-to-hall-from-sk-btn">返回大厅</button>
        </div>
      </div>
    </div>

    <!-- 剧本杀复盘发送目标选择器 -->
    <div id="script-kill-target-picker-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>选择要转发的玩家</span>
        </div>
        <div class="modal-body" id="script-kill-target-list" style="padding: 0">
          <!-- 玩家列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            id="sk-select-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            全选
          </button>
          <button
            id="sk-deselect-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            全不选
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="sk-cancel-share-btn">取消</button>
          <button class="save" id="sk-confirm-share-btn">确认转发</button>
        </div>
      </div>
    </div>

    <div id="sk-ai-generator-modal" class="modal">
      <div class="modal-content" style="height: 90%">
        <div class="modal-header">
          <span>AI 剧本生成器</span>
        </div>
        <div
          class="modal-body"
          style="display: flex; flex-direction: column; gap: 15px"
        >
          <div class="form-group">
            <label for="sk-ai-elements-input">核心要素 (用逗号分隔)</label>
            <input
              type="text"
              id="sk-ai-elements-input"
              placeholder="例如：现代, 谋杀, 暴风雪山庄, 遗产"
            />
          </div>

          <div class="form-group">
            <label for="sk-ai-player-count-input"
              >玩家人数 (包含凶手, 建议4-8人)</label
            >
            <input
              type="number"
              id="sk-ai-player-count-input"
              value="5"
              min="3"
              max="12"
              style="
                width: 100%;
                box-sizing: border-box;
                padding: 10px;
                border-radius: 6px;
                border: 1px solid var(--border-color);
              "
            />
          </div>

          <div class="form-group">
            <label for="sk-ai-summary-input">剧情梗概 (可选)</label>
            <textarea
              id="sk-ai-summary-input"
              rows="4"
              placeholder="可以写一个简单的故事大纲，帮助AI更好地理解你的想法..."
            ></textarea>
          </div>
          <button id="sk-trigger-ai-generation-btn" class="form-button">
            开始生成
          </button>

          <hr style="opacity: 0.2; margin: 5px 0" />

          <div
            class="form-group"
            style="
              flex-grow: 1;
              min-height: 0;
              display: flex;
              flex-direction: column;
            "
          >
            <label>AI 生成结果预览</label>
            <div
              id="sk-ai-result-preview"
              style="
                flex-grow: 1;
                overflow-y: auto;
                background: #f0f2f5;
                padding: 10px;
                border-radius: 8px;
                white-space: pre-wrap;
                line-height: 1.6;
                color: #555;
              "
            >
              点击“开始生成”后，结果将显示在这里...
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="sk-ai-generator-cancel-btn">关闭</button>
          <!-- 这个保存按钮初始是禁用的，生成成功后才会激活 -->
          <button class="save" id="sk-ai-generator-save-btn" disabled>
            保存剧本
          </button>
        </div>
      </div>
    </div>

    <!-- 1. “你说我猜”游戏设置屏幕 -->
    <div id="guess-what-setup-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">‹</span>
        <span>你说我猜 - 游戏设置</span>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label>邀请一位玩伴</label>
          <div
            id="guess-what-player-selection"
            class="list-container"
            style="
              height: 200px;
              border: 1px solid var(--border-color);
              border-radius: 8px;
            "
          >
            <!-- 玩家选择列表将由JS动态生成 -->
          </div>
        </div>
        <div class="form-group">
          <label>选择游戏模式</label>
          <div style="display: flex; gap: 20px">
            <label
              ><input
                type="radio"
                name="guess_what_mode"
                value="ai_guesses"
                checked
              />
              我出题，AI猜</label
            >
            <label
              ><input
                type="radio"
                name="guess_what_mode"
                value="user_guesses"
              />
              AI出题，我猜</label
            >
          </div>
        </div>
        <!-- "我出题"模式下的输入框 -->
        <div class="form-group" id="user-word-input-container">
          <label for="guess-what-user-word">请输入你要出的词</label>
          <input
            type="text"
            id="guess-what-user-word"
            placeholder="例如：苹果、流浪地球..."
          />
        </div>
        <button id="start-guess-what-game-btn" class="form-button">
          开始游戏
        </button>
      </div>
    </div>

    <!-- 2. “你说我猜”游戏主界面 -->
    <div id="guess-what-game-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-guess-what-game-btn">‹ 退出</span>
        <span id="guess-what-game-title">你说我猜</span>
        <span class="action-btn" id="give-up-guess-what-btn">放弃</span>
      </div>
      <!-- 游戏主内容区 -->
      <div
        id="guess-what-game-content"
        style="
          display: flex;
          flex-direction: column;
          height: 100%;
          overflow: hidden;
          padding: 10px;
          box-sizing: border-box;
        "
      >
        <!-- 游戏日志/信息区 -->
        <div
          id="guess-what-log-container"
          style="
            flex-grow: 1;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            margin: 10px 0;
            min-height: 0;
          "
        >
          <div id="guess-what-game-log">
            <!-- 游戏过程信息会显示在这里 -->
          </div>
        </div>
        <!-- 玩家操作区 -->
        <div
          id="guess-what-action-area"
          class="chat-input-area"
          style="visibility: visible"
        >
          <div class="chat-input-main-row">
            <textarea
              id="guess-what-user-input"
              rows="1"
              placeholder="输入提示或猜测..."
            ></textarea>
            <button id="send-guess-what-input-btn" class="action-button">
              发送
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- “你说我猜”游戏结算卡片 -->
    <div id="guess-what-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>游戏结算</span>
        </div>
        <div
          class="modal-body"
          id="guess-what-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- 结算内容将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="forward-guess-what-summary-btn">
            转发给Ta
          </button>
          <button class="save" id="close-guess-what-summary-btn">
            返回大厅
          </button>
        </div>
      </div>
    </div>

    <!-- 1. 飞行棋游戏设置屏幕 -->
    <div id="ludo-setup-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">‹</span>
        <span>心动飞行棋 - 游戏设置</span>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label>选择一位玩伴</label>
          <!-- 邀请列表，我们会用JS来填充 -->
          <div
            id="ludo-player-selection"
            class="list-container"
            style="
              height: 200px;
              border: 1px solid var(--border-color);
              border-radius: 8px;
            "
          ></div>
        </div>

        <div class="form-group">
          <label>选择问题库</label>
          <div style="display: flex; align-items: center; gap: 10px">
            <select
              id="ludo-question-bank-select"
              style="flex-grow: 1"
            ></select>
            <button
              id="manage-ludo-question-banks-btn"
              class="form-button-secondary"
              style="margin-top: 0; padding: 12px; width: auto"
            >
              管理题库
            </button>
          </div>
        </div>

        <button id="start-ludo-game-btn" class="form-button">开始游戏</button>
      </div>
    </div>

    <!-- 2. 飞行棋游戏主界面 -->
    <div id="ludo-game-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-ludo-game-btn">‹ 退出</span>
        <span>心动飞行棋</span>
        <!-- 这里可以放一个重置游戏的按钮 -->
        <span class="action-btn" id="restart-ludo-game-btn" title="重新开始">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
        </span>
      </div>
      <!-- 游戏主内容区 -->
      <div id="ludo-game-content">
        <!-- 棋盘区域 -->
        <div id="ludo-board-container">
          <div id="ludo-board">
            <!-- 棋盘格子将由JS动态生成 -->
          </div>
          <!-- 玩家棋子 -->
          <div id="ludo-user-piece" class="ludo-piece user"></div>
          <div id="ludo-char-piece" class="ludo-piece char"></div>
        </div>

        <!-- 游戏日志区域 -->
        <div id="ludo-log-container">
          <div id="ludo-game-log"></div>
        </div>

        <!-- 玩家操作区 -->
        <div id="ludo-action-area"></div>
      </div>
    </div>

    <!-- 微博私信列表页面 -->
    <div id="weibo-dm-list-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-dm-list">‹</span>
        <span id="weibo-dm-list-title">粉丝私信</span>
        <!-- 这是你要求的“继续生成”按钮 -->
        <div class="header-actions">
          <span
            class="action-btn"
            id="generate-more-dms-btn"
            title="继续生成私信"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
            </svg>
          </span>

          <!-- “清空全部”按钮 -->
          <span class="action-btn" id="clear-all-dms-btn" title="清空全部私信">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
              />
            </svg>
          </span>
        </div>
      </div>
      <div id="weibo-dm-list" class="list-container" style="padding: 0">
        <!-- 私信列表将由JS动态生成 -->
      </div>
    </div>

    <div id="weibo-dm-detail-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-dm-detail">‹</span>
        <span id="weibo-dm-detail-title"></span>
        <span style="width: 30px"></span>
        <!-- 占位符 -->
      </div>
      <div
        id="weibo-dm-messages"
        class="list-container"
        style="
          display: flex;
          flex-direction: column;
          gap: 15px;
          padding: 15px;
          background-color: #f0f2f5;
        "
      >
        <!-- 聊天气泡将由JS动态生成 -->
      </div>
    </div>

    <!-- index.html -->

    <div id="taobao-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>桃宝</span>
        <div class="header-actions">
          <span
            class="action-btn"
            id="clear-taobao-products-btn"
            style="font-size: 16px; font-weight: 500"
            >清空</span
          >
          <span class="action-btn" id="add-product-btn" title="添加商品"
            >+</span
          >
        </div>
      </div>

      <!-- 1. 顶部页签导航 (已加入“饿了么”) -->
      <div class="taobao-tabs">
        <button class="taobao-tab active" data-view="products-view">
          首页
        </button>

        <button class="taobao-tab" data-view="eleme-view">饿了么</button>

        <button class="taobao-tab" data-view="cart-view">
          购物车<span id="cart-item-count-badge" style="display: none">0</span>
        </button>
        <button class="taobao-tab" data-view="orders-view">我的订单</button>
        <button class="taobao-tab" data-view="my-view">我的</button>
      </div>

      <!-- 2. 页面内容容器 -->
      <div class="taobao-content">
        <!-- “首页”视图 (保持不变) -->
        <div id="products-view" class="taobao-view active">
          <div class="taobao-search-bar">
            <input
              type="search"
              id="product-search-input"
              placeholder="搜一搜，让AI为你创造好物！"
            />
            <button id="product-search-btn">搜索</button>
          </div>
          <div id="product-category-tabs"></div>
          <div id="product-grid" class="product-grid"></div>
        </div>

        <div id="eleme-view" class="taobao-view">
          <div class="taobao-search-bar">
            <!-- 新增：这是第一行的“搜索”组 -->
            <div class="eleme-search-group">
              <input
                type="search"
                id="eleme-search-input"
                placeholder="想吃点什么？让AI帮你找！"
              />
              <button id="eleme-search-btn">搜索</button>
            </div>

            <!-- 新增：这是第二行的“功能”组 -->
            <div class="eleme-actions-group">
              <button
                id="eleme-add-manual-btn"
                class="header-actions"
                title="手动添加美食"
              >
                +
              </button>
              <button
                id="eleme-generate-ai-btn"
                class="header-actions"
                title="AI生成美食"
              >
                ✨
              </button>
              <button id="eleme-clear-all-btn" class="header-btn">🗑️</button>
            </div>
          </div>

          <div id="eleme-grid" class="product-grid">
            <!-- 美食列表将由JS动态生成在这里 -->
          </div>
        </div>

        <!-- “购物车”视图 -->
        <div id="cart-view" class="taobao-view">
          <div id="cart-item-list"></div>
          <div id="cart-checkout-bar" style="display: none">
            <div class="total-price">
              合计: <span id="cart-total-price">¥ 0.00</span>
            </div>
            <div style="display: flex; gap: 10px">
              <button id="share-cart-to-char-btn">分享给Ta代付</button>
              <button id="buy-for-char-btn">为Ta购买</button>
              <button id="checkout-btn">结算(0)</button>
            </div>
          </div>
        </div>

        <!-- “我的订单”视图 -->
        <div id="orders-view" class="taobao-view">
          <div id="order-list" class="order-list"></div>
        </div>

        <!-- “我的”视图 -->
        <div id="my-view" class="taobao-view">
          <div id="user-balance-container">
            <p>我的余额</p>
            <h2 id="user-balance-display">¥ 0.00</h2>
            <button id="top-up-btn" class="form-button">给钱包充点钱</button>
          </div>
          <div
            id="balance-details-list"
            class="order-list"
            style="padding: 0 15px"
          ></div>
        </div>
      </div>
    </div>

    <div id="product-detail-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>商品详情</span>
        </div>
        <div class="modal-body" id="product-detail-body">
          <!-- 详情内容将由JS动态生成 -->
        </div>
        <!-- 评价区域 -->
        <div id="product-reviews-section">
          <h3>宝贝评价</h3>
          <div id="product-reviews-list"></div>
          <button
            id="generate-reviews-btn"
            class="form-button form-button-secondary"
          >
            ✨ AI生成评价
          </button>
        </div>

        <div class="modal-footer">
          <button class="cancel" id="close-product-detail-btn">关闭</button>
          <button class="save" id="detail-add-to-cart-btn">加入购物车</button>
        </div>
      </div>
    </div>

    <!-- 2. 添加商品的方式选择弹窗 -->
    <div id="add-product-choice-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-header">选择添加方式</div>
        <div class="custom-modal-footer">
          <button id="add-product-manual-btn">手动添加</button>
          <button id="add-product-link-btn">识别链接</button>
          <button id="add-product-ai-btn">AI生成</button>
          <button
            id="cancel-add-choice-btn"
            style="
              margin-top: 8px;
              border-radius: 8px;
              background-color: #f0f0f0;
            "
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <!-- 3. 手动添加/编辑商品弹窗 -->
    <div id="product-editor-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span id="product-editor-title">添加新商品</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="product-name-input">商品名称</label>
            <input type="text" id="product-name-input" />
          </div>
          <div class="form-group">
            <label for="product-price-input">价格 (元)</label>
            <input type="number" id="product-price-input" />
          </div>
          <div class="form-group">
            <label for="product-image-input">图片 URL</label>
            <input type="text" id="product-image-input" />
          </div>
          <div class="form-group">
            <label for="product-category-input">分类 (选填)</label>
            <input
              type="text"
              id="product-category-input"
              placeholder="例如：衣服, 零食..."
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-product-editor-btn">取消</button>
          <button class="save" id="save-product-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 4. 识别链接弹窗 -->
    <div id="add-from-link-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>粘贴分享文案</span>
        </div>
        <div class="modal-body">
          <textarea
            id="link-paste-area"
            rows="6"
            placeholder="请在这里粘贴完整的淘宝或拼多多分享文案..."
          ></textarea>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-link-paste-btn">取消</button>
          <button class="save" id="confirm-link-paste-btn">识别</button>
        </div>
      </div>
    </div>

    <!-- 物流详情页面 -->
    <div id="logistics-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="logistics-back-btn">‹</span>
        <span>物流详情</span>
        <span style="width: 30px"></span>
        <!-- 占位符，让标题居中 -->
      </div>
      <div id="logistics-content-area" class="list-container">
        <!-- 物流信息将由JS动态生成在这里 -->
      </div>
    </div>

    <!-- 1. “谁是卧底”游戏设置屏幕 -->
    <div id="undercover-setup-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">‹</span>
        <span>谁是卧底 - 游戏设置</span>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label>邀请模式</label>
          <div style="display: flex; gap: 20px">
            <label style="cursor: pointer"
              ><input
                type="radio"
                name="undercover_invite_mode"
                value="manual"
                checked
              />
              手动邀请</label
            >
            <label style="cursor: pointer"
              ><input
                type="radio"
                name="undercover_invite_mode"
                value="random"
              />
              随机邀请</label
            >
          </div>
        </div>

        <!-- 随机邀请的选项 -->
        <div id="undercover-random-invite-options" style="display: none">
          <div class="form-group">
            <label for="undercover-random-player-count"
              >你想邀请几位AI/NPC？ (不含你自己)</label
            >
            <input
              type="number"
              id="undercover-random-player-count"
              min="2"
              max="15"
              value="5"
              style="width: 100%; box-sizing: border-box; padding: 10px"
            />
          </div>
        </div>

        <!-- 手动邀请的选项 -->
        <div id="undercover-manual-invite-options">
          <div class="form-group">
            <label>请勾选要邀请的玩家</label>
            <div
              id="undercover-player-selection"
              class="list-container"
              style="
                height: 350px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
              "
            >
              <!-- 玩家选择列表将由JS动态生成 -->
            </div>
          </div>
        </div>

        <button id="start-undercover-game-btn" class="form-button">
          开始游戏
        </button>
        <p
          style="
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 15px;
          "
        >
          游戏最少需要3人。<br />
          3-5人局：1卧底<br />
          6-8人局：1卧底, 1白板<br />
          9人及以上：2卧底, 1白板
        </p>
      </div>
    </div>

    <!-- 2. “谁是卧底”游戏主界面 -->
    <div id="undercover-game-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-undercover-game-btn">‹ 退出</span>
        <span id="undercover-game-title">谁是卧底</span>
        <span class="action-btn" id="undercover-my-word-btn">我的词语</span>
      </div>
      <!-- 游戏主内容区 -->
      <div
        id="undercover-game-content"
        style="
          display: flex;
          flex-direction: column;
          height: 100%;
          overflow: hidden;
          padding: 10px;
          box-sizing: border-box;
        "
      >
        <!-- 玩家座位区 -->
        <div
          id="undercover-players-grid"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 15px;
            padding: 10px;
            flex-shrink: 0;
          "
        >
          <!-- 玩家头像和状态将由JS动态生成 -->
        </div>
        <!-- 游戏日志/信息区 -->
        <div
          id="undercover-log-container"
          style="
            flex-grow: 1;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            margin: 10px 0;
            min-height: 0;
          "
        >
          <div id="undercover-game-log">
            <!-- 游戏过程信息会显示在这里 -->
          </div>
        </div>
        <!-- 玩家操作区 -->
        <div
          id="undercover-action-area"
          style="
            flex-shrink: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            min-height: 50px;
          "
        >
          <!-- 玩家的按钮会根据游戏阶段显示在这里 -->
        </div>
      </div>
    </div>

    <div id="undercover-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>游戏结算</span>
        </div>
        <div
          class="modal-body"
          id="undercover-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- 结算内容将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <!-- “分享复盘”按钮 -->
          <button class="cancel" id="repost-undercover-summary-btn">
            分享复盘到单聊
          </button>
          <button class="save" id="back-to-hall-from-undercover-btn">
            返回大厅
          </button>
        </div>
      </div>
    </div>

    <!-- 1. User私信列表页面 -->
    <div id="user-dm-list-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-user-dm-list">‹</span>
        <span>我的私信</span>
        <div class="header-actions">
          <!-- 这个按钮用于让AI生成新的粉丝私信 -->
          <span
            class="action-btn"
            id="generate-new-user-dms-btn"
            title="生成新私信"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
            </svg>
          </span>
          <!-- 这个按钮用于清空所有私信 -->
          <span
            class="action-btn"
            id="clear-all-user-dms-btn"
            title="清空所有私信"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
              />
            </svg>
          </span>
        </div>
      </div>
      <div
        id="user-dm-list-container"
        class="list-container"
        style="padding: 0"
      >
        <!-- 私信列表将由JS动态生成在这里 -->
      </div>
    </div>

    <!-- 2. User私信详情页面 (与粉丝聊天) -->
    <div id="user-dm-detail-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-user-dm-detail">‹</span>
        <span id="user-dm-detail-title"></span>
        <!-- 粉丝名字 -->
        <span style="width: 30px"></span>
        <!-- 占位符 -->
      </div>
      <div
        id="user-dm-messages-container"
        class="list-container"
        style="
          display: flex;
          flex-direction: column;
          gap: 15px;
          padding: 15px;
          background-color: #f0f2f5;
        "
      >
        <!-- 聊天气泡将由JS动态生成在这里 -->
      </div>
      <!-- 聊天输入框 -->

      <div id="user-dm-input-area" class="chat-input-area">
        <div class="chat-input-main-row">
          <textarea
            id="user-dm-input"
            rows="1"
            placeholder="和粉丝聊点什么..."
          ></textarea>

          <div id="input-actions-wrapper">
            <!-- 这是新加的“触发AI回应”按钮 -->
            <button
              id="user-dm-trigger-ai-btn"
              class="action-button chat-action-icon-btn"
              title="让对方先说"
            >
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
            </button>
            <!-- 这是新加的“重Roll”按钮 -->
            <button
              id="user-dm-reroll-btn"
              class="action-button chat-action-icon-btn"
              title="重新生成回复"
            >
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>

            <button id="user-dm-send-btn" class="action-button">发送</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 角色微博主页屏幕 -->
    <div id="weibo-char-profile-screen" class="screen">
      <!-- 头部，包含返回按钮和角色名字 -->
      <div class="header">
        <span class="back-btn" id="back-from-char-profile">‹</span>
        <span id="weibo-char-profile-title">角色主页</span>
        <div class="header-actions">
          <span
            class="action-btn"
            id="edit-char-weibo-profile-btn"
            title="编辑角色资料"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 20h9"></path>
              <path
                d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
              ></path>
            </svg>
          </span>
        </div>
      </div>
      <!-- 角色主页的内容区 -->
      <div id="weibo-char-profile-page" class="weibo-profile-page">
        <!-- 复用个人主页的滚动样式 -->
        <div class="weibo-profile-header">
          <img
            id="weibo-char-background-img"
            src="https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg"
            class="weibo-background"
          />
          <div class="weibo-avatar-container">
            <img
              id="weibo-char-avatar-img"
              src="https://files.catbox.moe/q6z5fc.jpeg"
              class="weibo-avatar"
            />
            <img
              id="weibo-char-avatar-frame"
              class="weibo-avatar-frame"
              src=""
              style="display: none"
            />
          </div>
          <div class="weibo-nickname" id="weibo-char-nickname">角色昵称</div>
          <div id="weibo-char-profession-display">角色职业</div>

          <div class="weibo-stats">
            <div
              id="weibo-char-following-item"
              class="weibo-stat-item"
              style="cursor: pointer"
            >
              <span id="weibo-char-following-count" class="weibo-stat-number"
                >0</span
              >
              <span class="weibo-stat-label">关注</span>
            </div>
            <div id="weibo-char-posts-item" class="weibo-stat-item">
              <span id="weibo-char-posts-count" class="weibo-stat-number"
                >0</span
              >
              <span class="weibo-stat-label">微博</span>
            </div>
            <div
              id="weibo-char-fans-item"
              class="weibo-stat-item"
              style="cursor: pointer"
            >
              <span id="weibo-char-fans-count" class="weibo-stat-number"
                >0</span
              >
              <span class="weibo-stat-label">粉丝</span>
            </div>
          </div>
        </div>
        <div
          id="char-weibo-feed-list"
          style="
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
          "
        >
          <!-- 角色的微博列表将由JS动态生成在这里 -->
        </div>
      </div>
    </div>

    <!-- 角色微博资料编辑弹窗 -->
    <div id="char-weibo-editor-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>编辑角色微博资料</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>微博头像</label>
            <div class="avatar-upload">
              <img id="char-weibo-editor-avatar-preview" />
              <button
                onclick="document.getElementById('char-weibo-editor-avatar-input').click()"
              >
                上传头像
              </button>
              <button class="change-frame-btn" data-type="char-weibo">
                更换头像框
              </button>
              <input
                type="file"
                id="char-weibo-editor-avatar-input"
                accept="image/*"
                hidden
              />
            </div>
          </div>
          <div class="form-group">
            <label for="char-weibo-editor-nickname-input">微博昵称</label>
            <input type="text" id="char-weibo-editor-nickname-input" />
          </div>
          <div class="form-group">
            <label>微博背景</label>
            <div class="avatar-upload">
              <img
                id="char-weibo-editor-bg-preview"
                style="width: 120px; height: 67.5px; border-radius: 8px"
              />
              <button
                onclick="document.getElementById('char-weibo-editor-bg-input').click()"
              >
                上传背景
              </button>
              <input
                type="file"
                id="char-weibo-editor-bg-input"
                accept="image/*"
                hidden
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-char-weibo-editor-btn">取消</button>
          <button class="save" id="save-char-weibo-editor-btn">保存</button>
        </div>
      </div>
    </div>

    <div id="date-a-live-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>约会大作战</span>
        <div class="header-actions">
          <!-- “+”号按钮 -->
          <span
            class="action-btn"
            id="create-dating-scene-btn"
            title="创建新场景"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </span>

          <span class="action-btn" id="dating-history-btn" title="历史约会">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
              <polyline points="3 3 3 8 8 8" />
              <path d="M12 6V12L16 14" />
            </svg>
          </span>
          <span
            class="action-btn"
            id="refresh-dating-scene-btn"
            title="刷新场景"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
          </span>
        </div>
      </div>
      <div id="dating-scene-content" class="list-container">
        <!-- 约会场景卡片将由JS动态生成在这里 -->
      </div>
    </div>

    <!-- 宠物功能模态框 -->
    <div id="pet-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 85%">
        <div class="modal-header">
          <span id="pet-modal-title">我的宠物</span>
        </div>
        <div class="modal-body">
          <!-- 宠物信息预览区 -->
          <div
            id="pet-preview-area"
            style="text-align: center; margin-bottom: 20px"
          >
            <div
              id="pet-preview-display"
              style="
                font-size: 60px;
                line-height: 1;
                margin-bottom: 10px;
                cursor: pointer;
              "
              title="点击更换图片"
            ></div>
            <strong id="pet-preview-name" style="font-size: 18px"></strong>
            <p
              id="pet-preview-type"
              style="
                font-size: 14px;
                color: var(--text-secondary);
                margin: 5px 0;
              "
            ></p>
          </div>

          <!-- 宠物数值显示区 -->
          <div id="pet-stats-area" style="display: none">
            <div id="pet-hunger-bar" class="stat-bar-container">
              <span class="stat-label">饱食度</span>
              <div class="stat-bar"><div class="stat-bar-fill">100%</div></div>
            </div>
            <div id="pet-happiness-bar" class="stat-bar-container">
              <span class="stat-label">心情值</span>
              <div class="stat-bar"><div class="stat-bar-fill">100%</div></div>
            </div>
            <div id="pet-intimacy-user-bar" class="stat-bar-container">
              <span class="stat-label">对你的亲密度</span>
              <div class="stat-bar"><div class="stat-bar-fill">50%</div></div>
            </div>
            <div id="pet-intimacy-char-bar" class="stat-bar-container">
              <span class="stat-label">对Ta的亲密度</span>
              <div class="stat-bar"><div class="stat-bar-fill">50%</div></div>
            </div>
          </div>

          <!-- 互动按钮区 (已新增“对话”按钮) -->
          <div
            id="pet-interaction-area"
            style="
              display: flex;
              justify-content: center;
              gap: 15px;
              margin-bottom: 20px;
              padding-bottom: 15px;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <button class="form-button-secondary" data-action="feed">
              喂食
            </button>
            <button class="form-button-secondary" data-action="play">
              玩耍
            </button>
            <button class="form-button-secondary" data-action="touch">
              抚摸
            </button>
            <button class="form-button-secondary" data-action="chat">
              对话
            </button>
          </div>

          <!-- 设置区 -->
          <div class="form-group">
            <label for="pet-type-input">种类 (自由填写)</label>
            <input
              type="text"
              id="pet-type-input"
              placeholder="例如: 小猫, 仓鼠, 太阳花..."
            />
          </div>
          <div class="form-group">
            <label for="pet-name-input">昵称</label>
            <input
              type="text"
              id="pet-name-input"
              placeholder="给它起个名字吧"
            />
          </div>
          <div class="form-group">
            <label for="pet-image-input">初始样子 (Emoji 或 图片URL)</label>
            <input
              type="text"
              id="pet-image-input"
              placeholder="输入一个 Emoji 比如 🐈 或图片链接"
            />
          </div>
          <!-- 人设输入框 -->
          <div class="form-group">
            <label for="pet-persona-input">宠物人设与背景</label>
            <textarea
              id="pet-persona-input"
              rows="3"
              placeholder="描述一下它的性格和故事，AI会根据这个来扮演它。"
            ></textarea>
          </div>
          <div class="form-group">
            <label class="toggle-switch-label">
              <span>在聊天界面显示</span>
              <input type="checkbox" id="pet-display-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>
          <div id="pet-position-controls" style="display: none">
            <div class="form-group">
              <label for="pet-size-slider"
                >大小: <span id="pet-size-value">100px</span></label
              >
              <input
                type="range"
                id="pet-size-slider"
                min="30"
                max="200"
                value="100"
                style="width: 100%"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="pet-abandon-btn"
            style="
              background-color: #ffdde5;
              color: #ff3b30;
              border-color: #ffc2d1;
            "
          >
            放生宠物
          </button>

          <button class="cancel" id="pet-modal-cancel-btn">取消</button>
          <button class="save" id="pet-modal-save-btn">保存</button>
        </div>
      </div>
    </div>

    <input
      type="file"
      id="pet-custom-image-input"
      accept="image/*"
      style="display: none"
    />
    <!-- 宠物聊天模态框 -->
    <div id="pet-chat-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span id="pet-chat-title">和宠物的对话</span>
        </div>
        <div
          id="pet-chat-messages"
          class="modal-body"
          style="
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            gap: 15px;
          "
        >
          <!-- 宠物聊天记录将显示在这里 -->
        </div>
        <!-- 复用主聊天输入框的样式 -->
        <div
          id="pet-chat-input-area"
          class="chat-input-area"
          style="border-top: 1px solid var(--border-color)"
        >
          <div class="chat-input-main-row">
            <textarea
              id="pet-chat-input"
              rows="1"
              placeholder="和它说点什么..."
            ></textarea>
            <button id="send-to-pet-btn" class="action-button">发送</button>
          </div>
        </div>
      </div>
    </div>

    <div id="weibo-char-selector-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>选择生成内容的主角</span>
        </div>
        <div
          class="modal-body"
          id="weibo-char-selector-list"
          style="padding: 0; overflow-y: auto"
        >
          <!-- 角色列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer" style="justify-content: space-between">
          <button
            id="weibo-select-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            全选
          </button>
          <button
            id="weibo-deselect-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            全不选
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="weibo-cancel-char-select-btn">取消</button>
          <button class="save" id="weibo-confirm-char-select-btn">确认</button>
        </div>
      </div>
    </div>

    <!-- 情侣空间-情绪日记编辑弹窗 -->
    <div id="ls-diary-editor-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span id="ls-diary-editor-title">记录今天的心情</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>选择一个表情代表今天的心情</label>
            <div
              id="ls-emoji-selector"
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                font-size: 24px;
                cursor: pointer;
                justify-content: center;
                padding: 10px 0;
              "
            >
              <!-- Emoji将由JS生成 -->
            </div>
          </div>
          <div class="form-group">
            <label for="ls-diary-content-input">写下你的日记</label>
            <textarea
              id="ls-diary-content-input"
              rows="6"
              placeholder="今天发生了什么特别的事吗..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-diary-btn">取消</button>
          <button class="save" id="ls-save-diary-btn">保存日记</button>
        </div>
      </div>
    </div>

    <!-- 情侣空间-日记查看弹窗 -->
    <div id="ls-diary-viewer-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span id="ls-diary-viewer-title">查看日记</span>
        </div>
        <div
          id="ls-diary-viewer-body"
          class="modal-body"
          style="display: flex; flex-direction: column; gap: 20px"
        >
          <!-- 日记内容将由JS动态生成 -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="ls-close-diary-viewer-btn"
            style="width: 100%"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 情侣空间-自定义emoji添加弹窗 -->
    <div id="ls-custom-emoji-modal" class="modal" style="z-index: 1001;">
      <div class="modal-content" style="height: auto; max-width: 350px">
        <div class="modal-header">
          <span>添加自定义表情</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ls-custom-emoji-input">表情（只能输入一个emoji）</label>
            <input
              type="text"
              id="ls-custom-emoji-input"
              placeholder="请输入一个emoji表情"
              maxlength="2"
              style="width: 100%; padding: 10px; box-sizing: border-box; font-size: 24px; text-align: center;"
            />
          </div>
          <div class="form-group">
            <label for="ls-custom-emoji-name-input">表情名称</label>
            <input
              type="text"
              id="ls-custom-emoji-name-input"
              placeholder="例如：超级开心"
              style="width: 100%; padding: 10px; box-sizing: border-box"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-custom-emoji-cancel-btn">取消</button>
          <button class="save" id="ls-custom-emoji-save-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 情侣空间 - 每日足迹日历弹窗 -->
    <div id="ls-activity-calendar-modal" class="modal">
      <div class="modal-content" style="max-width: 380px">
        <div class="modal-header">
          <span id="ls-activity-calendar-title">💕 足迹日历 💕</span>
        </div>
        <div class="modal-body" id="ls-activity-calendar-body"></div>
      </div>
    </div>

    <div id="summary-viewer-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span id="summary-viewer-title">聊天总结</span>
          <button id="add-memory-header-btn" class="add-memory-header-btn" title="新增长期记忆">
            <span class="add-btn-icon">➕</span>
            <span class="add-btn-text">新增</span>
          </button>
        </div>
        <div class="modal-body" id="summary-list" style="padding: 15px">
          <!-- 总结列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer" style="display: flex; gap: 10px">
          <!-- “全部精简”按钮 -->
          <button
            class="form-button-secondary"
            id="concise-all-summaries-btn"
            style="flex: 1; margin: 0"
          >
            全部精简
          </button>
          <button
            class="save"
            id="close-summary-viewer-btn"
            style="flex: 1; margin: 0"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- AI生成商品结果/选择弹窗 -->
    <div id="ai-generated-products-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span id="ai-products-modal-title">AI为你生成了以下宝贝</span>
        </div>
        <div class="modal-body" style="padding: 15px">
          <div id="ai-product-results-grid" class="product-grid"></div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-ai-products-modal-btn"
            style="width: 100%"
          >
            完成
          </button>
        </div>
      </div>
    </div>

    <!-- 飞行棋问题库管理模态框 -->
    <div id="ludo-qbank-manager-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>管理问题库</span>

          <div class="header-actions">
            <span
              class="action-btn"
              id="import-ludo-qbank-btn"
              title="导入题库"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </span>
            <span
              class="action-btn"
              id="add-ludo-qbank-btn"
              style="font-size: 16px"
              >新建</span
            >
          </div>
        </div>
        <div class="modal-body" id="ludo-qbank-list" style="padding: 0">
          <!-- 问题库列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button class="save" id="close-qbank-manager-btn" style="width: 100%">
            完成
          </button>
        </div>
      </div>
    </div>

    <!-- 飞行棋问题编辑器模态框 -->
    <div id="ludo-question-editor-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span class="back-btn" id="back-to-qbank-manager-btn">‹</span>
          <span id="ludo-question-editor-title">编辑问题</span>
          <span
            class="action-btn"
            id="add-ludo-question-btn"
            style="font-size: 28px; font-weight: 300"
            >+</span
          >
        </div>
        <div class="modal-body" id="ludo-question-list" style="padding: 10px">
          <!-- 问题列表将由JS动态生成在这里 -->
        </div>
      </div>
    </div>

    <!-- 飞行棋单个问题编辑器模态框 -->
    <div id="ludo-single-question-editor-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span id="ludo-single-question-title">编辑问题</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ludo-question-text-input">问题内容</label>
            <textarea id="ludo-question-text-input" rows="4"></textarea>
          </div>
          <div class="form-group">
            <label>问题类型</label>
            <div style="display: flex; gap: 20px">
              <label
                ><input
                  type="radio"
                  name="ludo_question_type"
                  value="both_answer"
                  checked
                />
                共同回答</label
              >
              <label
                ><input
                  type="radio"
                  name="ludo_question_type"
                  value="single_answer"
                />
                一人回答,一人评价</label
              >
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-single-question-btn">取消</button>
          <button class="save" id="save-single-question-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 飞行棋游戏结算卡片 -->
    <div id="ludo-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>游戏结算</span>
        </div>
        <div
          class="modal-body"
          id="ludo-summary-content"
          style="text-align: left; line-height: 1.7"
        >
          <!-- 结算内容将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="share-ludo-summary-btn">分享给Ta</button>
          <button class="save" id="back-to-hall-from-ludo-btn">返回大厅</button>
        </div>
      </div>
    </div>
    <!-- “谁是卧底”游戏结算卡片 -->
    <div id="undercover-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>游戏结算</span>
        </div>
        <div
          class="modal-body"
          id="undercover-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- 结算内容将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <!-- “分享复盘”按钮 -->
          <button class="cancel" id="repost-undercover-summary-btn">
            分享复盘到单聊
          </button>
          <button class="save" id="back-to-hall-from-undercover-btn">
            返回大厅
          </button>
        </div>
      </div>
    </div>

    <!-- “谁是卧底”复盘发送目标选择器 -->
    <div id="undercover-target-picker-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>选择要发送的玩家</span>
        </div>
        <div class="modal-body" id="undercover-target-list" style="padding: 0">
          <!-- 玩家列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            id="uc-select-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            全选
          </button>
          <button
            id="uc-deselect-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            全不选
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="uc-cancel-share-btn">取消</button>
          <button class="save" id="uc-confirm-share-btn">确认发送</button>
        </div>
      </div>
    </div>

    <!-- 群公告模态框 -->
    <div id="group-announcement-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>群公告</span>
        </div>
        <div class="modal-body" id="announcement-content-area">
          <!-- 公告内容将显示在这里 -->
        </div>
        <div class="modal-footer" id="announcement-footer">
          <!-- 按钮将由JS动态生成 -->
        </div>
      </div>
    </div>
    <!-- 心声面板样式编辑器弹窗 -->
    <div id="inner-voice-editor-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>编辑心声面板样式</span>
        </div>
        <div class="modal-body">
          <!-- 卡片背景颜色 -->
          <div class="form-group">
            <label for="iv-card-bg-color">卡片背景颜色</label>
            <input
              type="color"
              id="iv-card-bg-color"
              value="#FFFFFF"
              style="width: 100%; height: 40px"
            />
          </div>
          <!-- 卡片透明度 -->
          <div class="form-group">
            <label for="iv-opacity-slider"
              >卡片背景透明度: <span id="iv-opacity-value">70%</span></label
            >
            <input
              type="range"
              id="iv-opacity-slider"
              min="0"
              max="1"
              step="0.05"
              value="0.7"
              style="width: 100%"
            />
          </div>
          <hr style="opacity: 0.2" />
          <!-- 四个标签的背景色 -->
          <div class="form-group">
            <label for="iv-color-clothing">“服装”标签背景色</label>
            <input
              type="color"
              id="iv-color-clothing"
              value="#f0a1a8"
              style="width: 100%; height: 40px"
            />
          </div>
          <div class="form-group">
            <label for="iv-color-behavior">“行为”标签背景色</label>
            <input
              type="color"
              id="iv-color-behavior"
              value="#81c784"
              style="width: 100%; height: 40px"
            />
          </div>
          <div class="form-group">
            <label for="iv-color-thoughts">“心声”标签背景色</label>
            <input
              type="color"
              id="iv-color-thoughts"
              value="#64b5f6"
              style="width: 100%; height: 40px"
            />
          </div>
          <div class="form-group">
            <label for="iv-color-naughty">“坏心思”标签背景色</label>
            <input
              type="color"
              id="iv-color-naughty"
              value="#ba68c8"
              style="width: 100%; height: 40px"
            />
          </div>

          <hr style="opacity: 0.2; margin: 20px 0" />
          <div class="form-group">
            <label for="iv-icon-color">图标颜色</label>
            <input
              type="color"
              id="iv-icon-color"
              value="#ff8a80"
              style="width: 100%; height: 40px"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="iv-editor-cancel-btn">取消</button>
          <button class="save" id="iv-editor-save-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- AI生成群成员模态框 -->
    <div id="ai-generate-members-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>AI 生成群成员</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ai-member-count-input">生成人数 (1-20)</label>
            <input
              type="number"
              id="ai-member-count-input"
              value="3"
              min="1"
              max="20"
            />
          </div>
          <div class="form-group">
            <label for="ai-member-prompt-input">要求 (可选，AI会参考)</label>
            <textarea
              id="ai-member-prompt-input"
              rows="4"
              placeholder="例如：一群喜欢户外探险的大学生，性格各异..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-ai-generate-members-btn">
            取消
          </button>
          <button class="save" id="confirm-ai-generate-members-btn">
            开始生成
          </button>
        </div>
      </div>
    </div>

    <!-- 约会邀请与支付模态框 -->
    <div id="dating-payment-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span id="dating-modal-title">发起约会邀请</span>
        </div>
        <div class="modal-body" style="text-align: center">
          <p>你选择的约会是：</p>
          <h3
            id="dating-modal-scene-name"
            style="color: var(--accent-color); margin: 10px 0"
          ></h3>
          <p id="dating-modal-scene-cost" style="font-weight: bold"></p>
          <hr style="opacity: 0.2; margin: 20px 0" />
          <p>由谁来买单呢？</p>
          <div
            id="dating-payment-options"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <!-- 支付选项按钮将由JS动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="dating-cancel-btn" style="width: 100%">
            下次再说
          </button>
        </div>
      </div>
    </div>

    <!-- 约会角色选择弹窗 -->
    <div id="dating-char-selector-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>选择约会对象</span>
        </div>
        <div
          class="modal-body"
          id="dating-char-selector-list"
          style="padding: 0"
        >
          <!-- 角色列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="dating-cancel-char-select-btn"
            style="width: 100%"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <div id="dating-game-screen" class="screen">
      <!-- 1. 动态背景图 (最底层) -->
      <div id="dating-game-background"></div>

      <!-- 2. 角色立绘容器 (中间层) -->
      <div id="dating-game-sprite-container">
        <img id="dating-game-sprite" src="" />
      </div>

      <!-- 3. UI覆盖层 (最顶层, 包含头部/文本框/选项) -->
      <div class="dating-game-ui-overlay">
        <div class="header">
          <span class="back-btn" id="end-date-btn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M15 18l-6-6 6-6" />
            </svg>
          </span>

          <span id="dating-game-char-name"></span>
          <div class="header-actions">
            <!-- 心形数值条 -->
            <div id="dating-values-container">
              <div id="romance-value" class="value-display">
                <!-- 我们会用JS在这里生成5个粉色心形 -->
              </div>
              <div id="lust-value" class="value-display">
                <!-- 我们会用JS在这里生成5个黄色心形 -->
              </div>
            </div>
            <span class="action-btn" id="dating-bgm-btn" title="背景音乐">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
              </svg>
            </span>
            <span
              class="action-btn"
              id="dating-game-settings-btn"
              title="场景设置"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="3"></circle>
                <path
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                ></path>
              </svg>
            </span>
            <span
              class="action-btn"
              id="dating-game-reroll-btn"
              title="重Roll回应"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </span>
          </div>
        </div>

        <!-- 3b. 底部文本框 -->
        <div class="dating-game-textbox">
          <p id="dating-game-text-content">约会即将开始...</p>
        </div>
        <div id="dating-completion-bar-container">
          <div id="dating-completion-bar-fill"></div>
          <span id="dating-completion-text">0%</span>
        </div>
        <!-- 3c. 玩家操作区 -->
        <div id="dating-game-choices" class="dating-game-choices">
          <!-- 选项按钮将由JS动态生成在这里 -->
        </div>
      </div>
    </div>
    <!-- ▼▼▼ 全新：约会BGM控制面板 ▼▼▼ -->
    <div id="dating-bgm-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>选择背景音乐</span>
        </div>
        <div class="modal-body" style="padding: 15px">
          <!-- 控制按钮 -->
          <div
            class="bgm-controls"
            style="display: flex; gap: 10px; margin-bottom: 15px"
          >
            <button
              id="dating-bgm-random-btn"
              class="form-button-secondary"
              style="flex: 1; margin: 0"
            >
              随机播放
            </button>
            <button
              id="dating-bgm-stop-btn"
              class="form-button-secondary"
              style="
                flex: 1;
                margin: 0;
                background-color: #ffe5e5;
                color: #ff3b30;
                border-color: #ffc2d1;
              "
            >
              停止播放
            </button>
          </div>
          <!-- 音量控制 -->
          <div class="form-group">
            <label for="dating-bgm-volume-slider"
              >音量: <span id="dating-bgm-volume-value">100%</span></label
            >
            <input
              type="range"
              id="dating-bgm-volume-slider"
              min="0"
              max="1"
              step="0.05"
              value="1"
              style="width: 100%"
            />
          </div>
          <hr style="opacity: 0.2" />
          <!-- 歌曲列表 -->
          <div
            id="dating-bgm-playlist"
            class="list-container"
            style="padding: 0; height: calc(100% - 130px)"
          >
            <!-- 曲库将由JS动态生成在这里 -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="dating-bgm-close-btn" style="width: 100%">
            关闭
          </button>
        </div>
      </div>
    </div>
    <!-- ▲▲▲ 新增结束 ▲▲▲ -->

    <!-- 借钱对象选择弹窗（带滚动和头像） -->
    <div id="borrow-money-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>向谁借钱？</span>
        </div>
        <div
          class="modal-body"
          id="borrow-money-char-list"
          style="padding: 0; overflow-y: auto"
        >
          <!-- 借钱对象列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="borrow-money-cancel-btn"
            style="width: 100%"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <div id="dating-game-settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>约会场景设置</span>
        </div>
        <div class="modal-body">
          <!-- 预设管理 (保持不变) -->
          <div class="form-group">
            <label>预设方案</label>
            <div class="bubble-preset-manager">
              <select
                id="dating-preset-select"
                class="form-group select"
              ></select>
              <button id="manage-dating-presets-btn" class="action-btn">
                管理
              </button>
            </div>
          </div>

          <hr style="opacity: 0.2" />

          <!-- 立绘组选择器-->
          <div class="form-group">
            <label>选择角色立绘组</label>
            <div class="bubble-preset-manager">
              <select id="dating-sprite-group-select" class="form-group select">
                <option value="">-- 不使用立绘 --</option>
                <!-- 立绘组将由JS动态填充 -->
              </select>
              <button id="manage-sprite-groups-btn" class="action-btn">
                管理立绘组
              </button>
            </div>
          </div>

          <hr style="opacity: 0.2" />

          <!-- 核心设置 (保持不变) -->
          <div class="form-group">
            <label for="dating-prompt-input">场景/角色提示词 (Prompt)</label>
            <textarea
              id="dating-prompt-input"
              rows="4"
              placeholder="例如：你是一个傲娇但内心温柔的少女，在海边对用户的表白感到不知所措..."
            ></textarea>
          </div>
          <div class="form-group">
            <label for="dating-style-input">文风 (Style)</label>
            <textarea
              id="dating-style-input"
              rows="3"
              placeholder="例如：请使用细腻的心理描写和优美的风景描写..."
            ></textarea>
          </div>
          <div class="form-group">
            <label>约会背景图</label>
            <div class="bg-upload-container">
              <button
                class="form-button-secondary"
                onclick="document.getElementById('dating-bg-upload-input').click()"
                style="margin-top: 0"
              >
                上传图片
              </button>
              <input
                type="text"
                id="dating-bg-url-input"
                placeholder="或粘贴网络图片URL"
                style="flex-grow: 1"
              />
            </div>
            <input
              type="file"
              id="dating-bg-upload-input"
              accept="image/*"
              hidden
            />
          </div>
          <hr style="opacity: 0.2; margin: 15px 0" />

          <div class="form-group">
            <label>额外挂载世界书 (本次约会)</label>
            <!-- 复用主设置的样式，非常方便 -->
            <div class="custom-multiselect" id="dating-wb-multiselect">
              <div class="select-box moe-input">
                <span class="selected-options-text"
                  >-- 点击选择额外世界观 --</span
                >
                <span class="arrow-down">▼</span>
              </div>
              <!-- 注意这个容器的 ID 是新的，防止冲突 -->
              <div
                id="dating-wb-checkboxes-container"
                class="checkboxes-container"
              >
                <!-- 选项将由JS动态生成 -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-dating-settings-btn">取消</button>
          <button class="save" id="save-dating-settings-btn">应用并保存</button>
        </div>
      </div>
    </div>

    <!-- 1. 立绘组管理弹窗 -->
    <div id="sprite-group-manager-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>管理立绘组</span>
          <span
            class="action-btn"
            id="create-new-sprite-group-btn"
            style="font-size: 16px"
            >新建</span
          >
        </div>
        <div
          class="modal-body"
          id="sprite-group-list-container"
          style="padding: 0"
        >
          <!-- 立绘组列表将由JS动态生成 -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-sprite-group-manager-btn"
            style="width: 100%"
          >
            完成
          </button>
        </div>
      </div>
    </div>

    <!-- 2. 立绘组编辑器弹窗 -->
    <div id="sprite-editor-modal" class="modal">
      <div class="modal-content" style="height: 90%">
        <div class="modal-header">
          <span id="sprite-editor-title">编辑立绘组</span>
        </div>
        <div class="modal-body" id="sprite-editor-body">
          <div class="form-group">
            <label for="sprite-group-name-input">立绘组名称</label>
            <input
              type="text"
              id="sprite-group-name-input"
              placeholder="例如：日常、战斗、害羞..."
            />
          </div>
          <hr style="opacity: 0.2" />
          <label>立绘列表</label>
          <div
            id="sprite-list-editor"
            style="
              display: flex;
              flex-direction: column;
              gap: 15px;
              margin-top: 10px;
            "
          >
            <!-- 单个立绘的编辑卡片将由JS动态生成 -->
          </div>
          <button
            id="add-new-sprite-btn"
            class="form-button form-button-secondary"
            style="margin-top: 20px"
          >
            + 添加一个新立绘
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-sprite-editor-btn">取消</button>
          <button class="save" id="save-sprite-editor-btn">保存立绘组</button>
        </div>
      </div>
    </div>

    <!-- 约会结算卡片 -->
    <div id="dating-summary-overlay" class="modal">
      <div class="dating-summary-card">
        <div class="dating-summary-card-inner">
          <!-- 卡片正面 -->
          <div class="card-front">
            <img id="summary-card-avatar" src="" alt="角色头像" />
            <h2 id="summary-card-rating"></h2>
            <p class="summary-card-tip">点击卡片查看完整约会记录</p>
            <div class="summary-card-actions">
              <button id="summary-share-btn">分享给Ta</button>
              <button id="summary-close-btn">关闭</button>
            </div>
          </div>
          <!-- 卡片背面 -->
          <div class="card-back">
            <div class="card-back-header">
              <span>完整约会记录</span>
              <button id="summary-flip-back-btn">返回</button>
            </div>
            <div id="summary-card-history" class="card-back-content">
              <!-- 约会历史记录将由JS动态生成在这里 -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <input
      type="file"
      id="dating-summary-image-upload"
      accept="image/*"
      hidden
    />

    <div id="tukey-accounting-screen" class="screen">
      <!-- 1. 页面头部 (保持不变) -->
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span id="tukey-header-title">记账群聊</span>
        <span style="width: 30px"></span>
      </div>

      <!-- 2. 页面内容容器 (保持不变) -->
      <div class="tukey-content">
        <!-- 视图1: 钱包 (这是我们要修改的核心) -->
        <div id="tukey-wallet-view" class="tukey-view">
          <div id="wallet-summary-card">
            <div class="summary-item net-assets">
              <span class="label">净资产</span>
              <span class="value" id="net-assets-value">¥ 0.00</span>
            </div>
            <div class="summary-details">
              <div class="summary-item">
                <span class="label">总资产</span>
                <span class="value" id="total-assets-value">¥ 0.00</span>
              </div>
              <div class="summary-item">
                <span class="label">总负债</span>
                <span class="value" id="total-liabilities-value">¥ 0.00</span>
              </div>
            </div>
          </div>
          <div id="wallet-accounts-list">
            <!-- 账户列表将由JS动态生成在这里 -->
          </div>
          <button
            id="add-new-account-fab"
            class="ls-fab-btn"
            title="添加新账户"
          >
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <line
                x1="12"
                y1="5"
                x2="12"
                y2="19"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
              <line
                x1="5"
                y1="12"
                x2="19"
                y2="12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div id="tukey-reports-view" class="tukey-view">
          <!-- 1. 报表控制/筛选区域 -->
          <div class="report-controls">
            <select id="report-account-filter">
              <!-- 账户选项将由JS动态生成 -->
            </select>
            <select id="report-month-filter">
              <!-- 月份选项将由JS动态生成 -->
            </select>
            <select id="report-type-filter">
              <option value="daily_details">每日明细</option>
              <option value="monthly_summary">月度统计</option>
            </select>
          </div>

          <!-- 2. 报表内容显示区域 -->
          <div id="report-display-area">
            <!-- 视图切换容器 -->
            <div id="daily-report-view" class="report-view active">
              <!-- 每日明细将由JS动态生成在这里 -->
              <p class="report-placeholder">正在加载报表...</p>
            </div>
            <div id="monthly-report-view" class="report-view">
              <!-- 月度统计将由JS动态生成在这里 -->
              <div id="monthly-summary-card">
                <!-- 月度总收支 -->
              </div>
              <div class="chart-container">
                <h3>支出分类占比</h3>
                <canvas id="category-pie-chart"></canvas>
              </div>
              <div class="chart-container">
                <h3>月度支出趋势</h3>
                <canvas id="expenditure-line-chart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div id="tukey-group-chat-view" class="tukey-view active">
          <!-- 这个容器会在没有群聊时显示 -->
          <div id="tukey-no-group-placeholder">
            <p>你还没有创建记账群聊哦</p>
            <button id="tukey-create-group-btn" class="form-button">
              立即创建
            </button>
          </div>

          <div id="tukey-group-chat-container" style="display: none">
            <div id="tukey-group-chat-header">
              <span id="tukey-group-name">群聊名称</span>
              <button id="tukey-group-settings-btn" title="群聊设置">⚙️</button>
            </div>

            <!-- 记账和回复历史记录 -->
            <div id="tukey-records-list">
              <!-- JS会在这里渲染内容 -->
            </div>

            <!-- 记账输入区域 -->
            <div id="tukey-record-input-area">
              <button id="tukey-add-record-btn">+</button>
            </div>

            <div id="tukey-record-input-card">
              <div class="card-header">
                <button class="close-card-btn">×</button>
                <div class="type-selector">
                  <button class="type-btn active" data-type="expense">
                    支出
                  </button>
                  <button class="type-btn" data-type="income">收入</button>
                </div>
              </div>
              <div class="card-body">
                <!-- 金额和备注输入区域 -->
                <div class="input-fields">
                  <div class="amount-input-wrapper">
                    <span class="currency-symbol">¥</span>
                    <input
                      type="number"
                      id="tukey-card-amount-input"
                      placeholder="0.00"
                    />
                    <!-- 已选分类显示区 -->
                    <div id="tukey-card-selected-category">
                      <img src="" alt="" />
                      <span>请选择分类</span>
                    </div>
                  </div>
                  <input
                    type="text"
                    id="tukey-card-remarks-input"
                    placeholder="点击输入备注..."
                  />
                </div>
                <!-- 分类网格 -->
                <div class="category-grid">
                  <!-- 分类将由JS动态生成 -->
                </div>
              </div>
              <div class="card-footer">
                <!-- 账户和时间选择器 -->
                <div class="additional-options">
                  <div class="option-item">
                    <label for="tukey-card-account-select">账户</label>
                    <select id="tukey-card-account-select">
                      <!-- 账户将由JS动态生成 -->
                    </select>
                  </div>
                  <div class="option-item">
                    <label for="tukey-card-time-input">时间</label>
                    <input type="datetime-local" id="tukey-card-time-input" />
                  </div>
                </div>
                <button id="tukey-save-from-card-btn">保 存</button>
              </div>
            </div>
          </div>
        </div>

        <div id="tukey-settings-view" class="tukey-view">
          <div class="form-container" style="padding-top: 20px">
            <!-- 1. 个人资料设置 -->
            <div class="form-group">
              <label>我的个人资料</label>
              <div class="avatar-upload">
                <img
                  id="tukey-user-avatar-preview"
                  src="https://i.postimg.cc/PxZrFFFL/o-o-1.jpg"
                />
                <button
                  onclick="document.getElementById('tukey-user-avatar-input').click()"
                >
                  上传我的头像
                </button>
                <input
                  type="file"
                  id="tukey-user-avatar-input"
                  accept="image/*"
                  hidden
                />
              </div>
            </div>
            <div class="form-group">
              <label for="tukey-user-name-input">用户名</label>
              <input
                type="text"
                id="tukey-user-name-input"
                placeholder="输入你在群聊中显示的昵称"
              />
            </div>
            <div class="form-group">
              <label for="tukey-user-profession-input">职业 (选填)</label>
              <input
                type="text"
                id="tukey-user-profession-input"
                placeholder="你的职业，会展示给群友"
              />
            </div>

            <hr style="opacity: 0.2; margin: 20px 0" />

            <!-- 2. 同步设置 -->
            <div class="form-group">
              <label for="sync-to-taobao-toggle" class="toggle-switch-label">
                <span class="toggle-switch-text">
                  同步至桃宝余额
                  <p
                    style="
                      font-size: 12px;
                      font-weight: normal;
                      color: #999;
                      margin-top: 5px;
                    "
                  >
                    开启后，所有记账记录将同步影响桃宝的余额和收支明细。
                  </p>
                </span>
                <input type="checkbox" id="sync-to-taobao-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>

            <hr style="opacity: 0.2; margin: 20px 0" />

            <!-- 3. 导出设置 (新增) -->
            <div class="form-group">
              <label>数据导出</label>
              <button
                id="export-tukey-report-btn"
                class="form-button form-button-secondary"
              >
                导出账单为 Excel
              </button>
            </div>

            <button class="form-button" id="save-tukey-settings-btn">
              保存所有设置
            </button>
          </div>
        </div>
      </div>

      <!-- 3. 底部导航栏 (保持不变) -->
      <div id="tukey-bottom-nav">
        <div class="tukey-nav-item" data-view="tukey-wallet-view">
          <svg width="24" height="24" viewBox="0 0 1024 1024">
            <path
              d="M517.7 660c-4 26.6-19.2 46.3-37.3 46.3H290.1c-21.2 0-38.4-27-38.4-60.3V435.3c0-33.3 17.2-60.3 38.4-60.3h190.3c17.6 0 32.5 18.7 37 44.1"
              fill="#BAF4EA"
            ></path>
            <path
              d="M668.7 761.8H321.6c-54 0-97.9-43.9-97.9-97.9V419.6c0-54 43.9-97.9 97.9-97.9h347.1c43.8 0 82.6 29.5 94.4 71.6 4.1 14.9-4.6 30.3-19.5 34.5-14.9 4.1-30.3-4.6-34.5-19.5-5-18-21.6-30.6-40.4-30.6H321.6c-23.1 0-41.9 18.8-41.9 41.9v244.3c0 23.1 18.8 41.9 41.9 41.9h347.1c19.5 0 36.3-13.2 40.8-32.2 3.6-15 18.7-24.3 33.7-20.8 15 3.6 24.3 18.7 20.8 33.7-5 21.1-17.1 40.2-34.1 53.8-17.3 13.9-39 21.5-61.2 21.5z"
              fill="#2D5B56"
            ></path>
            <path
              d="M719.9 614.4H641c-39.9 0-72.6-32.7-72.6-72.6 0-39.9 32.7-72.6 72.6-72.6h78.9c39.9 0 72.6 32.7 72.6 72.6 0 39.9-32.7 72.6-72.6 72.6z"
              fill="#BAF4EA"
            ></path>
            <path
              d="M719.9 642.4H641c-55.5 0-100.6-45.1-100.6-100.6 0-55.5 45.1-100.6 100.6-100.6h78.9c55.5 0 100.6 45.1 100.6 100.6 0 55.4-45.2 100.6-100.6 100.6zM641 497.1c-24.6 0-44.6 20-44.6 44.6s20 44.6 44.6 44.6h78.9c24.6 0 44.6-20 44.6-44.6s-20-44.6-44.6-44.6H641z"
              fill="#2D5B56"
            ></path>
            <path
              d="M650.1 542.4m-0.4 0a0.4 0.4 0 1 0 0.8 0 0.4 0.4 0 1 0-0.8 0Z"
              fill="#FFFFFF"
            ></path>
            <path
              d="M650.1 570.8c-15.7 0-28.4-12.7-28.4-28.4s12.7-28.4 28.4-28.4 28.4 12.7 28.4 28.4-12.7 28.4-28.4 28.4z m0-56c-15.2 0-27.6 12.4-27.6 27.6s12.4 27.6 27.6 27.6 27.6-12.4 27.6-27.6-12.4-27.6-27.6-27.6z"
              fill="#2D5B56"
            ></path>
            <path
              d="M155.2 152.2c12 0 21.7 9.7 21.7 21.7s-9.7 21.7-21.7-21.7-21.7-9.7-21.7-21.7 9.7-21.7 21.7-21.7m0-40c-34 0-61.7 27.7-61.7 61.7s27.7 61.7 61.7 61.7 61.7-27.7 61.7-61.7-27.7-61.7-61.7-61.7zM162.7 956.8h-0.2c-8.3-0.1-14.9-6.9-14.8-15.2l1-69.5c0.1-8.2 6.8-14.8 15-14.8h0.2c8.3 0.1 14.9 6.9 14.8 15.2l-1 69.5c-0.1 8.2-6.8 14.8-15 14.8z"
              fill="#2D5B56"
            ></path>
            <path
              d="M212.9 907.5v0.2c-0.1 8.3-6.9 14.9-15.2 14.8l-69.5-1c-8.2-0.1-14.8-6.8-14.8-15v-0.2c0.1-8.3 6.9-14.9 15.2-14.8l69.5 1c8.3 0.2 14.8 6.9 14.8 15z"
              fill="#2D5B56"
            ></path>
            <path
              d="M895.4 905.5m-30.9 0a30.9 30.9 0 1 0 61.8 0 30.9 30.9 0 1 0-61.8 0Z"
              fill="#2D5B56"
            ></path>
            <path
              d="M121.4 613.5m-20.7 0a20.7 20.7 0 1 0 41.4 0 20.7 20.7 0 1 0-41.4 0Z"
              fill="#2D5B56"
            ></path>
            <path
              d="M861.5 115.5v30.8M861.5 156.3c-5.5 0-10-4.5-10-10v-30.8c0-5.5 4.5-10 10-10s10 4.5 10 10v30.8c0 5.5-4.5 10-10 10zM804.8 172.2h30.8M835.6 182.2h-30.8c-5.5 0-10-4.5-10-10s4.5-10 10-10h30.8c5.5 0 10 4.5 10 10s-4.5 10-10 10zM887.4 172.2h30.8M918.2 182.2h-30.8c-5.5 0-10-4.5-10-10s4.5-10 10-10h30.8c5.5 0 10 4.5 10 10s-4.5 10-10 10z"
              fill="#2D5B56"
            ></path>
            <path
              d="M821.4 212.3l21.8-21.8M821.4 222.3c-2.6 0-5.1-1-7.1-2.9-3.9-3.9-3.9-10.2 0-14.1l21.8-21.8c3.9-3.9 10.2-3.9 14.1 0 3.9 3.9 3.9 10.2 0 14.1l-21.8 21.8c-1.8 1.9-4.4 2.9-7 2.9z"
              fill="#2D5B56"
            ></path>
            <path
              d="M879.8 153.9l21.8-21.8M879.8 163.9c-2.6 0-5.1-1-7.1-2.9-3.9-3.9-3.9-10.2 0-14.1l21.8-21.8c3.9-3.9 10.2-3.9 14.1 0 3.9 3.9 3.9 10.2 0 14.1L886.9 161c-2 1.9-4.5 2.9-7.1 2.9z"
              fill="#2D5B56"
            ></path>
            <path
              d="M901.6 212.3l-21.8-21.8M901.6 222.3c-2.6 0-5.1-1-7.1-2.9l-21.8-21.8c-3.9-3.9-3.9-10.2 0-14.1 3.9-3.9 10.2-3.9 14.1 0l21.8 21.8c3.9 3.9 3.9 10.2 0 14.1-1.9 1.9-4.5 2.9-7 2.9z"
              fill="#2D5B56"
            ></path>
            <path
              d="M843.2 153.9l-21.8-21.8M843.2 163.9c-2.6 0-5.1-1-7.1-2.9l-21.8-21.8c-3.9-3.9-3.9-10.2 0-14.1 3.9-3.9 10.2-3.9 14.1 0l21.8 21.8c3.9 3.9 3.9 10.2 0 14.1-1.9 1.9-4.4 2.9-7 2.9z"
              fill="#2D5B56"
            ></path>
          </svg>
          <span>钱包</span>
        </div>
        <div class="tukey-nav-item" data-view="tukey-reports-view">
          <svg width="24" height="24" viewBox="0 0 1024 1024">
            <path
              d="M692.24 787.29h-175.3a24.65 24.65 0 0 1 0-49.3h175.3a24.65 24.65 0 0 1 0 49.3z"
              fill="#303030"
              p-id="13093"
            ></path>
            <path
              d="M692.24 186.92v89.18H336.29v463.27h-89.34V186.92h445.29z"
              fill="#279ACC"
              p-id="13094"
            ></path>
            <path
              d="M810.83 869.58H322.21V660.12a24.65 24.65 0 0 1 49.3 0v160.16h390V318.74h-390v148.19a24.65 24.65 0 1 1-49.3 0V269.44h488.62z"
              fill="#303030"
              p-id="13095"
            ></path>
            <path
              d="M346.86 767H225.28V166.87H713.9v127.22a24.65 24.65 0 1 1-49.29 0v-77.93h-390v501.55h72.28a24.65 24.65 0 1 1 0 49.29z"
              fill="#303030"
              p-id="13096"
            ></path>
            <path
              d="M751.63 395.07m-78.65 0a78.65 78.65 0 1 0 157.3 0 78.65 78.65 0 1 0-157.3 0Z"
              fill="#279ACC"
              p-id="13097"
            ></path>
            <path
              d="M317.28 626.59a24.65 24.65 0 0 1-17.42-42.07l89.58-89.59c10.84-10.85 25-16.36 40.58-16.34a55.34 55.34 0 0 1 39.89 18l64.43 69.85 150.17-148a24.65 24.65 0 0 1 34.63 35.08l-150 148.05a49.43 49.43 0 0 1-71-1.66L433.68 530a6.42 6.42 0 0 0-4.65-2.1 5.84 5.84 0 0 0-4.73 1.91l-89.59 89.59a24.58 24.58 0 0 1-17.43 7.19z"
              fill="#303030"
              p-id="13098"
            ></path>
            <path
              d="M751.63 481.75a86.67 86.67 0 1 1 86.67-86.67 86.77 86.77 0 0 1-86.67 86.67z m0-124A37.38 37.38 0 1 0 789 395.08a37.42 37.42 0 0 0-37.37-37.38z"
              fill="#303030"
              p-id="13099"
            ></path>
          </svg>
          <span>报表</span>
        </div>
        <div class="tukey-nav-item active" data-view="tukey-group-chat-view">
          <svg width="24" height="24" viewBox="0 0 1024 1024">
            <path
              d="M134.588 151C118.247 151 105 164.247 105 180.584v557.964c0 16.339 13.255 29.584 29.599 29.584h155.746l31.872 99.6c2.489 7.777 8.981 9.197 14.504 3.169l94.146-102.769h457.72c16.341 0 29.59-13.247 29.59-29.584V180.584c0-16.339-13.248-29.584-29.588-29.584H134.588z"
              fill="#0FC8B2"
              p-id="32320"
            ></path>
            <path
              d="M511.213 422c19.045 0 34.484 15.44 34.484 34.486s-15.44 34.483-34.484 34.483c-19.046 0-34.485-15.438-34.485-34.483 0-19.046 15.439-34.486 34.485-34.486z m-199.727 0c19.046 0 34.483 15.44 34.483 34.486s-15.437 34.483-34.483 34.483S277 475.531 277 456.486C277 437.44 292.44 422 311.486 422z m399.454 0c19.045 0 34.485 15.439 34.485 34.484 0 19.046-15.439 34.483-34.485 34.483-19.045 0-34.485-15.438-34.485-34.483 0-19.045 15.44-34.484 34.485-34.484z"
              fill="#FFFFFF"
              p-id="32321"
            ></path>
          </svg>
          <span>记账群聊</span>
        </div>
        <div class="tukey-nav-item" data-view="tukey-settings-view">
          <svg width="24" height="24" viewBox="0 0 1024 1024">
            <path
              d="M785.749333 564.770133a231.150933 231.150933 0 0 0 47.035734-258.730666l-145.476267 145.442133a41.5744 41.5744 0 0 1-58.811733 0l-55.876267-55.876267a41.5744 41.5744 0 0 1 0-58.811733l145.476267-145.476267a230.843733 230.843733 0 0 0-305.834667 305.664l-263.509333 263.406934a41.5744 41.5744 0 0 0 0 58.811733l55.842133 55.842133a41.5744 41.5744 0 0 0 58.811733 0l263.406934-263.3728a230.638933 230.638933 0 0 0 258.730666-47.069866l0.170667 0.170666z"
              fill="#FFFFFF"
              p-id="33627"
            ></path>
            <path
              d="M435.2 214.084267a264.977067 264.977067 0 0 1 297.028267-53.828267 34.133333 34.133333 0 0 1 10.001066 55.227733l-145.476266 145.442134a7.441067 7.441067 0 0 0 0 10.581333l55.876266 55.842133a7.441067 7.441067 0 0 0 10.5472 0l145.476267-145.476266a34.133333 34.133333 0 0 1 55.227733 10.069333 265.216 265.216 0 0 1-54.033066 296.96 34.474667 34.474667 0 0 1-3.208534 2.833067l-0.238933 0.170666-3.925333 3.822934a264.704 264.704 0 0 1-262.144 57.7536l-5.290667-1.8432-247.5008 247.534933a75.707733 75.707733 0 0 1-102.741333 4.027733l-4.334934-4.027733-55.876266-55.842133a75.707733 75.707733 0 0 1 0-107.1104l247.7056-247.569067-1.809067-5.2224a265.216 265.216 0 0 1 57.719467-262.075733l6.997333-7.2704z m211.285333-7.850667a196.539733 196.539733 0 0 0-163.0208 56.1152 196.983467 196.983467 0 0 0-40.072533 220.535467 34.133333 34.133333 0 0 1-6.9632 38.229333l-263.5776 263.406933a7.441067 7.441067 0 0 0 0 10.513067l55.876267 55.876267a7.441067 7.441067 0 0 0 10.5472 0l263.406933-263.406934a34.133333 34.133333 0 0 1 38.229333-6.929066 196.5056 196.5056 0 0 0 220.501334-40.072534l1.9456-1.7408 4.334933-4.5056a196.8128 196.8128 0 0 0 50.107733-156.672l-1.058133-7.304533-105.301333 105.335467a75.707733 75.707733 0 0 1-102.741334 4.027733l-4.334933-4.027733-55.876267-55.876267a75.707733 75.707733 0 0 1 0-107.076267l105.3696-105.3696-7.3728-1.058133z"
              fill="#222222"
              p-id="33628"
            ></path>
            <path
              d="M284.8768 690.858667a34.133333 34.133333 0 0 1 48.298667 48.264533l-61.781334 61.7472a34.133333 34.133333 0 1 1-48.264533-48.264533l61.781333-61.781334z"
              fill="#009898"
              p-id="33629"
            ></path>
          </svg>
          <span>设置</span>
        </div>
      </div>
    </div>

    <!-- ... </div> 标签来自 id="tukey-accounting-screen" -->

    <!-- 兔k记账导出选项模态框 -->
    <div id="tukey-export-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 70%">
        <div class="modal-header">
          <span>选择要导出的账户</span>
        </div>
        <div class="modal-body">
          <div id="tukey-export-account-list" class="contact-picker-list">
            <!-- 账户列表将由JS动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-tukey-export-btn">取消</button>
          <button class="save" id="confirm-tukey-export-btn">确认导出</button>
        </div>
      </div>
    </div>

    <!-- 1. 查岗 - 角色选择屏幕 -->
    <div id="kk-char-selection-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>要查谁的岗？</span>
        <span style="width: 30px"></span>
      </div>
      <div id="kk-char-selection-list" class="list-container">
        <!-- 角色列表将由JS动态生成 -->
      </div>
    </div>

    <!-- 2. 查岗 - 房屋总览屏幕 -->
    <div id="kk-house-view-screen" class="screen">
      <div id="kk-house-background"></div>
      <div
        class="header"
        style="
          background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.6),
            transparent
          );
          border-bottom: none;
        "
      >
        <span class="back-btn" id="kk-back-from-house-view">‹</span>
        <span id="kk-house-owner-name"></span>
        <!-- 标题会自动居中 -->

        <div class="header-actions">
          <!-- 这里只保留“继续翻找”和“重新翻找” -->
          <span class="action-btn" id="kk-continue-search-btn" title="继续翻找">
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </span>
          <span class="action-btn" id="kk-reset-search-btn" title="重新翻找">
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
              ></path>
              <path d="M3 3v5h5"></path>
            </svg>
          </span>
        </div>
      </div>
      <div
        id="kk-scene-toolbar"
        style="
          position: absolute;
          top: 110px;
          right: 20px;
          display: flex;
          flex-direction: column;
          gap: 16px;
          z-index: 10;
        "
      >
        <!-- 衣柜按钮 -->
        <!-- 重点修复：加了 box-shadow: none 等重置属性，防止旧样式干扰 -->
        <div
          id="kk-wardrobe-btn"
          title="查看衣柜"
          style="
            width: 48px;
            height: 48px;
            border-radius: 50%;
            /* 强制重置旧样式 */
            margin: 0;
            padding: 0;
            /* 水晶果冻风格核心 */
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6); /* 唯一保留的高光边框 */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); /* 柔和投影 */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ff9a9e; /* 樱花粉图标 */
            transition: transform 0.2s;
          "
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="filter: drop-shadow(0 2px 4px rgba(255, 154, 158, 0.3))"
          >
            <path
              d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"
            ></path>
          </svg>
        </div>

        <!-- 监控按钮 -->
        <div
          id="kk-surveillance-icon"
          title="查看监控"
          style="
            width: 48px;
            height: 48px;
            border-radius: 50%;
            /* 强制重置旧样式 */
            position: static;
            top: auto;
            left: auto;
            /* 水晶果冻风格核心 */
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ff9a9e; /* 樱花粉图标 */
            transition: transform 0.2s;
          "
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="filter: drop-shadow(0 2px 4px rgba(255, 154, 158, 0.3))"
          >
            <path d="M23 7l-7 5 7 5V7z"></path>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
          </svg>
        </div>
      </div>

      <div id="kk-house-info-panel">
        <h2 id="kk-house-location"></h2>
        <p id="kk-house-description"></p>
        <div id="kk-house-areas">
          <!-- 房屋区域按钮将由JS动态生成 -->
        </div>
      </div>
    </div>

    <!-- 3. 查岗 - 区域探索屏幕 -->
    <div id="kk-area-view-screen" class="screen">
      <div id="kk-area-background"></div>
      <div
        class="header"
        style="
          background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.6),
            transparent
          );
          border-bottom: none;
        "
      >
        <span class="back-btn" id="kk-back-from-area-view">‹</span>
        <span id="kk-area-name"></span>
        <span style="width: 30px"></span>
      </div>
      <div class="kk-item-list-container">
        <h3 id="kk-area-description"></h3>
        <p class="kk-instruction-text">点击下方物品进行翻找：</p>
        <div id="kk-area-items-grid">
          <!-- 可翻找物品将由JS动态生成 -->
        </div>
      </div>
    </div>
    <!-- kk查岗-监控屏幕 -->
    <div id="kk-monitor-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="kk-back-from-monitor">‹</span>
        <span id="kk-monitor-title">监控中心</span>
        <div class="header-actions">
          <!-- 刷新监控按钮：统一成刷新箭头 -->
          <span
            class="action-btn"
            id="kk-refresh-monitor-btn"
            title="刷新监控画面"
          >
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M23 4v6h-6"></path>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
          </span>
        </div>
      </div>
      <div id="kk-monitor-grid" class="list-container">
        <!-- 监控画面将由JS动态生成在这里 -->
      </div>
    </div>

    <!-- 4. 查岗 - 电脑屏幕 (模态框) -->
    <div id="kk-computer-modal" class="modal">
      <div
        class="modal-content"
        style="
          width: 95%;
          height: 90%;
          max-width: 500px;
          background-color: #e0e0e0;
        "
      >
        <div class="modal-header" id="kk-computer-header">
          <span>的电脑</span>
          <span id="close-kk-computer-modal" style="cursor: pointer">×</span>
        </div>
        <div class="modal-body" id="kk-computer-desktop">
          <!-- 电脑桌面图标将由JS动态生成 -->
        </div>
      </div>
    </div>

    <!-- 6. 查岗 - 文件浏览器模态框 -->
    <div id="kk-file-explorer-modal" class="modal" style="z-index: 1003">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>私人文件</span>
        </div>
        <div class="modal-body" id="kk-file-list">
          <!-- 文件列表将由JS动态生成 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="close-file-explorer-modal-btn">
            关闭
          </button>
        </div>
      </div>
    </div>
    <!-- KK查岗 - 沉浸式衣帽间屏幕 -->
    <div id="kk-wardrobe-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="kk-back-from-wardrobe">‹</span>
        <span>Ta的衣帽间</span>
        <div class="header-actions">
          <!-- 新增：添加衣服按钮 -->
          <span
            class="action-btn"
            id="kk-wardrobe-add-btn"
            title="添置新衣"
            style="font-size: 24px; font-weight: 300; margin-right: 10px"
            >+</span
          >
          <span
            class="action-btn"
            id="kk-wardrobe-refresh-btn"
            title="重置衣柜 (清空重来)"
            >↻</span
          >
        </div>
      </div>

      <!-- 衣柜主区域 -->
      <div id="wardrobe-container">
        <!-- 左侧/顶部：搭配预览与角色立绘区 -->
        <div id="wardrobe-preview-area">
          <img id="wardrobe-char-avatar" src="" alt="角色" />

          <!-- 新增：用于显示角色对衣服看法的气泡 (默认显示提示) -->
          <div
            id="wardrobe-comment-bubble"
            style="
              display: block;
              background: #fff;
              padding: 10px;
              border-radius: 12px;
              margin: 10px;
              font-size: 13px;
              color: #555;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
              min-height: 40px;
              position: relative;
            "
          >
            <span class="content">点击下面的衣服，看看我怎么说~</span>
            <!-- 小三角 -->
            <div
              style="
                position: absolute;
                bottom: -6px;
                left: 20px;
                width: 0;
                height: 0;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-top: 6px solid #fff;
              "
            ></div>
          </div>

          <!-- 这里的气泡用于显示试穿后的反应 (保留原有) -->
          <div id="wardrobe-reaction-bubble" style="display: none">
            <div class="content"></div>
          </div>

          <!-- 当前选中的搭配展示 -->
          <div id="current-outfit-display">
            <div
              class="outfit-slot"
              data-type="上装"
              data-placeholder="上衣"
            ></div>
            <div
              class="outfit-slot"
              data-type="下装"
              data-placeholder="下装"
            ></div>
            <div
              class="outfit-slot"
              data-type="配饰"
              data-placeholder="配饰"
            ></div>
            <div
              class="outfit-slot"
              data-type="特殊"
              data-placeholder="特殊"
            ></div>
          </div>

          <button id="wardrobe-try-on-btn" class="form-button" disabled>
            让Ta穿上
          </button>
        </div>

        <!-- 右侧/底部：衣服库存列表 -->
        <div id="wardrobe-inventory-area">
          <div class="wardrobe-tabs">
            <div class="wardrobe-tab active" data-cat="上装">上装</div>
            <div class="wardrobe-tab" data-cat="下装">下装</div>
            <div class="wardrobe-tab" data-cat="配饰">配饰</div>
            <div class="wardrobe-tab" data-cat="特殊">特殊</div>
          </div>
          <div id="wardrobe-grid" class="wardrobe-grid">
            <!-- 衣服卡片由JS生成 -->
          </div>
        </div>
      </div>
    </div>

    <!-- 拆分机app - 角色选择界面 -->
    <div id="task-splitter-char-selection-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>选择角色</span>
        <span style="width: 30px"></span>
      </div>
      <div id="task-splitter-char-list" class="list-container">
        <!-- 角色列表将由JS动态生成 -->
      </div>
    </div>

    <!-- 拆分机app - 主界面 -->
    <div id="task-splitter-main-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="task-splitter-back-btn">‹</span>
        <span id="task-splitter-title">白狗拆分机</span>
        <span style="width: 30px"></span>
      </div>
      
      <!-- 上半部分：自定义图片区域（立绘区域，更大范围） -->
      <div id="task-splitter-image-area" style="
        height: 60vh;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        position: relative;
        background-color: #f0f0f0;
      ">
        <!-- 设置按钮在右上角 -->
        <div id="task-splitter-image-settings-btn" style="
          position: absolute;
          top: 10px;
          right: 10px;
          width: 36px;
          height: 36px;
          border-radius: 50%;
          background: rgba(255, 255, 255, 0.8);
          backdrop-filter: blur(10px);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
          z-index: 10;
        ">⚙️</div>
        
        <!-- 查看历史按钮（在设置按钮下面） -->
        <div id="task-splitter-history-btn" style="
          position: absolute;
          top: 56px;
          right: 10px;
          width: 36px;
          height: 36px;
          border-radius: 50%;
          background: rgba(255, 255, 255, 0.8);
          backdrop-filter: blur(10px);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
          z-index: 10;
          font-size: 18px;
        ">📋</div>
        
        <!-- 对话气泡（galgame样式） -->
        <div id="task-splitter-dialog-bubble" style="
          position: absolute;
          bottom: 20px;
          left: 20px;
          right: 20px;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 15px;
          padding: 20px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
          display: none;
          z-index: 5;
          max-height: 200px;
          overflow-y: auto;
        ">
          <div id="task-splitter-dialog-content" style="
            font-size: 16px;
            line-height: 1.6;
            color: #333;
          "></div>
        </div>
      </div>

      <!-- 下半部分：任务显示区域 -->
      <div id="task-splitter-content-area" style="
        height: 40vh;
        overflow-y: auto;
        padding: 20px;
        background: #fff;
      ">
        <!-- 初始界面：角色头像和输入 -->
        <div id="task-splitter-initial-view" style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: flex-start;
          min-height: 100%;
          text-align: center;
          padding: 20px 0;
        ">
          <div id="task-splitter-char-avatar-container" style="
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 20px;
            cursor: pointer;
            border: 3px solid #4CAF50;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            aspect-ratio: 1 / 1;
            flex-shrink: 0;
          ">
            <img id="task-splitter-char-avatar" src="" alt="角色头像" style="
              width: 100%;
              height: 100%;
              object-fit: cover;
              display: block;
            ">
          </div>
          <p id="task-splitter-greeting" style="
            font-size: 18px;
            color: #333;
            margin-bottom: 30px;
          "></p>
          <input 
            type="text" 
            id="task-splitter-goal-input" 
            placeholder="输入你的目标..."
            style="
              width: 80%;
              max-width: 400px;
              padding: 12px 16px;
              font-size: 16px;
              border: 2px solid #4CAF50;
              border-radius: 25px;
              outline: none;
            "
          >
          <button 
            id="task-splitter-submit-goal-btn" 
            style="
              margin-top: 15px;
              padding: 10px 30px;
              font-size: 16px;
              background: #4CAF50;
              color: white;
              border: none;
              border-radius: 25px;
              cursor: pointer;
            "
          >提交目标</button>
        </div>

        <!-- 询问当前状态 -->
        <div id="task-splitter-current-status-view" style="display: none;">
          <p style="font-size: 18px; color: #333; margin-bottom: 20px; text-align: center;">
            你现在在做什么？
          </p>
          <input 
            type="text" 
            id="task-splitter-current-status-input" 
            placeholder="例如：躺在床上刷手机"
            style="
              width: 80%;
              max-width: 400px;
              padding: 12px 16px;
              font-size: 16px;
              border: 2px solid #4CAF50;
              border-radius: 25px;
              outline: none;
              display: block;
              margin: 0 auto;
            "
          >
          <button 
            id="task-splitter-submit-status-btn" 
            style="
              margin-top: 15px;
              padding: 10px 30px;
              font-size: 16px;
              background: #4CAF50;
              color: white;
              border: none;
              border-radius: 25px;
              cursor: pointer;
              display: block;
              margin: 15px auto;
            "
          >继续</button>
        </div>

        <!-- 加载动画 -->
        <div id="task-splitter-loading-view" style="display: none; text-align: center; padding: 40px;">
          <div style="font-size: 24px; margin-bottom: 20px;">⏳</div>
          <p style="font-size: 16px; color: #666;">任务拆解中...</p>
        </div>

        <!-- 任务列表视图 -->
        <div id="task-splitter-tasks-view" style="display: none;">
          <div id="task-splitter-tasks-container">
            <!-- 任务分组将由JS动态生成 -->
          </div>

          <div id="task-splitter-completion-view" style="display: none; text-align: center; padding: 20px 40px; flex-direction: column; justify-content: center; align-items: center; min-height: 100%;">
            <div id="task-splitter-reward-container" style="
              margin-bottom: 20px;
              width: 100%;
              display: flex;
              flex-direction: column;
              align-items: center;
            ">
              <div id="task-splitter-reward-visualization" style="
                padding: 20px;
                min-height: 200px;
                margin-bottom: 20px;
                width: 100%;
                max-width: 500px;
                display: flex;
                justify-content: center;
                align-items: center;
                margin-left: auto;
                margin-right: auto;
              "></div>
              <div id="task-splitter-reward-message" style="
                font-size: 16px;
                color: #333;
                line-height: 1.6;
                padding: 0;
                width: 100%;
                max-width: 500px;
              "></div>
            </div>
            <div style="display: flex; justify-content: center; align-items: center; margin-top: 30px;">
              <button 
                id="task-splitter-new-goal-btn" 
                style="
                  padding: 12px 30px;
                  font-size: 16px;
                  background: #4CAF50;
                  color: white;
                  border: none;
                  border-radius: 25px;
                  cursor: pointer;
                  display: block;
                  margin: 0 auto;
                "
              >完成</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 右下角"遇到困难"按钮 -->
      <button id="task-splitter-help-btn" style="
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 100;
        display: none;
      ">遇到困难</button>
      
      <!-- 取消任务按钮 -->
      <button id="task-splitter-cancel-task-btn" style="
        position: fixed;
        bottom: 150px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        border: none;
        font-size: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 100;
        display: none;
      ">取消任务</button>
      
      <!-- 切换角色按钮 -->
      <button id="task-splitter-switch-char-btn" style="
        position: fixed;
        bottom: 220px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border: none;
        font-size: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 100;
        display: none;
      ">切换角色</button>
    </div>

    <!-- 拆分机app - 背景图片设置模态框 -->
    <div id="task-splitter-image-settings-modal" class="modal">
      <div class="modal-content" style="width: 90%; max-width: 500px;">
        <div class="modal-header">
          <span>设置背景图片</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>上传本地图片</label>
            <input type="file" id="task-splitter-image-upload" accept="image/*" style="margin-top: 10px;">
          </div>
          <div class="form-group" style="margin-top: 20px;">
            <label>或输入图片URL</label>
            <input 
              type="text" 
              id="task-splitter-image-url-input" 
              placeholder="https://..."
              style="width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;"
            >
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="task-splitter-image-cancel-btn">取消</button>
          <button class="save" id="task-splitter-image-save-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 拆分机app - 历史记录模态框 -->
    <div id="task-splitter-history-modal" class="modal">
      <div class="modal-content" style="width: 90%; max-width: 600px; max-height: 80%;">
        <div class="modal-header">
          <span>奖励柜</span>
          <span id="task-splitter-history-close-btn" style="cursor: pointer; font-size: 24px;">×</span>
        </div>
        <div class="modal-body" id="task-splitter-history-list" style="padding: 15px; overflow-y: auto; max-height: calc(80vh - 100px);">
          <!-- 历史记录会在这里动态生成 -->
        </div>
      </div>
    </div>

    <!-- 约会历史记录界面 -->
    <div id="dating-history-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="dating-history-back-btn">‹</span>
        <span>历史约会</span>
        <span style="width: 30px"></span>
        <!-- 占位符，保持标题居中 -->
      </div>
      <div id="dating-history-list" class="list-container">
        <!-- 历史约会卡片将由JS动态生成在这里 -->
      </div>
    </div>

    <div id="create-dating-scene-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>创建约会场景</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="scene-name-input">场景名称</label>
            <input
              type="text"
              id="scene-name-input"
              placeholder="例如：月光下的海滩漫步"
            />
          </div>
          <div class="form-group">
            <label for="scene-image-url-input">图片 URL (可选)</label>
            <!-- ★★★ 核心修改：更新了 placeholder 提示文字 ★★★ -->
            <input
              type="text"
              id="scene-image-url-input"
              placeholder="留空则由AI根据场景名生成图片..."
            />
          </div>
          <div class="form-group">
            <label for="scene-cost-input">花费 (金币)</label>
            <input
              type="number"
              id="scene-cost-input"
              placeholder="例如：520"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-scene-btn">取消</button>
          <button class="save" id="save-custom-scene-btn">保存</button>
        </div>
      </div>
    </div>

    <div id="sticker-category-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 70%">
        <div class="modal-header">
          <span>移动表情到分类</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>选择一个现有分类</label>
            <div
              id="sticker-category-list"
              style="
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 5px;
              "
            >
              <!-- 分类列表将由JS动态生成 -->
            </div>
          </div>
          <p
            style="
              text-align: center;
              color: var(--text-secondary);
              margin: 10px 0;
            "
          >
            或
          </p>
          <div class="form-group">
            <label for="new-sticker-category-input">创建一个新分类</label>
            <input
              type="text"
              id="new-sticker-category-input"
              placeholder="输入新分类的名称..."
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-sticker-category-btn">取消</button>
          <button class="save" id="confirm-sticker-category-btn">
            确认移动
          </button>
        </div>
      </div>
    </div>

    <div id="advanced-transfer-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>高级导入 / 导出</span>
        </div>
        <div class="modal-body">
          <h4>选择要导出的内容</h4>

          <!-- App 数据导出区 -->
          <div class="form-group">
            <label>全局App数据 (多选)</label>
            <div
              id="export-apps-list"
              style="
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid var(--border-color);
                padding: 10px;
                border-radius: 8px;
              "
            >
              <!-- App 多选框将由JS动态生成在这里 -->
            </div>
          </div>

          <!-- 角色数据导出区 -->
          <div class="form-group">
            <label
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>角色数据 (多选,qq动态什么的)</span>
              <label
                style="font-size: 13px; font-weight: normal; cursor: pointer"
              >
                <input
                  type="checkbox"
                  id="select-all-characters-checkbox"
                  style="vertical-align: middle; margin-right: 4px"
                />
                全选/全不选
              </label>
            </label>
            <div
              id="export-characters-list"
              style="
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid var(--border-color);
                padding: 10px;
                border-radius: 8px;
              "
            >
              <!-- 角色多选框将由JS动态生成在这里 -->
            </div>
          </div>
          <button id="export-selected-data-btn" class="form-button">
            导出选中项
          </button>

          <hr style="margin: 20px 0" />

          <h4>兼容性操作</h4>
          <p style="font-size: 13px; color: #666">
            从其他版本导入数据，或将数据导出为兼容格式。
          </p>

          <button
            id="import-from-330-btn"
            class="form-button"
            style="background-color: #28a745; margin-bottom: 10px"
          >
            📥 兼容330格式导入
          </button>

          <button
            id="export-for-330-btn"
            class="form-button"
            style="background-color: #6f42c1"
          >
            🚀 兼容330数据导出
          </button>

          <hr style="margin: 20px 0" />

          <h4>导入补充数据</h4>
          <p style="font-size: 13px; color: #666">
            导入将以【补充和覆盖】的方式进行，不会删除您现有的其他数据。这可以用来合并数据或恢复单个角色的备份。
          </p>
          <button
            id="import-chunked-data-btn"
            class="form-button form-button-secondary"
          >
            选择文件并导入
          </button>
          <input
            id="import-chunked-data-input"
            type="file"
            accept="application/json"
            hidden
          />
        </div>
        <div class="modal-footer">
          <button class="cancel" id="close-advanced-transfer-btn">关闭</button>
        </div>
      </div>
    </div>

    <input
      id="import-from-330-input"
      type="file"
      accept="application/json"
      hidden
    />

    <div id="intimacy-panel" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>亲密关系</span>
          <span
            id="close-intimacy-panel"
            class="close-btn"
            style="cursor: pointer"
            >&times;</span
          >
        </div>
        <div class="modal-body" id="intimacy-panel-body">
          <div id="intimacy-display">
            <p>当前亲密值</p>
            <h2 id="intimacy-score-display">--</h2>
          </div>
          <div id="intimacy-details">
            <div class="detail-item">
              <span>🔥 火花天数</span>
              <span id="intimacy-streak-days">-- 天</span>
            </div>
            <div class="detail-item">
              <span>💬 今日消息</span>
              <span id="intimacy-today-msgs">-- 条</span>
            </div>
            <div class="detail-item">
              <span>📈 累计消息</span>
              <span id="intimacy-total-msgs">-- 条</span>
            </div>
          </div>
          <div id="intimacy-symbol-unlocks">
            <h3>亲密徽章</h3>
            <div id="symbol-list-container">
              <!-- JS会在这里生成所有可解锁的徽章 -->
            </div>
          </div>
          <div id="intimacy-records">
            <h3>解锁记录</h3>
            <div id="unlocked-symbols-record">
              <!-- JS会在这里生成已解锁徽章的记录 -->
              <p>暂无记录</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="studio-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‹</span>
        <span>小剧场</span>
        <div class="header-actions">
          <span
            class="action-btn"
            id="import-studio-script-btn"
            style="font-size: 14px; margin-right: 5px"
            >导入</span
          >

          <span class="action-btn" id="add-studio-script-btn">新增剧本</span>
          <span class="action-btn" id="studio-history-btn">故事记录</span>
        </div>
      </div>
      <div id="studio-script-list" class="list-container">
        <!-- 剧本列表将由JS动态生成在这里 -->
      </div>

      <input
        type="file"
        id="studio-import-input"
        accept=".json"
        style="display: none"
      />
    </div>

    <!-- 2. 小剧场剧本编辑器 -->
    <div id="studio-editor-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-studio-editor">‹</span>
        <span id="studio-editor-title">编辑剧本</span>
        <div class="header-actions">
          <span class="action-btn" id="ai-generate-script-btn">AI补充</span>
          <span class="save-btn" id="save-studio-script-btn">保存</span>
        </div>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label for="studio-name-input">剧本名称</label>
          <input
            type="text"
            id="studio-name-input"
            placeholder="给你的剧本起个名字..."
          />
        </div>
        <div class="form-group">
          <label for="studio-background-input">故事背景</label>
          <textarea
            id="studio-background-input"
            rows="4"
            placeholder="描述故事发生的时代、地点和基本情境..."
          ></textarea>
        </div>
        <div class="form-group">
          <label for="studio-goal-input">故事目标</label>
          <textarea
            id="studio-goal-input"
            rows="3"
            placeholder="描述达成什么条件算演绎成功，例如：找到真凶、成功逃脱..."
          ></textarea>
        </div>
        <div class="form-group">
          <label for="studio-opening-remark-input">开场白 (可选)</label>
          <textarea
            id="studio-opening-remark-input"
            rows="3"
            placeholder="这是剧本开始时展示的第一段文字，用于营造氛围或引入场景..."
          ></textarea>
        </div>
        <div class="form-group">
          <label for="studio-char1-identity-input">人物1 身份背景</label>
          <textarea
            id="studio-char1-identity-input"
            rows="4"
            placeholder="描述人物1的身份、与他人的关系、秘密任务等..."
          ></textarea>
        </div>
        <div class="form-group">
          <label for="studio-char2-identity-input">人物2 身份背景</label>
          <textarea
            id="studio-char2-identity-input"
            rows="4"
            placeholder="描述人物2的身份、与他人的关系、秘密任务等..."
          ></textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px">
          <button
            id="export-studio-script-btn"
            class="form-button form-button-secondary"
            style="flex: 1; margin: 0"
          >
            导出剧本
          </button>

          <button
            id="delete-studio-script-btn"
            class="form-button form-button-secondary"
            style="
              background-color: #ff3b30;
              color: white;
              border-color: #ff3b30;
              flex: 1;
              margin: 0;
            "
          >
            删除剧本
          </button>
        </div>
      </div>
    </div>

    <!-- 3. 小剧场角色扮演界面 -->
    <div id="studio-play-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-studio-play-btn">‹</span>
        <span id="studio-play-title">剧本名称</span>
        <div class="header-actions">
          <span class="action-btn" id="reroll-studio-play-btn">刷新</span>
        </div>
      </div>
      <div id="studio-play-messages" class="chat-messages">
        <!-- 演绎过程将由JS动态生成在这里 -->
      </div>
      <div id="studio-play-input-area" class="chat-input-area">
        <div class="chat-input-main-row">
          <textarea
            id="studio-play-input"
            rows="1"
            placeholder="你的行动/对话..."
          ></textarea>
          <button id="send-studio-play-action-btn" class="action-button">
            发送
          </button>
        </div>
      </div>
    </div>

    <!-- 4. 角色选择模态框 -->
    <div id="studio-role-selection-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>选择角色与身份</span>
        </div>
        <div class="modal-body">
          <!-- 角色1 -->
          <div class="form-group">
            <label>人物1</label>
            <p id="studio-role1-desc" class="role-description"></p>
            <!-- 新增：由谁扮演 -->
            <div class="player-selection-group">
              <label
                ><input type="radio" name="player-role1" value="user" checked />
                由我扮演</label
              >
              <label
                ><input type="radio" name="player-role1" value="ai" />
                由AI扮演</label
              >
            </div>
            <!-- 修改：下拉框现在只选择身份 -->
            <label
              style="
                font-size: 13px;
                color: var(--text-secondary);
                margin-top: 10px;
              "
              >使用此身份:</label
            >
            <select id="studio-role1-identity-select"></select>
          </div>

          <hr style="opacity: 0.2; margin: 15px 0" />

          <!-- 角色2 -->
          <div class="form-group">
            <label>人物2</label>
            <p id="studio-role2-desc" class="role-description"></p>
            <!-- 新增：由谁扮演 -->
            <div class="player-selection-group">
              <label
                ><input type="radio" name="player-role2" value="user" />
                由我扮演</label
              >
              <label
                ><input type="radio" name="player-role2" value="ai" />
                由AI扮演</label
              >
            </div>
            <!-- 修改：下拉框现在只选择身份 -->
            <label
              style="
                font-size: 13px;
                color: var(--text-secondary);
                margin-top: 10px;
              "
              >使用此身份:</label
            >
            <select id="studio-role2-identity-select"></select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-role-selection-btn">取消</button>
          <button class="save" id="confirm-role-selection-btn">进入剧本</button>
        </div>
      </div>
    </div>

    <!-- 5. 演绎成功/结束模态框 -->
    <div id="studio-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span id="studio-summary-title">演绎成功！</span>
        </div>
        <div
          class="modal-body"
          id="studio-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- 故事目标和总结将显示在这里 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="generate-novel-btn">生成小说</button>
          <button class="save" id="close-studio-summary-btn">关闭</button>
        </div>
      </div>
    </div>

    <!-- 6. 小说分享模态框 -->
    <div id="studio-novel-share-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span>生成的小说</span>
        </div>
        <div
          class="modal-body"
          id="studio-novel-content"
          style="
            white-space: pre-wrap;
            line-height: 1.7;
            text-align: left;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
          "
        >
          <!-- 小说内容将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="share-novel-btn">分享给角色</button>
          <button class="save" id="close-novel-share-btn">关闭</button>
        </div>
      </div>
    </div>

    <!-- 小剧场 - 故事记录屏幕 -->
    <div id="studio-history-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-studio-history">‹</span>
        <span>故事记录</span>
        <span style="width: 30px"></span>
        <!-- 占位符 -->
      </div>
      <div id="studio-history-list" class="list-container">
        <!-- 故事记录列表将由JS动态生成在这里 -->
      </div>
    </div>

    <div id="account-editor-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 85%">
        <div class="modal-header">
          <span id="account-editor-title">添加新账户</span>
        </div>
        <div class="modal-body">
          <!-- 核心修改1：这是全新的账户类型选择视图，默认隐藏 -->
          <div id="account-type-selection-view">
            <!-- JS会在这里动态生成所有账户类型 -->
          </div>

          <!-- 核心修改2：将原有的表单包裹起来，默认隐藏 -->
          <div id="account-editor-form" style="display: none">
            <div class="form-group">
              <label for="account-category-select">账户大类</label>
              <select id="account-category-select"></select>
            </div>
            <div class="form-group">
              <label for="account-type-select">账户类型</label>
              <select id="account-type-select"></select>
            </div>
            <div class="form-group">
              <label for="account-name-input">账户名称</label>
              <input
                type="text"
                id="account-name-input"
                placeholder="例如：工资卡, 零钱"
              />
            </div>
            <div class="form-group">
              <label for="account-balance-input">账户余额</label>
              <input
                type="number"
                id="account-balance-input"
                placeholder="0.00"
              />
            </div>
            <div class="form-group">
              <label for="account-remarks-input">备注 (可选)</label>
              <textarea id="account-remarks-input" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-account-editor-btn">取消</button>
          <!-- 保存按钮初始时隐藏，选择类型后显示 -->
          <button class="save" id="save-account-btn" style="display: none">
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- 1. 创建/管理记账群聊的弹窗 (添加解散按钮) -->
    <div id="tukey-group-manager-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span id="tukey-group-manager-title">创建记账群聊</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="tukey-group-name-input">群聊名称</label>
            <input
              type="text"
              id="tukey-group-name-input"
              placeholder="给你的群聊起个名吧"
            />
          </div>
          <div class="form-group">
            <label>选择群成员 (勾选=拉人，取消勾选=踢人)</label>
            <div id="tukey-member-picker-list" class="contact-picker-list">
              <!-- 角色列表将由JS动态生成 -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <!-- 解散按钮 (默认隐藏) -->
          <button
            class="form-button-secondary"
            id="tukey-disband-group-btn"
            style="
              background-color: #ffe5e5;
              color: #ff3b30;
              border-color: #ffc2d1;
              display: none;
              margin-right: auto;
            "
          >
            解散群聊
          </button>

          <button class="cancel" id="tukey-cancel-group-manager-btn">
            取消
          </button>
          <button class="save" id="tukey-save-group-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 2. 群聊AI回复设置的弹窗 -->
    <div id="tukey-reply-settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>AI回复设置</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="tukey-reply-threshold-input"
              >每记账 ____ 条后，AI进行回复：</label
            >
            <input
              type="number"
              id="tukey-reply-threshold-input"
              min="1"
              value="1"
            />
          </div>
          <hr style="opacity: 0.2" />
          <div class="form-group">
            <label>选择回复模式：</label>
            <div
              class="theme-selector"
              style="flex-direction: column; align-items: flex-start; gap: 10px"
            >
              <label
                ><input
                  type="radio"
                  name="tukey-reply-mode"
                  value="all"
                  checked
                />
                所有成员都回复</label
              >
              <label
                ><input type="radio" name="tukey-reply-mode" value="random" />
                随机选择成员回复</label
              >
              <label
                ><input type="radio" name="tukey-reply-mode" value="specific" />
                指定成员回复</label
              >
            </div>
          </div>
          <div id="tukey-specific-reply-options" style="display: none">
            <div class="form-group">
              <label for="tukey-random-count-input"
                >随机回复人数 (当选择“随机”时):</label
              >
              <input
                type="number"
                id="tukey-random-count-input"
                min="1"
                value="2"
              />
            </div>
            <div class="form-group">
              <label>指定回复的成员 (当选择“指定”时):</label>
              <div
                id="tukey-specific-member-picker-list"
                class="contact-picker-list"
                style="max-height: 150px"
              >
                <!-- 成员列表将由JS动态生成 -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="tukey-cancel-reply-settings-btn">
            取消
          </button>
          <button class="save" id="tukey-save-reply-settings-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 3. 新建/编辑记账记录的弹窗 -->
    <div id="tukey-record-editor-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 90%">
        <div class="modal-header">
          <span id="tukey-record-editor-title">记一笔</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>类型</label>
            <div class="tukey-type-selector">
              <button class="type-btn active" data-type="expense">支出</button>
              <button class="type-btn" data-type="income">收入</button>
            </div>
          </div>
          <div class="form-group">
            <label for="tukey-record-amount-input">金额</label>
            <input
              type="number"
              id="tukey-record-amount-input"
              placeholder="0.00"
            />
          </div>
          <div class="form-group">
            <label for="tukey-record-category-select">分类</label>
            <select id="tukey-record-category-select">
              <!-- 分类将由JS动态生成 -->
            </select>
          </div>
          <div class="form-group">
            <label for="tukey-record-account-select">账户</label>
            <select id="tukey-record-account-select">
              <!-- 账户将由JS动态生成 -->
            </select>
          </div>
          <div class="form-group">
            <label for="tukey-record-time-input">时间</label>
            <input type="datetime-local" id="tukey-record-time-input" />
          </div>
          <div class="form-group">
            <label for="tukey-record-remarks-input">备注 (可选)</label>
            <textarea id="tukey-record-remarks-input" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="tukey-cancel-record-editor-btn">
            取消
          </button>
          <button class="save" id="tukey-save-record-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- 4. 查岗 - 电脑屏幕 (模态框) -->
    <div id="kk-computer-modal" class="modal">
      <div
        class="modal-content"
        style="
          width: 95%;
          height: 90%;
          max-width: 500px;
          background-color: #e0e0e0;
          background-image: url('https://i.postimg.cc/k495F4W5/profile-banner.jpg');
          background-size: cover;
          background-position: center;
        "
      >
        <div
          class="modal-header"
          id="kk-computer-header"
          style="
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            text-shadow: 0 1px 2px black;
          "
        >
          <span>的电脑</span>
          <span id="close-kk-computer-modal" style="cursor: pointer">×</span>
        </div>
        <div class="modal-body" id="kk-computer-desktop">
          <!-- 电脑桌面图标将由JS动态生成 -->
        </div>
      </div>
    </div>

    <!-- 6. 查岗 - 文件浏览器模态框 -->
    <div id="kk-file-explorer-modal" class="modal" style="z-index: 1003">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>私人文件</span>
        </div>
        <div class="modal-body" id="kk-file-list">
          <!-- 文件列表将由JS动态生成 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="close-file-explorer-modal-btn">
            关闭
          </button>
        </div>
      </div>
    </div>
    <!-- “kk查岗”文件查看器弹窗-->
    <div id="kk-file-viewer-modal" class="modal" style="z-index: 1004">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="kk-file-viewer-title"></span>
          <span
            id="close-kk-file-viewer-btn"
            style="cursor: pointer; font-size: 24px"
            >&times;</span
          >
        </div>
        <div
          class="modal-body"
          style="padding: 15px; background-color: #f0f2f5; overflow-y: auto"
        >
          <!-- 使用 <pre> 标签可以更好地保留原文的换行和格式 -->
          <pre
            id="kk-file-viewer-content"
            style="
              white-space: pre-wrap;
              word-wrap: break-word;
              font-family: inherit;
              font-size: 14px;
            "
          ></pre>
        </div>
      </div>
    </div>
    <!-- Steam游戏库弹窗 ▼▼▼ -->
    <div id="kk-steam-modal" class="modal" style="z-index: 1003">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>Steam 游戏库</span>
          <div class="header-actions">
            <span
              class="action-btn"
              id="kk-generate-more-games-btn"
              title="生成更多游戏"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </span>
          </div>
        </div>
        <div class="modal-body" id="kk-steam-games-list">
          <!-- 游戏列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="close-kk-steam-modal-btn">关闭</button>
        </div>
      </div>
    </div>

    <!-- 快捷回复管理模态框 -->
    <div id="quick-reply-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>快捷回复</span>
          <div class="header-actions">
            <!-- 顶部操作按钮 -->
            <span
              class="action-btn"
              id="import-quick-reply-btn"
              title="导入"
              style="font-size: 14px"
              >导入</span
            >
            <span
              class="action-btn"
              id="export-quick-reply-btn"
              title="导出"
              style="font-size: 14px"
              >导出</span
            >
            <span
              class="action-btn"
              id="add-quick-reply-btn"
              style="font-size: 24px"
              >+</span
            >
          </div>
        </div>
        <div
          class="modal-body"
          id="quick-reply-list"
          style="padding: 0; overflow-y: auto"
        >
          <!-- 列表将由JS动态生成 -->
        </div>
        <div class="modal-footer">
          <button class="save" id="close-quick-reply-btn" style="width: 100%">
            关闭
          </button>
        </div>
      </div>
    </div>
    <!-- 隐藏的文件选择器 -->
    <input type="file" id="import-quick-reply-input" accept=".json" hidden />

    <!-- 时间轴/存档管理模态框 -->
    <div id="branching-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>时间轴管理</span>
          <div class="header-actions">
            <button
              id="create-branch-btn"
              class="action-button"
              style="font-size: 14px"
            >
              + 新存档
            </button>
          </div>
        </div>
        <div
          class="modal-body"
          style="padding: 0; display: flex; flex-direction: column"
        >
          <!-- 顶部操作区 -->
          <div
            style="
              padding: 15px;
              border-bottom: 1px solid var(--border-color);
              text-align: center;
            "
          >
            <button
              id="restart-chat-btn"
              class="form-button"
              style="background-color: #ff9800; color: white; margin-bottom: 0"
            >
              🔄 重开新剧情 (清空当前)
            </button>
            <p
              style="
                font-size: 12px;
                color: #999;
                margin-top: 8px;
                margin-bottom: 0;
              "
            >
              重开前建议先点击右上角保存当前进度
            </p>
          </div>

          <!-- 存档列表 -->
          <div
            id="branch-list"
            class="list-container"
            style="flex-grow: 1; background-color: var(--secondary-bg)"
          >
            <!-- 存档项将由JS生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-branching-modal-btn"
            style="width: 100%"
          >
            关闭
          </button>
        </div>
      </div>
    </div>
    <!-- KK查岗物品详情专用弹窗 -->
    <div id="kk-item-share-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span id="kk-item-share-title">物品详情</span>
        </div>
        <!-- 内容显示区 -->
        <div class="modal-body" style="padding: 15px">
          <div
            id="kk-item-share-content"
            style="
              text-align: left;
              white-space: pre-wrap;
              background: #f9f9f9;
              padding: 15px;
              border-radius: 8px;
              font-size: 14px;
              line-height: 1.6;
              border: 1px solid #eee;
              color: #333;
            "
          ></div>
        </div>
        <!-- 按钮区 -->
        <div class="modal-footer" style="display: flex; gap: 10px">
          <button
            class="form-button-secondary"
            id="kk-item-share-close-btn"
            style="flex: 1; margin: 0"
          >
            关闭
          </button>
          <button
            class="form-button"
            id="kk-item-share-confirm-btn"
            style="
              flex: 1;
              margin: 0;
              background-color: #ff9800;
              border-color: #ff9800;
            "
          >
            📤 分享给Ta
          </button>
        </div>
      </div>
    </div>

    <div id="inner-voice-modal" class="modal">
      <!-- 心声主面板 -->
      <div
        id="inner-voice-main-panel"
        class="modal-content"
        style="
          width: 90%;
          max-width: 340px;
          height: auto;
          max-height: 80%;
          background-color: #fffafb;
          border: 1px solid #ffe4e1;
        "
      >
        <div
          class="modal-header"
          style="
            border-bottom: 1px solid #ffe4e1;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <span
            id="close-inner-voice-modal"
            style="cursor: pointer; font-size: 24px"
            >×</span
          >

          <div style="display: flex; align-items: center; gap: 15px">
            <span
              id="inner-voice-edit-btn"
              style="cursor: pointer"
              title="编辑心声面板"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M12 20h9"></path>
                <path
                  d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                ></path>
              </svg>
            </span>
            <span
              id="change-inner-voice-bg-btn"
              style="cursor: pointer"
              title="更换背景"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
            </span>
            <span id="inner-voice-history-btn" style="cursor: pointer">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            </span>
            <span
              id="inner-voice-reroll-btn"
              style="cursor: pointer"
              title="重Roll当前心声"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                <path d="M3 21v-5h5"></path>
              </svg>
            </span>
          </div>
        </div>

        <div class="modal-body" style="padding: 15px">
          <!-- 头像和名字信息现在是独立的、可定位的元素 -->
          <!-- 角色头像 -->
          <div id="inner-voice-avatar-wrapper">
            <img id="inner-voice-avatar" src="" />
            <!-- 为头像框预留的位置 -->
            <img id="inner-voice-avatar-frame" src="" style="display: none" />
          </div>

          <!-- 角色名字 -->
          <div id="inner-voice-char-info">
            <div id="inner-voice-char-name"></div>
          </div>

          <!-- 领养人信息（头像+名字）-->
          <div id="inner-voice-adopter-info">
            <img id="inner-voice-adopter-avatar" src="" />
            <span id="inner-voice-adopter-name"></span>
          </div>

          <!-- 心声内容 -->
          <div
            id="inner-voice-content-area"
            style="display: flex; flex-direction: column; gap: 15px"
          >
            <div>
              <strong style="color: #e57373">服装:</strong>
              <p
                id="inner-voice-clothing"
                style="margin: 5px 0 0 0; line-height: 1.6; color: #555"
              ></p>
            </div>
            <div>
              <strong style="color: #81c784">行为:</strong>
              <p
                id="inner-voice-behavior"
                style="margin: 5px 0 0 0; line-height: 1.6; color: #555"
              ></p>
            </div>
            <div>
              <strong style="color: #64b5f6">心声:</strong>
              <p
                id="inner-voice-thoughts"
                style="margin: 5px 0 0 0; line-height: 1.6; color: #555"
              ></p>
            </div>
            <div>
              <strong style="color: #ba68c8">坏心思:</strong>
              <p
                id="inner-voice-naughty-thoughts"
                style="margin: 5px 0 0 0; line-height: 1.6; color: #555"
              ></p>
            </div>
          </div>
        </div>
      </div>

      <!-- 历史记录面板 (保持不变) -->
      <div
        id="inner-voice-history-panel"
        class="modal-content"
        style="
          width: 90%;
          max-width: 340px;
          height: 80%;
          background-color: #f5f5f5;
          display: none;
          flex-direction: column;
        "
      >
        <div
          class="modal-header"
          style="border-bottom: 1px solid #ddd; justify-content: space-between"
        >
          <span
            id="back-from-history-btn"
            style="
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
              color: var(--accent-color);
            "
            >返回</span
          >
          <span>历史心声</span>
          <span
            id="clear-all-history-btn"
            style="cursor: pointer; font-size: 14px; color: #ff3b30"
            >全部清空</span
          >
        </div>
        <div
          class="modal-body"
          id="inner-voice-history-list"
          style="padding: 0"
        >
          <!-- 历史记录会由JS动态生成在这里 -->
        </div>
      </div>
    </div>

    <input
      type="file"
      id="character-card-input"
      accept=".png, .json"
      style="display: none"
    />

    <input
      type="file"
      id="world-book-import-input"
      accept=".json, .jsonl"
      style="display: none"
    />
    <input type="file" id="ludo-qbank-import-input" accept=".json" hidden />
    <input type="file" id="inner-voice-bg-input" accept="image/*" hidden />
    <input type="file" id="script-kill-import-input" accept=".json" hidden />
  </body>
</html>
